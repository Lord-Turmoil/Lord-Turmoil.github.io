<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lab 6 Reflection | TONY'S STUDIO</title><meta name="author" content="Tony Skywalker"><meta name="copyright" content="Tony Skywalker"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Reflection on 2023 BUAA OS Lab 6 - Pipe &amp; Shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Lab 6 Reflection">
<meta property="og:url" content="https://blog.tonys-studio.top/posts/Lab-6-Reflection/">
<meta property="og:site_name" content="TONY&#39;S STUDIO">
<meta property="og:description" content="Reflection on 2023 BUAA OS Lab 6 - Pipe &amp; Shell">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/08/08.jpeg">
<meta property="article:published_time" content="2023-06-18T15:28:19.000Z">
<meta property="article:modified_time" content="2025-05-04T02:53:16.315Z">
<meta property="article:author" content="Tony Skywalker">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="BUAA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/08/08.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lab 6 Reflection",
  "url": "https://blog.tonys-studio.top/posts/Lab-6-Reflection/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/08/08.jpeg",
  "datePublished": "2023-06-18T15:28:19.000Z",
  "dateModified": "2025-05-04T02:53:16.315Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Skywalker",
      "url": "https://tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Lab-6-Reflection/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="codeva-R6O16YoeQt"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#300303')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "h2swkizghx");</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":10,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":256,"languages":{"author":"Author: Tony Skywalker","link":"Link: ","source":"Source: TONY'S STUDIO","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#871798","bgDark":"#C81025","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lab 6 Reflection',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.6/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/css/barber-shop.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/back_img.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">80</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/08/08.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Lab 6 Reflection</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lab 6 Reflection</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-06-18T15:28:19.000Z" title="Created Jun. 18th, 2023 - 23:28:19 23:28:19">Jun. 18th, 2023 - 23:28:19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-05-04T02:53:16.315Z" title="Updated May. 4th, 2025 - 10:53:16 10:53:16">May. 4th, 2025 - 10:53:16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/">BUAA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/OS/">OS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>13mins</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Lab-6-Reflection/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Lab-6-Reflection/#post-comment"><span class="waline-comment-count" data-path="/posts/Lab-6-Reflection/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="BUAA-2023-Spring-OS"><a href="#BUAA-2023-Spring-OS" class="headerlink" title="BUAA 2023 Spring OS"></a>BUAA 2023 Spring OS</h1><hr>
<h1 id="Prologue"><a href="#Prologue" class="headerlink" title="Prologue"></a>Prologue</h1><p>Well, we finally came to the last lab. To be honest, this one is quite easy.</p>
<hr>
<h1 id="1-Pipe"><a href="#1-Pipe" class="headerlink" title="1. Pipe"></a>1. Pipe</h1><p>The first thing to deal with is pipe. You know, in Linux, we can use <code>|</code> operator to redirect one process’s output to another process’s input, which is quite important for shell. So… Here, let’s do it.</p>
<h2 id="1-1-Pipe-Structure"><a href="#1-1-Pipe-Structure" class="headerlink" title="1.1 Pipe Structure"></a>1.1 Pipe Structure</h2><p>Well, pipe is not a actual file, it is, a circular queue. Write end keeps writing things to the back, while read end keeps reading things from the front. Both will yield when the pipe is empty or full. So here is how it looks like.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pipe</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    u_int p_rpos;	       <span class="comment">// read position</span></span><br><span class="line">    u_int p_wpos;	       <span class="comment">// write position</span></span><br><span class="line">    u_char p_buf[BY2PIPE]; <span class="comment">// data buffer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> _pipe_is_empty(<span class="keyword">struct</span> Pipe* p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;p_rpos &gt;= p-&gt;p_wpos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> _pipe_is_full(<span class="keyword">struct</span> Pipe* p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;p_wpos - p-&gt;p_rpos &gt;= BY2PIPE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-Create-Pipe"><a href="#1-2-Create-Pipe" class="headerlink" title="1.2 Create Pipe"></a>1.2 Create Pipe</h2><p>So, how to create a pipe? First, let’s make it clear that, the pipe we create here, is <strong>anonymous</strong>. When I say anonymous, I mean, anonymous. :P</p>
<p>The difference of pipe and regular file is that, the data part of pipe is not raw data, it is what I just mentioned above, the so called <code>struct Pipe</code>. So this is it, a small buffer, which only takes up one page. (Actually not one page, but we don’t divide a page into several parts.)</p>
<p>Then, considering the nature of sharing, the data part of pipe file is shared by two file descriptors. So we just map the same page of physical memory to both read end and write end. A little confusing, huh? Here are some figure to further demonstrate this.</p>
<p>First, we use <code>pipe</code> to create a pipe in parent process. We can see that two file descriptors are mapped to two different pages, but both of theirs data are mapped to the same, pipe page.</p>
<blockquote>
<p>Green is for read and red is for write. If you feel not familiar with this layout, check my previous post.</p>
<ul>
<li><a href="/posts/Lab-5-Reflection/#2-4-2-File-Descriptor">Lab 5 Reflection: 2.4.2 File Descriptor</a></li>
</ul>
</blockquote>
<img src="/posts/Lab-6-Reflection/create_01.svg" alt="create_01" style="zoom:80%;">

<p>Well, pipe always comes with fork. So let’s see how it changes after fork. So… like a mirror, so symmetrical, isn’t it? Now we can see that all physical pages’ references doubled.</p>
<blockquote>
<p><strong>Notice:</strong> Here, the file descriptor and file data memory are marked <code>PTE_LIBRARY</code>, so they won’t be affected by COW mechanism.</p>
</blockquote>
<img src="/posts/Lab-6-Reflection/create_02.svg" alt="create_02" style="zoom:80%;">

<p>Then, assume that parent process writes and child process reads. And below is the final (almost final) form of pipe. The grey hatch means the file descriptor was closed.</p>
<blockquote>
<p><strong>Important!</strong> So are we getting it? Are we getting it? The sum of <code>pageref</code> of read end file descriptor and write end one, is exactly the <code>pageref</code> of the pipe page!</p>
</blockquote>
<img src="/posts/Lab-6-Reflection/create_03.svg" alt="create_03" style="zoom:80%;">

<p>If you care about source code, then here it is.</p>
<details class="toggle"><summary class="toggle-button" style>pipe</summary><div class="toggle-content"><blockquote>
<p>Here, it uses many <code>goto</code> for error handling. Well, not bad.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> pfd[<span class="number">2</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="type">void</span>* va;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Fd</span>* <span class="title">fd0</span>, * <span class="title">fd1</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 1: Allocate the file descriptors. */</span></span><br><span class="line">    <span class="keyword">if</span> ((r = fd_alloc(&amp;fd0)) &lt; <span class="number">0</span> || (r = syscall_mem_alloc(<span class="number">0</span>, fd0, PTE_D | PTE_LIBRARY)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((r = fd_alloc(&amp;fd1)) &lt; <span class="number">0</span> || (r = syscall_mem_alloc(<span class="number">0</span>, fd1, PTE_D | PTE_LIBRARY)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> err1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 2: Allocate and map the page for the &#x27;Pipe&#x27; structure. */</span></span><br><span class="line">    va = fd2data(fd0);</span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_mem_alloc(<span class="number">0</span>, (<span class="type">void</span>*)va, PTE_D | PTE_LIBRARY)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> err2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_mem_map(<span class="number">0</span>, (<span class="type">void</span>*)va, <span class="number">0</span>, (<span class="type">void</span>*)fd2data(fd1), PTE_D | PTE_LIBRARY)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> err3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 3: Set up &#x27;Fd&#x27; structures. */</span></span><br><span class="line">    fd0-&gt;fd_dev_id = devpipe.dev_id;</span><br><span class="line">    fd0-&gt;fd_omode = O_RDONLY;</span><br><span class="line"></span><br><span class="line">    fd1-&gt;fd_dev_id = devpipe.dev_id;</span><br><span class="line">    fd1-&gt;fd_omode = O_WRONLY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> MOS_VERBOSE</span></span><br><span class="line">    debugf(<span class="string">&quot;[%08x] pipecreate \n&quot;</span>, env-&gt;env_id, vpt[VPN(va)]);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 4: Save the result. */</span></span><br><span class="line">    pfd[<span class="number">0</span>] = fd2num(fd0);</span><br><span class="line">    pfd[<span class="number">1</span>] = fd2num(fd1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err3:</span><br><span class="line">    syscall_mem_unmap(<span class="number">0</span>, (<span class="type">void</span>*)va);</span><br><span class="line">err2:</span><br><span class="line">    syscall_mem_unmap(<span class="number">0</span>, fd1);</span><br><span class="line">err1:</span><br><span class="line">    syscall_mem_unmap(<span class="number">0</span>, fd0);</span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<h2 id="1-3-Read-Write-Pipe"><a href="#1-3-Read-Write-Pipe" class="headerlink" title="1.3 Read &amp; Write Pipe"></a>1.3 Read &amp; Write Pipe</h2><p>Before we start reading and writing, there’s one problem remaining - how to determine our writing has a receiver, or we are not waiting for nobody?</p>
<p>So we have to figure out a way to determine whether the other end of pipe is closed or not. Any idea? Correct, the equation we mentioned just now.<br>$$<br>pageref(read \space fd) + pageref(write \space fd) \equiv  pageref(pipe)<br>$$<br>When we are at write end, if $ pageref(write fd) &#x3D; pageref(pipe) $, it means the read end is closed. It looks just like this, and one physical page is freed, too. The same goes with write end.</p>
<img src="/posts/Lab-6-Reflection/create_04.svg" alt="create_04" style="zoom:80%;">

<p>So we can write a test function as below.</p>
<blockquote>
<p>You know, pipe only works between two process, parent and child. So there shouldn’t be a third party. And yet another thing to notice is that, we must make sure this check is an atomic operation, because it is in user space, and schedule will happen anytime.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> _pipe_is_closed(<span class="keyword">struct</span> Fd* fd, <span class="keyword">struct</span> Pipe* p)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> fd_ref, pipe_ref, runs;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		runs = env-&gt;env_runs;</span><br><span class="line">		fd_ref = pageref(fd);</span><br><span class="line">		pipe_ref = pageref(p);</span><br><span class="line">	&#125; <span class="keyword">while</span> (runs != env-&gt;env_runs);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fd_ref == pipe_ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reminder, this <code>env</code> is a global volatile variable in user space.</p>
</blockquote>
<p>With these in mind, it will be relatively easier to understand pipe read and write.</p>
<details class="toggle"><summary class="toggle-button" style>pipe read/write</summary><div class="toggle-content"><blockquote>
<p>Notice that, even if one end is closed, the other end can still access pipe data. So it is OK to use <code>_pipe_is_empty</code> or <code>_pipe_is_full</code>, though the pipe is sure to be empty after the last read.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">pipe_read</span><span class="params">(<span class="keyword">struct</span> Fd* fd, <span class="type">void</span>* vbuf, u_int n, u_int offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pipe</span>* <span class="title">p</span> =</span> (<span class="keyword">struct</span> Pipe*)fd2data(fd);</span><br><span class="line">    <span class="type">int</span> nbytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; ; )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (!_pipe_is_empty(p) &amp;&amp; nbytes &lt; n)</span><br><span class="line">        &#123;</span><br><span class="line">            *(u_char*)(vbuf + nbytes++) = p-&gt;p_buf[p-&gt;p_rpos++ % BY2PIPE];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((nbytes &gt; <span class="number">0</span>) || _pipe_is_closed(fd, p))</span><br><span class="line">            <span class="keyword">return</span> nbytes;</span><br><span class="line">        syscall_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">pipe_write</span><span class="params">(<span class="keyword">struct</span> Fd* fd, <span class="type">const</span> <span class="type">void</span>* vbuf, u_int n, u_int offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Pipe</span>* <span class="title">p</span> =</span> (<span class="keyword">struct</span> Pipe*)fd2data(fd);</span><br><span class="line">    <span class="type">int</span> nbytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; ; )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (!_pipe_is_full(p) &amp;&amp; nbytes &lt; n)</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;p_buf[p-&gt;p_wpos++ % BY2PIPE] = *(u_char*)(vbuf + nbytes++);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nbytes == n || _pipe_is_closed(fd, p))</span><br><span class="line">            <span class="keyword">return</span> nbytes;</span><br><span class="line">        syscall_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<hr>
<h1 id="2-Spawn"><a href="#2-Spawn" class="headerlink" title="2. Spawn"></a>2. Spawn</h1><p>Remember, our ultimate goal is to make a Shell. So it is essential to load executables from disk, and <code>spawn</code> is what makes it possible.</p>
<p>This part is… a little complicated. But basic principle is simple: load each segment of ELF file into memory. What to notice is that we have to initialize the calling stack for target <code>main</code> function, and map those pages with <code>PTE_LIBRARY</code> flags.</p>
<blockquote>
<p>Interestingly, memory segment <code>UTEMP</code> is used here. :)</p>
</blockquote>
<details class="toggle"><summary class="toggle-button" style>spawn</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">spawn</span><span class="params">(<span class="type">char</span>* prog, <span class="type">char</span>** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Step 1: Open the file &#x27;prog&#x27; (the path of the program).</span></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(prog, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Read the ELF header (of type &#x27;Elf32_Ehdr&#x27;) from the file into</span></span><br><span class="line">    <span class="comment">// &#x27;elfbuf&#x27; using &#x27;readn()&#x27;.</span></span><br><span class="line">    <span class="comment">// If that fails (where &#x27;readn&#x27; returns a different size than expected),</span></span><br><span class="line">    <span class="comment">// set &#x27;r&#x27; and &#x27;goto err&#x27; to close the file and return the error.</span></span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    u_char elfbuf[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">if</span> (readn(fd, elfbuf, <span class="keyword">sizeof</span>(Elf32_Ehdr)) != <span class="keyword">sizeof</span>(Elf32_Ehdr))</span><br><span class="line">    &#123;</span><br><span class="line">        r = -E_NOT_EXEC;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> Elf32_Ehdr* ehdr = elf_from(elfbuf, <span class="keyword">sizeof</span>(Elf32_Ehdr));</span><br><span class="line">    <span class="keyword">if</span> (!ehdr)</span><br><span class="line">    &#123;</span><br><span class="line">        r = -E_NOT_EXEC;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    u_long entrypoint = ehdr-&gt;e_entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: Create a child using &#x27;syscall_exofork()&#x27; and store its envid in</span></span><br><span class="line">    <span class="comment">// &#x27;child&#x27;. If the syscall fails, set &#x27;r&#x27; and &#x27;goto err&#x27;.</span></span><br><span class="line">    u_int child;</span><br><span class="line">    r = syscall_exofork();</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    child = r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 4: Use &#x27;init_stack(child, argv, &amp;sp)&#x27; to initialize the stack of the</span></span><br><span class="line">    <span class="comment">// child. &#x27;goto err1&#x27; if that fails.</span></span><br><span class="line">    u_int sp;</span><br><span class="line">    <span class="keyword">if</span> ((r = init_stack(child, argv, &amp;sp)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 5: Load the ELF segments in the file into the child&#x27;s memory.</span></span><br><span class="line">    <span class="comment">// This is similar to &#x27;load_icode()&#x27; in the kernel.</span></span><br><span class="line">    <span class="type">size_t</span> ph_off;</span><br><span class="line">    ELF_FOREACH_PHDR_OFF(ph_off, ehdr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Read the program header in the file with offset &#x27;ph_off&#x27; and length</span></span><br><span class="line">        <span class="comment">// &#x27;ehdr-&gt;e_phentsize&#x27; into &#x27;elfbuf&#x27;.</span></span><br><span class="line">        <span class="comment">// &#x27;goto err1&#x27; on failure.</span></span><br><span class="line">        seek(fd, ph_off);</span><br><span class="line">        <span class="keyword">if</span> (readn(fd, elfbuf, ehdr-&gt;e_phentsize) != ehdr-&gt;e_phentsize)</span><br><span class="line">        &#123;</span><br><span class="line">            r = -E_NOT_EXEC;</span><br><span class="line">            <span class="keyword">goto</span> err1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Elf32_Phdr* ph = (Elf32_Phdr*)elfbuf;</span><br><span class="line">        <span class="keyword">if</span> (ph-&gt;p_type == PT_LOAD)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">void</span>* bin;</span><br><span class="line">            <span class="comment">// Read and map the ELF data in the file at &#x27;ph-&gt;p_offset&#x27; into our</span></span><br><span class="line">            <span class="comment">// memory using &#x27;read_map()&#x27;. &#x27;goto err1&#x27; if that fails.</span></span><br><span class="line">            <span class="keyword">if</span> ((r = read_map(fd, ph-&gt;p_offset, &amp;bin)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Load the segment &#x27;ph&#x27; into the child&#x27;s memory using &#x27;elf_load_seg()&#x27;.</span></span><br><span class="line">            <span class="comment">// Use &#x27;spawn_mapper&#x27; as the callback, and &#x27;&amp;child&#x27; as its data.</span></span><br><span class="line">            <span class="comment">// &#x27;goto err1&#x27; if that fails.</span></span><br><span class="line">            <span class="keyword">if</span> ((r = elf_load_seg(ph, bin, spawn_mapper, &amp;child)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> err1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> <span class="title">tf</span> =</span> envs[ENVX(child)].env_tf;</span><br><span class="line">    tf.cp0_epc = entrypoint;</span><br><span class="line">    tf.regs[<span class="number">29</span>] = sp;</span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_set_trapframe(child, &amp;tf)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pages with &#x27;PTE_LIBRARY&#x27; set are shared between the parent and the child.</span></span><br><span class="line">    <span class="keyword">for</span> (u_int pdeno = <span class="number">0</span>; pdeno &lt;= PDX(USTACKTOP); pdeno++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(vpd[pdeno] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">for</span> (u_int pteno = <span class="number">0</span>; pteno &lt;= PTX(~<span class="number">0</span>); pteno++)</span><br><span class="line">        &#123;</span><br><span class="line">            u_int pn = (pdeno &lt;&lt; <span class="number">10</span>) + pteno;</span><br><span class="line">            u_int perm = vpt[pn] &amp; ((<span class="number">1</span> &lt;&lt; PGSHIFT) - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ((perm &amp; PTE_V) &amp;&amp; (perm &amp; PTE_LIBRARY))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">void</span>* va = (<span class="type">void</span>*)(pn &lt;&lt; PGSHIFT);</span><br><span class="line">                <span class="keyword">if</span> ((r = syscall_mem_map(<span class="number">0</span>, va, child, va, perm)) &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    debugf(<span class="string">&quot;spawn: syscall_mem_map %x %x: %d\n&quot;</span>, va, child, r);</span><br><span class="line">                    <span class="keyword">goto</span> err2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_set_env_status(child, ENV_RUNNABLE)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        debugf(<span class="string">&quot;spawn: syscall_set_env_status %x: %d\n&quot;</span>, child, r);</span><br><span class="line">        <span class="keyword">goto</span> err2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> child;</span><br><span class="line"></span><br><span class="line">err2:</span><br><span class="line">    syscall_env_destroy(child);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">err1:</span><br><span class="line">    syscall_env_destroy(child);</span><br><span class="line">err:</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<p>One important procedure is to initialize stack.</p>
<details class="toggle"><summary class="toggle-button" style>init_stack</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">init_stack</span><span class="params">(u_int child, <span class="type">char</span>** argv, u_int* init_sp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> argc, i, r, tot;</span><br><span class="line">    <span class="type">char</span>* strings;</span><br><span class="line">    u_int* args;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count the number of arguments (argc)</span></span><br><span class="line">    <span class="comment">// and the total amount of space needed for strings (tot)</span></span><br><span class="line">    tot = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (argc = <span class="number">0</span>; argv[argc]; argc++)</span><br><span class="line">        tot += <span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure everything will fit in the initial stack page</span></span><br><span class="line">    <span class="keyword">if</span> (ROUND(tot, <span class="number">4</span>) + <span class="number">4</span> * (argc + <span class="number">3</span>) &gt; BY2PG)</span><br><span class="line">        <span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine where to place the strings and the args array</span></span><br><span class="line">    strings = (<span class="type">char</span>*)(UTEMP + BY2PG) - tot;</span><br><span class="line">    args = (u_int*)(UTEMP + BY2PG - ROUND(tot, <span class="number">4</span>) - <span class="number">4</span> * (argc + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_mem_alloc(<span class="number">0</span>, (<span class="type">void</span>*)UTEMP, PTE_D)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy the argument strings into the stack page at &#x27;strings&#x27;</span></span><br><span class="line">    <span class="type">char</span>* ctemp, * argv_temp;</span><br><span class="line">    u_int j;</span><br><span class="line">    ctemp = strings;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        argv_temp = argv[i];</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(argv[i]); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            *ctemp = *argv_temp;</span><br><span class="line">            ctemp++;</span><br><span class="line">            argv_temp++;</span><br><span class="line">        &#125;</span><br><span class="line">        *ctemp = <span class="number">0</span>;</span><br><span class="line">        ctemp++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize args[0 ... argc - 1] to be pointers to these strings</span></span><br><span class="line">    <span class="comment">// that will be valid addresses for the child environment</span></span><br><span class="line">    <span class="comment">// (for whom this page will be at USTACKTOP-BY2PG!).</span></span><br><span class="line">    ctemp = (<span class="type">char</span>*)(USTACKTOP - UTEMP - BY2PG + (u_int)strings);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        args[i] = (u_int)ctemp;</span><br><span class="line">        ctemp += <span class="built_in">strlen</span>(argv[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set args[argc] to 0 to null-terminate the args array.</span></span><br><span class="line">    ctemp--;</span><br><span class="line">    args[argc] = (u_int)ctemp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push two more words onto the child&#x27;s stack below &#x27;args&#x27;,</span></span><br><span class="line">    <span class="comment">// containing the argc and argv parameters to be passed</span></span><br><span class="line">    <span class="comment">// to the child&#x27;s main() function.</span></span><br><span class="line">    u_int* pargv_ptr;</span><br><span class="line">    pargv_ptr = args - <span class="number">1</span>;</span><br><span class="line">    *pargv_ptr = USTACKTOP - UTEMP - BY2PG + (u_int)args;</span><br><span class="line">    pargv_ptr--;</span><br><span class="line">    *pargv_ptr = argc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set *init_sp to the initial stack pointer for the child</span></span><br><span class="line">    *init_sp = USTACKTOP - UTEMP - BY2PG + (u_int)pargv_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_mem_map(<span class="number">0</span>, (<span class="type">void</span>*)UTEMP, child, (<span class="type">void</span>*)(USTACKTOP - BY2PG), PTE_D)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    <span class="keyword">if</span> ((r = syscall_mem_unmap(<span class="number">0</span>, (<span class="type">void</span>*)UTEMP)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    syscall_mem_unmap(<span class="number">0</span>, (<span class="type">void</span>*)UTEMP);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<p>Also, we need a special <code>spawn_mapper</code> here.</p>
<details class="toggle"><summary class="toggle-button" style>spawn_mapper</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spawn_mapper</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">void</span>* data,</span></span><br><span class="line"><span class="params">    u_long va,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> offset,</span></span><br><span class="line"><span class="params">    u_int perm,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">void</span>* src,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_int child_id = *(u_int*)data;</span><br><span class="line">    try(syscall_mem_alloc(child_id, (<span class="type">void</span>*)va, perm));</span><br><span class="line">    <span class="keyword">if</span> (src != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> r = syscall_mem_map(child_id, (<span class="type">void</span>*)va, <span class="number">0</span>, (<span class="type">void</span>*)UTEMP, perm | PTE_D);</span><br><span class="line">        <span class="keyword">if</span> (r)</span><br><span class="line">        &#123;</span><br><span class="line">            syscall_mem_unmap(child_id, (<span class="type">void</span>*)va);</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span>*)(UTEMP + offset), src, len);</span><br><span class="line">        <span class="keyword">return</span> syscall_mem_unmap(<span class="number">0</span>, (<span class="type">void</span>*)UTEMP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<p>So this is <code>spawn</code>, sorry for few details. :(</p>
<hr>
<h1 id="3-Shell"><a href="#3-Shell" class="headerlink" title="3. Shell"></a>3. Shell</h1><p>Well, shell is actually a external program, that can access certain system APIs. The original MOS Shell is really shabby, so I don’t want to talk much about it.</p>
<p>But there is one thing, that inspired me. That is, we can parse pipe operator <code>|</code> by a recursive parsing.</p>
<p>I chose Lab 6 Challenge, so refer to that post for more detailed information on Shell. :)</p>
<ul>
<li><a href="/posts/Lab-6-Challenge">Lab 6 Challenge</a></li>
</ul>
<hr>
<h1 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h1><p>Well, this is the last Lab of OS. (Or the one but last?) So much to say, but only at the tip of tongue. I had to admit, a nice experience, it is, to make a clumsy operating system from… not totally scratch. But… It is really torturing sometimes, since there are so many obscure bugs. 🤕</p>
<p>So, I guess, this is it. At least it contribute some good articles to my blog. 😳</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://tonys-studio.top">Tony Skywalker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Lab-6-Reflection/">https://blog.tonys-studio.top/posts/Lab-6-Reflection/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OS/">OS</a><a class="post-meta__tags" href="/tags/BUAA/">BUAA</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Lab-6-Challenge/" title="Lab 6 Challenge"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/09/04.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Lab 6 Challenge</div></div><div class="info-2"><div class="info-item-1">Lab 6 Challenge - A More Powerful Shell</div></div></div></a><a class="pagination-related" href="/posts/JSON-Serialization-in-Python/" title="JSON Serialization in Python"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/05.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">JSON Serialization in Python</div></div><div class="info-2"><div class="info-item-1">Conversion between JSON and Python objects</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/File-System-IPC/" title="File System IPC"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/14.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:57</div><div class="info-item-2">File System IPC</div></div><div class="info-2"><div class="info-item-1">Brief on File System IPC Mechanism</div></div></div></a><a class="pagination-related" href="/posts/Lab-2-Extra-Reflection/" title="Lab 2 Extra Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/03/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 6th, 2023 - 19:53:06</div><div class="info-item-2">Lab 2 Extra Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 2 Extra</div></div></div></a><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 20th, 2023 - 17:07:01</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Lab-5-Reflection/" title="Lab 5 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/24/01.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:42</div><div class="info-item-2">Lab 5 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 5 - File System</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Challenge/" title="Lab 6 Challenge"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/09/04.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:24</div><div class="info-item-2">Lab 6 Challenge</div></div><div class="info-2"><div class="info-item-1">Lab 6 Challenge - A More Powerful Shell</div></div></div></a><a class="pagination-related" href="/posts/Page-Directory-Self-Mapping/" title="Page Directory Self Mapping"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/07/15.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Mar. 25th, 2023 - 20:56:35</div><div class="info-item-2">Page Directory Self Mapping</div></div><div class="info-2"><div class="info-item-1">Understanding page directory self mapping</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="author-info-name">Tony Skywalker</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">80</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It won't be long before the armies of the Republic track us here.<br>You can visit this site at both:<li><a href="http://blog.tonys-studio.top/" target="_blank">Main Site</a></li><li><a href="https://lord-turmoil.github.io/" target="_blank">Github Mirror Site</a></li></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BUAA-2023-Spring-OS"><span class="toc-text">BUAA 2023 Spring OS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prologue"><span class="toc-text">Prologue</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Pipe"><span class="toc-text">1. Pipe</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Pipe-Structure"><span class="toc-text">1.1 Pipe Structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Create-Pipe"><span class="toc-text">1.2 Create Pipe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Read-Write-Pipe"><span class="toc-text">1.3 Read &amp; Write Pipe</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Spawn"><span class="toc-text">2. Spawn</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Shell"><span class="toc-text">3. Shell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Epilogue"><span class="toc-text">Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Demystifying-NAT-in-P2P/" title="Demystifying NAT in P2P"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/07/05.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Demystifying NAT in P2P"/></a><div class="content"><a class="title" href="/posts/Demystifying-NAT-in-P2P/" title="Demystifying NAT in P2P">Demystifying NAT in P2P</a><time datetime="2025-04-25T08:36:44.000Z" title="Created Apr. 25th, 2025 - 16:36:44 16:36:44">Apr. 25th, 2025 - 16:36:44</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Thoughts-on-Black-Hand-Strategy/" title="Thoughts on Black Hand Strategy"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/top/special/bh_top.jpg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Thoughts on Black Hand Strategy"/></a><div class="content"><a class="title" href="/posts/Thoughts-on-Black-Hand-Strategy/" title="Thoughts on Black Hand Strategy">Thoughts on Black Hand Strategy</a><time datetime="2025-02-28T12:37:42.000Z" title="Created Feb. 28th, 2025 - 20:37:42 20:37:42">Feb. 28th, 2025 - 20:37:42</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Setup-Modern-TypeScript-Project/" title="Setup Modern TypeScript Project"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/11.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Setup Modern TypeScript Project"/></a><div class="content"><a class="title" href="/posts/Setup-Modern-TypeScript-Project/" title="Setup Modern TypeScript Project">Setup Modern TypeScript Project</a><time datetime="2025-01-10T07:18:43.000Z" title="Created Jan. 10th, 2025 - 15:18:43 15:18:43">Jan. 10th, 2025 - 15:18:43</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Scam-From-Your-Own-Email-Address/" title="Scam From Your Own Email Address"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/top/special/scam.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Scam From Your Own Email Address"/></a><div class="content"><a class="title" href="/posts/Scam-From-Your-Own-Email-Address/" title="Scam From Your Own Email Address">Scam From Your Own Email Address</a><time datetime="2025-01-08T15:29:32.000Z" title="Created Jan. 8th, 2025 - 23:29:32 23:29:32">Jan. 8th, 2025 - 23:29:32</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Understanding-TypeScript-Philosophy/" title="Understanding TypeScript Philosophy"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/03/09.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Understanding TypeScript Philosophy"/></a><div class="content"><a class="title" href="/posts/Understanding-TypeScript-Philosophy/" title="Understanding TypeScript Philosophy">Understanding TypeScript Philosophy</a><time datetime="2025-01-04T05:58:47.000Z" title="Created Jan. 4th, 2025 - 13:58:47 13:58:47">Jan. 4th, 2025 - 13:58:47</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/08/08.jpeg);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By Tony Skywalker</div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://comment.tonys-studio.top',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      comment: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Anything you would like to search?🔍" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="Framework Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="Theme Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly%205.3.3-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally." title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>