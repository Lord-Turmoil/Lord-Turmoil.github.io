<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Empower ASP.NET Core With Elasticsearch | TONY'S STUDIO</title><meta name="author" content="Tony Lewis"><meta name="copyright" content="Tony Lewis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Using Elasticsearch in ASP.NET Core project with NEST"><meta property="og:type" content="article"><meta property="og:title" content="Empower ASP.NET Core With Elasticsearch"><meta property="og:url" content="https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><meta property="og:site_name" content="TONY&#39;S STUDIO"><meta property="og:description" content="Using Elasticsearch in ASP.NET Core project with NEST"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/03.jpeg"><meta property="article:published_time" content="2023-12-21T14:28:48.000Z"><meta property="article:modified_time" content="2026-02-25T11:02:33.217Z"><meta property="article:author" content="Tony Lewis"><meta property="article:tag" content="ASP.NET"><meta property="article:tag" content="Elasticsearch"><meta property="article:tag" content="Kibana"><meta property="article:tag" content="NEST"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/03.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Empower ASP.NET Core With Elasticsearch",
  "url": "https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/03.jpeg",
  "datePublished": "2023-12-21T14:28:48.000Z",
  "dateModified": "2026-02-25T11:02:33.217Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Lewis",
      "url": "https://www.tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//www.clarity.ms"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#300303")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","undefined")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),r=window.matchMedia("(prefers-color-scheme: dark)"),c=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(c.matches)a();else if(r.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}r.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?o():a())})}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a)}(),btf.addGlobalFn("pjaxComplete",()=>{_hmt.push(["_trackPageview",window.location.pathname])},"baidu_analytics")</script><script>!function(t,e,n,c,r,s,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/sthrplbt7c",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,a)}(window,document,"clarity","script")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:3,unescape:!1,pagination:{enable:!0,hitsPerPage:8},languages:{hits_empty:"No results found for: ${query}",hits_stats:"${hits} articles found"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!1,post:!1},runtime:"days",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:256,languages:{author:"Author: Tony Lewis",link:"Link: ",source:"Source: TONY'S STUDIO",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#871798",bgDark:"#C81025",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!1,islazyloadPlugin:!1,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Empower ASP.NET Core With Elasticsearch",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/static/custom.css"><meta name="generator" content="Hexo 8.1.1"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",()=>{Pace.restart()},"pace_restart")</script><link rel="stylesheet" href="/static/barber-shop.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div class="bg-animation" id="web_bg" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/background.png)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/03.jpeg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Empower ASP.NET Core With Elasticsearch</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> Back to Home</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Empower ASP.NET Core With Elasticsearch</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-12-21T14:28:48.000Z" title="Created Dec. 21st, 2023 - 22:28:48 22:28:48">Dec. 21st, 2023 - 22:28:48</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-02-25T11:02:33.217Z" title="Updated Feb. 25th, 2026 - 19:02:33 19:02:33">Feb. 25th, 2026 - 19:02:33</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Software-Engineering/">Software Engineering</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Software-Engineering/Web-Development/">Web Development</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>12mins</span></span><span class="post-meta-separator">|</span><span data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Empower-ASP-NET-Core-with-Elasticsearch/#post-comment"><span class="waline-comment-count" data-path="/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><html><head></head><body><h1 id="Prologue"><a href="#Prologue" class="headerlink" title="Prologue"></a>Prologue</h1><p>Well, in previous posts, we‚Äôve <a href="/posts/Setup-Elasticsearch-with-Kibana">Setup Elasticsearch with Kibana</a>, and enabled our project to <a href="/posts/Ingest-Data-from-MySQL-to-Elasticsearch">Ingest Data from MySQL to Elasticsearch</a>. In this article, of course, we are going to answer the question on how to use Elasticsearch in our application, which is an ASP.NET Core Web API project. To be specific, we‚Äôre using .NET 8. ü§©</p><p>If you want to run your application on Linux, and have no idea how to do it, see <a href="/posts/Cross-platform-Development-with-NET-Core">Cross-platform Development with .NET Core</a>.</p><hr><h1 id="1-Setup-the-Project"><a href="#1-Setup-the-Project" class="headerlink" title="1. Setup the Project"></a>1. Setup the Project</h1><p>We‚Äôll use the project structure in <a href="/posts/Thoughts-on-Basic-Structure-of-ASP-NET">Thoughts on Basic Structure of ASP.NET Core Web API</a>. Although Minified API is introduced in ASP.NET Core, I still prefer using <code>Startup.cs</code>. Maybe I‚Äôll make some changes later. ü´†</p><h2 id="1-1-Install-NuGet-Package"><a href="#1-1-Install-NuGet-Package" class="headerlink" title="1.1 Install NuGet Package"></a>1.1 Install NuGet Package</h2><p>To use Elasticsearch in ASP.NET Core, we need the <a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-net">NEST</a> NuGet package.</p><img src="/posts/Empower-ASP-NET-Core-with-Elasticsearch/image-20231214231900101.png" alt="image-20231214231900101" style="zoom:50%"><h2 id="1-2-Add-Dependency-Injection"><a href="#1-2-Add-Dependency-Injection" class="headerlink" title="1.2 Add Dependency Injection"></a>1.2 Add Dependency Injection</h2><p>First, we need to add an option entry for elastic search. Of course you can hard code it into your project, but this provides you more flexibility.</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"ElasticOptions"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"DefaultConnection"</span><span class="punctuation">:</span> <span class="string">"http://localhost:9200"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>Then, create a class for it.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ElasticOptions</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ElasticSection = <span class="string">"ElasticOptions"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DefaultConnection { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>And finally, in <code>Startup.cs</code>, we can write this.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration _configuration;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line">    {</span><br><span class="line">        _configuration = configuration;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">var</span> elasticOptions = <span class="keyword">new</span> ElasticOptions();</span><br><span class="line">        _configuration.GetRequiredSection(ElasticOptions.ElasticSection).Bind(elasticOptions);</span><br><span class="line">        <span class="keyword">var</span> pool = <span class="keyword">new</span> SingleNodeConnectionPool(<span class="keyword">new</span> Uri(elasticOptions.DefaultConnection));</span><br><span class="line">        <span class="keyword">var</span> client = <span class="keyword">new</span> ElasticClient(<span class="keyword">new</span> ConnectionSettings(pool));</span><br><span class="line">        services.AddSingleton&lt;IElasticClient&gt;(client);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Now, you are ready to use Elasticsearch.</p><h2 id="1-3-Connection-Settings"><a href="#1-3-Connection-Settings" class="headerlink" title="1.3 Connection Settings"></a>1.3 Connection Settings</h2><h3 id="1-3-1-Basic-Authentication"><a href="#1-3-1-Basic-Authentication" class="headerlink" title="1.3.1 Basic Authentication"></a>1.3.1 Basic Authentication</h3><p>Now that we learnt the basic configuration of Elasticsearch connection, let‚Äôs look at it a step further.</p><p>If you configured basic authentication for Elasticsearch, you then need username and password to communicate with Elasticsearch API. So let‚Äôs add some more fields in configuration file.</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"ElasticOptions"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"DefaultConnection"</span><span class="punctuation">:</span> <span class="string">"http://localhost:9200"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"EnableBasicAuth"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"Username"</span><span class="punctuation">:</span> <span class="string">"your username"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"Password"</span><span class="punctuation">:</span> <span class="string">"your password"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>Correspondingly, we have to change our option class.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ElasticOptions</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ElasticSection = <span class="string">"ElasticOptions"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DefaultConnection { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> EnableBasicAuth { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Username { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Password { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>At last, in <code>Startup.cs</code>, if we enable basic authentication, add username and password to connection settings.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">ConnectionSettings settings = <span class="keyword">new</span> ConnectionSettings(pool)</span><br><span class="line"><span class="keyword">if</span> (elasticOptions.EnableBasicAuth)</span><br><span class="line">{</span><br><span class="line">    settings.BasicAuthentication(elasticOptions.Username, elasticOptions.Password);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> ElasticClient(settings);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="1-3-2-Some-More-Options"><a href="#1-3-2-Some-More-Options" class="headerlink" title="1.3.2 Some More Options"></a>1.3.2 Some More Options</h3><p>Later, if you run into mysterious errors with Elasticsearch connection, calm down. It may not be your fault, but improperly configured options.</p><p>First of all, if you‚Äôre using an older version of Elasticsearch client (e.g. 7.x), but deployed the latest version (e.g. 8.x) on your server, you should better enable API versioning header.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">settings.EnableApiVersioningHeader();</span><br></pre></td></tr></tbody></table></figure><p>The other one may be tricky, as you may not encounter in most cases. However, if it ever occurs, there‚Äôs few answer on the Internet.</p><p>This happens, if you concurrently send multiple requests with one Elasticsearch client instance, this error will be thrown. The solution is to enable pipelining, and disable direct streaming.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">settings.EnableHttpPipelining()</span><br><span class="line">    .DisableDirectStreaming();</span><br></pre></td></tr></tbody></table></figure><p>Also, use <code>IsValid</code> to check if the response is successful or not. Don‚Äôt use other flags.</p><hr><h1 id="2-Index-Document"><a href="#2-Index-Document" class="headerlink" title="2. Index Document"></a>2. Index Document</h1><p>Although we‚Äôve learnt how to ingest data from MySQL to Elasticsearch, in which there‚Äôs no need to manually index data into Elasticsearch, sometimes we may not need MySQL and have to put data directly into Elasticsearch.</p><h2 id="2-1-Creating-Models-for-Elasticsearch"><a href="#2-1-Creating-Models-for-Elasticsearch" class="headerlink" title="2.1 Creating Models for Elasticsearch"></a>2.1 Creating Models for Elasticsearch</h2><p>Well, emm‚Ä¶ let‚Äôs put it simple. (<del>Not because I don‚Äôt know how.</del>) For our document, it is actually an C# Object view of a JSON object. NEST will serialize and deserialize between this model and JSON it uses in RESTful API. So just a simple object. And I think it is not a good idea for nested objects. (Or I‚Äôm missing something.)</p><div class="note warning flat"><p>Just keep this model simple. If you use <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/statements-expressions-operators/expression-bodied-members">expression-bodied members</a>, NEST will also include it, even if you don‚Äôt want it appear in your index.</p></div><p>So, a proper model should look like this. Well, fields like <code>int</code> and <code>DateTime</code> are acceptable.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">ElasticModel</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Id { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Description { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">    <span class="keyword">public</span> DateTime Updated { <span class="keyword">get</span>; <span class="keyword">set</span>; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>If you really want add some other fields into your model, use Elasticsearch attributes, e.g. <code>[Ignore]</code> to tell NEST which fields are not for indexing.</p><h2 id="2-1-Index-A-Single-Model"><a href="#2-1-Index-A-Single-Model" class="headerlink" title="2.1 Index A Single Model"></a>2.1 Index A Single Model</h2><p>Assume that we inject <code>IElasticClient</code> to our services as <code>_client</code>. Then we can simply index a model with <code>Index</code> or its async brother. It is preferred to set the index name manually if you have multiple indices. The ID is not required, as Elasticsearch can create it for you automatically.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.IndexAsync&lt;ElasticModel&gt;(model, op =&gt; op</span><br><span class="line">    .Index(type)</span><br><span class="line">    .Id(model.Id)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><div class="note info flat"><p>You don‚Äôt need to create the index first, as Elasticsearch will automatically create it if the index does not exist before.</p></div><h2 id="2-2-Bulk-Index-Models"><a href="#2-2-Bulk-Index-Models" class="headerlink" title="2.2 Bulk Index Models"></a>2.2 Bulk Index Models</h2><p>For data that comes in large scales, we may need to bulk index them. Luckily, NEST provides us with <code>BulkDescriptor</code>.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bulkDescriptor = <span class="keyword">new</span> BulkDescriptor();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> model <span class="keyword">in</span> models)</span><br><span class="line">{</span><br><span class="line">    bulkDescriptor.Index&lt;ElasticModel&gt;(op =&gt; op</span><br><span class="line">        .Document(model)</span><br><span class="line">        .Id(model.Id)</span><br><span class="line">        .Index(<span class="string">"demo"</span>)</span><br><span class="line">    );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">await</span> _client.BulkAsync(bulkDescriptor);</span><br></pre></td></tr></tbody></table></figure><p>Note that the return value of bulk operation is always success, but individual operation may fail.</p><div class="note info flat"><p>To improve the performance of your application in such scenario with heavy indexing or updating tasks, see <a href="/posts/Bulk-Task-Optimization-in-C/">Bulk Task Optimization in C#</a>.</p></div><hr><h1 id="3-Let-the-Search-Begin"><a href="#3-Let-the-Search-Begin" class="headerlink" title="3. Let the Search Begin!"></a>3. Let the Search Begin!</h1><p>NEST provides strongly typed requests and responses for Elasticsearch APIs, so it is quite easy for us to do search stuffs. However, it is more like translating RESTful API to NEST API. So you can refer to the official documentation for searching with RESTful API <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.11/search-search.html">Search API</a>.</p><p>Basically, it is easy to change between these two types of API, but there are some cases when the translation is not that obvious, which are what I‚Äôm going to talk about.</p><h2 id="3-1-Basic-Search"><a href="#3-1-Basic-Search" class="headerlink" title="3.1 Basic Search"></a>3.1 Basic Search</h2><h3 id="3-1-1-Search-with-ID"><a href="#3-1-1-Search-with-ID" class="headerlink" title="3.1.1 Search with ID"></a>3.1.1 Search with ID</h3><p>First of all, you should inject <code>IElasticClient</code> to your service. Suppose it is called <code>_client</code>.</p><p>Let‚Äôs start with searching by ID. In any search, we should specify which index we‚Äôre going to search. As ID is fixed, there‚Äôs no need for partial or even fuzzy match, we just need to use <code>Term</code> query, which will not analyze words.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;ElasticModel&gt;&gt; GetModelsById(IEnumerable&lt;<span class="built_in">string</span>&gt; ids)</span><br><span class="line">{   </span><br><span class="line">    <span class="keyword">var</span> container = <span class="keyword">new</span> QueryContainer();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> id <span class="keyword">in</span> ids)</span><br><span class="line">    {</span><br><span class="line">        container |= <span class="keyword">new</span> QueryContainerDescriptor&lt;ElasticModel&gt;()</span><br><span class="line">            .Term(m =&gt; m.Field(f =&gt; f.Id).Value(id));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ISearchResponse&lt;ElasticModel&gt; response = <span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">        .Index(<span class="string">"demo"</span>).Query(q =&gt; q.Bool(b =&gt; b.Should(container))));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.IsValid)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SearchException(response.DebugInformation);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response.Documents.ToList();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Here, we use <code>Documents</code> in <code>response</code>. Astute readers will note that in RESTful API, the results are in hits, and NEST does provide <code>response.Hits</code> field for all hit results. So what‚Äôs the difference?</p><p>To put it simple, elements in <code>Hits</code> represents the hits list in RESTful response, which include extra fields, like <code>Score</code>. However, <code>Documents</code> only contain <code>_source</code> filed.</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hits<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"_index"</span><span class="punctuation">:</span> <span class="string">"works"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"_id"</span><span class="punctuation">:</span> <span class="string">"12346"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"_score"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"_source"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">12346</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Design Pattern"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"description"</span><span class="punctuation">:</span> <span class="string">"GoF patterns"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"updated"</span><span class="punctuation">:</span> <span class="string">"2023-11-18T14:14:06"</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure><h3 id="3-1-2-Search-with-many-conditions"><a href="#3-1-2-Search-with-many-conditions" class="headerlink" title="3.1.2 Search with  many conditions"></a>3.1.2 Search with many conditions</h3><p>Here, we get all models whose ID is in a given list. In this case, a better solution is to build a query container, and add all id matches as single queries. So here is how it works. It is actually a logic query, see <a href="#3-5-Logic-Operator">Logic Operator</a>.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;ElasticModel&gt;&gt; GetModelsById(IEnumerable&lt;<span class="built_in">string</span>&gt; words)</span><br><span class="line">{   </span><br><span class="line">    <span class="keyword">var</span> container = <span class="keyword">new</span> QueryContainer();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> id <span class="keyword">in</span> ids)</span><br><span class="line">    {</span><br><span class="line">        container |= <span class="keyword">new</span> QueryContainerDescriptor&lt;ElasticModel&gt;()</span><br><span class="line">            .Term(m =&gt; m.Field(f =&gt; f.Name).Value(id));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ISearchResponse&lt;ElasticModel&gt; response = <span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">        .Index(<span class="string">"demo"</span>).Query(q =&gt; q.Bool(b =&gt; b.Should(container))));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.IsValid)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SearchException(response.DebugInformation);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response.Documents.ToList();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>It‚Äôs a little tricky that <code>QueryContainer</code> uses operator overload to achieve ‚ÄúOR‚Äù or ‚ÄúAND‚Äù operation, instead of a method.</p><div class="note success flat"><p>In order to expose high level API, NEST seems to use many ‚Äúdescriptors‚Äù when constructing requests.</p></div><h2 id="3-2-Fuzzy-Match"><a href="#3-2-Fuzzy-Match" class="headerlink" title="3.2 Fuzzy Match"></a>3.2 Fuzzy Match</h2><p>One of Elasticsearch‚Äôs advantages is that it supports fuzzy search. To use fuzzy search, you should use <code>Match</code> query instead of <code>Term</code>, and set fuzziness manually. Here the fuzziness is defined as Levenshtein Edit distance (or number of edits). Supported distances are 0, 1, 2.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">            .Index(<span class="string">"demo"</span>)</span><br><span class="line">            .Query(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Description)</span><br><span class="line">                .Query(<span class="string">"algorihm"</span>).Fuzziness(Fuzziness.EditDistance(<span class="number">1</span>)))));</span><br></pre></td></tr></tbody></table></figure><div class="note info flat"><p>Get use to <code>))))...)</code> with NEST. ü§≠</p></div><h2 id="3-3-Pagination"><a href="#3-3-Pagination" class="headerlink" title="3.3 Pagination"></a>3.3 Pagination</h2><p>Of course, Elasticsearch supports pagination, but with <code>from</code> and <code>size</code>. It is easy to convert page and page size to from and size. Here, we assume that page starts from 0.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">            .Index(<span class="string">"index name"</span>)</span><br><span class="line">            .From(page * pageSize)</span><br><span class="line">            .Size(pageSize)</span><br><span class="line">            <span class="comment">// ...</span></span><br></pre></td></tr></tbody></table></figure><div class="note danger flat"><p>You shouldn‚Äôt use pagination to iterate through all data! By default, Elasticsearch allow maximum 10000 records to be returned, which means <code>from</code> + <code>size</code> should less than 10000. To do this, use <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scroll-api.html">Scroll API</a> instead.</p></div><h2 id="3-4-Sorting"><a href="#3-4-Sorting" class="headerlink" title="3.4 Sorting"></a>3.4 Sorting</h2><p>Well, sorting is relatively simpler. Just specify the field and order in search.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">            .Index(<span class="string">"index name"</span>)</span><br><span class="line">            .From(page * pageSize)</span><br><span class="line">            .Size(pageSize)</span><br><span class="line">            .Sort(m =&gt; m.Field(f =&gt; f.Updated, SortOrder.Descending))</span><br><span class="line">            .Query(<span class="comment">/* ... */</span>);</span><br></pre></td></tr></tbody></table></figure><h2 id="3-5-Logic-Operator"><a href="#3-5-Logic-Operator" class="headerlink" title="3.5 Logic Operator"></a>3.5 Logic Operator</h2><p>Elasticsearch support logic AND, OR and NOT in query. To do this, we only need a bool query.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">    .Index(<span class="string">"demo"</span>)</span><br><span class="line">    .From(dto.Page * dto.PageSize)</span><br><span class="line">    .Size(dto.PageSize)</span><br><span class="line">    .Query(q =&gt; q.Bool(b =&gt; b</span><br><span class="line">        .Must(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">"hello"</span>)))</span><br><span class="line">        .Should(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">"there"</span>)))</span><br><span class="line">        .MustNot(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">"General"</span>)))));</span><br></pre></td></tr></tbody></table></figure><p><code>Must</code> is AND, <code>Should</code> is OR, and <code>MustNot</code> is NOT.</p><hr><h1 id="Appendix-Some-Tricks"><a href="#Appendix-Some-Tricks" class="headerlink" title="Appendix: Some Tricks"></a>Appendix: Some Tricks</h1><h2 id="A-Dynamic-Field"><a href="#A-Dynamic-Field" class="headerlink" title="A. Dynamic Field"></a>A. Dynamic Field</h2><p>For common queries, flexibility may be the biggest concern. For example, we may need to dynamically change the field we want to search based on the request parameter. So here is how we change field based on query.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Expression&lt;Func&lt;ElasticModel, <span class="built_in">string</span>&gt;&gt;? GetField(<span class="built_in">string</span> field)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">return</span> field <span class="keyword">switch</span> {</span><br><span class="line">        <span class="string">"name"</span> =&gt; w =&gt; w.Name,</span><br><span class="line">        <span class="string">"description"</span> =&gt; w =&gt; w.Description,</span><br><span class="line">        _ =&gt; <span class="literal">null</span></span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>We have to return <code>Expression</code> instead of <code>Func</code>, as <code>Func</code> cannot be converted into <code>Expresesion</code> directly. We can only initiate Linq expression with a lambda.</p><p>With this, we can achieve dynamic field in query. You may need to check null before pass it to <code>Field</code>.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q.Match(m =&gt; m.Field(GetField(<span class="string">"name"</span>)).Query(cond.Value))</span><br></pre></td></tr></tbody></table></figure><h2 id="B-Complex-Condition"><a href="#B-Complex-Condition" class="headerlink" title="B. Complex Condition"></a>B. Complex Condition</h2><p>When we do logic operations, the condition may not be fixed. So there‚Äôs a problem of constructing the bool query. Here is an example of build flexible bool query.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BoolQueryDescriptor&lt;ElasticModel&gt; <span class="title">ConstructQueryDescriptor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    BoolQueryDescriptor&lt;ElasticModel&gt; descriptor</span>)</span></span><br><span class="line">{</span><br><span class="line">    descriptor = descriptor.Must(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">"hello"</span>)));</span><br><span class="line">    descriptor = descriptor.Should(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">"there"</span>)));</span><br><span class="line">    descriptor = descriptor.MustNot(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">"General"</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>With this, you can simply call this function in bool query.</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">    .Index(<span class="string">"demo"</span>)</span><br><span class="line">    .From(dto.Page * dto.PageSize)</span><br><span class="line">    .Size(dto.PageSize)</span><br><span class="line">    .Query(q =&gt; q.Bool(b =&gt; ConstructQueryDescriptor(b)));</span><br></pre></td></tr></tbody></table></figure><p>The same goes with other types of queries.</p><hr><h1 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h1><p>It is really easy to communicate with Elasticsearch with NEST. The APIs are overall, natural to use and understand. Just so much better than it in Python, which does not have any type at all, thus lacks productivity.</p></body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.tonys-studio.top">Tony Lewis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/">https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ASP-NET/">ASP.NET</a><a class="post-meta__tags" href="/tags/Elasticsearch/">Elasticsearch</a><a class="post-meta__tags" href="/tags/Kibana/">Kibana</a><a class="post-meta__tags" href="/tags/NEST/">NEST</a></div><div class="post-share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_wechat"></a><a class="a2a_button_qzone"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Windows-File-Explorer-Performance-Issue-with-PDF/" title="Windows File Explorer Performance Issue With PDF"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/23/01.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Windows File Explorer Performance Issue With PDF</div></div><div class="info-2"><div class="info-item-1">Troubleshoot Windows File Explorer performance issue with PDF files</div></div></div></a><a class="pagination-related" href="/posts/Bulk-Task-Optimization-in-C/" title="Bulk Task Optimization in C#"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/21/01.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Bulk Task Optimization in C#</div></div><div class="info-2"><div class="info-item-1">Optimize bulk task in C# using async/wait.</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Setup-Elasticsearch-with-Kibana/" title="Setup Elasticsearch With Kibana"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/21/10.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Dec. 10th, 2023 - 11:11:26</div><div class="info-item-2">Setup Elasticsearch With Kibana</div></div><div class="info-2"><div class="info-item-1">Setup Elasticsearch with Kibana on Ubuntu server.</div></div></div></a><a class="pagination-related" href="/posts/Ingest-Data-from-MySQL-to-Elasticsearch/" title="Ingest Data From MySQL to Elasticsearch"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/02/03.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Dec. 11th, 2023 - 16:03:43</div><div class="info-item-2">Ingest Data From MySQL to Elasticsearch</div></div><div class="info-2"><div class="info-item-1">Using Logstash to sync MySQL and Elasticsearch</div></div></div></a><a class="pagination-related" href="/posts/Cookies-in-ASP-NET-Core/" title="Cookies in ASP.NET Core"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/06/03.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Aug. 2nd, 2023 - 21:13:37</div><div class="info-item-2">Cookies in ASP.NET Core</div></div><div class="info-2"><div class="info-item-1">Handling Cookies in ASP.NET Core 6.0</div></div></div></a><a class="pagination-related" href="/posts/Data-Annotation-of-EF-Core/" title="Data Annotation of EF Core"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/10.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jul. 6th, 2023 - 20:02:07</div><div class="info-item-2">Data Annotation of EF Core</div></div><div class="info-2"><div class="info-item-1">Practice on EF Core data annotation</div></div></div></a><a class="pagination-related" href="/posts/ASP-NET-CORS-Walkthrough/" title="ASP.NET CORS Walkthrough"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/01/11.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jul. 18th, 2023 - 19:39:31</div><div class="info-item-2">ASP.NET CORS Walkthrough</div></div><div class="info-2"><div class="info-item-1">Practical ASP.NET Core CORS solution</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="author-info-name">Tony Lewis</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Hello there!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prologue"><span class="toc-text">Prologue</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Setup-the-Project"><span class="toc-text">1. Setup the Project</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Install-NuGet-Package"><span class="toc-text">1.1 Install NuGet Package</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Add-Dependency-Injection"><span class="toc-text">1.2 Add Dependency Injection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Connection-Settings"><span class="toc-text">1.3 Connection Settings</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-Basic-Authentication"><span class="toc-text">1.3.1 Basic Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-Some-More-Options"><span class="toc-text">1.3.2 Some More Options</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Index-Document"><span class="toc-text">2. Index Document</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Creating-Models-for-Elasticsearch"><span class="toc-text">2.1 Creating Models for Elasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Index-A-Single-Model"><span class="toc-text">2.1 Index A Single Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Bulk-Index-Models"><span class="toc-text">2.2 Bulk Index Models</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Let-the-Search-Begin"><span class="toc-text">3. Let the Search Begin!</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Basic-Search"><span class="toc-text">3.1 Basic Search</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-Search-with-ID"><span class="toc-text">3.1.1 Search with ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-Search-with-many-conditions"><span class="toc-text">3.1.2 Search with many conditions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Fuzzy-Match"><span class="toc-text">3.2 Fuzzy Match</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Pagination"><span class="toc-text">3.3 Pagination</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Sorting"><span class="toc-text">3.4 Sorting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-Logic-Operator"><span class="toc-text">3.5 Logic Operator</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Appendix-Some-Tricks"><span class="toc-text">Appendix: Some Tricks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Dynamic-Field"><span class="toc-text">A. Dynamic Field</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B-Complex-Condition"><span class="toc-text">B. Complex Condition</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Epilogue"><span class="toc-text">Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Advanced-C-Workshop-2023-03/" title="Advanced C++ Workshop 2023 (03)"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/CSCS.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Advanced C++ Workshop 2023 (03)"></a><div class="content"><a class="title" href="/posts/Advanced-C-Workshop-2023-03/" title="Advanced C++ Workshop 2023 (03)">Advanced C++ Workshop 2023 (03)</a><time datetime="2026-02-22T13:16:59.000Z" title="Created Feb. 22nd, 2026 - 21:16:59 21:16:59">Feb. 22nd, 2026 - 21:16:59</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Advanced-C-Workshop-2023-02/" title="Advanced C++ Workshop 2023 (02)"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/CSCS.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Advanced C++ Workshop 2023 (02)"></a><div class="content"><a class="title" href="/posts/Advanced-C-Workshop-2023-02/" title="Advanced C++ Workshop 2023 (02)">Advanced C++ Workshop 2023 (02)</a><time datetime="2026-02-21T09:38:11.000Z" title="Created Feb. 21st, 2026 - 17:38:11 17:38:11">Feb. 21st, 2026 - 17:38:11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Advanced-C-Workshop-2023-01/" title="Advanced C++ Workshop 2023 (01)"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/CSCS.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Advanced C++ Workshop 2023 (01)"></a><div class="content"><a class="title" href="/posts/Advanced-C-Workshop-2023-01/" title="Advanced C++ Workshop 2023 (01)">Advanced C++ Workshop 2023 (01)</a><time datetime="2026-02-21T09:38:04.000Z" title="Created Feb. 21st, 2026 - 17:38:04 17:38:04">Feb. 21st, 2026 - 17:38:04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Symbolic-Execution-with-KLEE/" title="Symbolic Execution With KLEE"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/09/05.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Symbolic Execution With KLEE"></a><div class="content"><a class="title" href="/posts/Symbolic-Execution-with-KLEE/" title="Symbolic Execution With KLEE">Symbolic Execution With KLEE</a><time datetime="2025-11-28T09:39:23.000Z" title="Created Nov. 28th, 2025 - 17:39:23 17:39:23">Nov. 28th, 2025 - 17:39:23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/ahsoka/09.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="A Fancy and Practical Zsh Configuration"></a><div class="content"><a class="title" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration">A Fancy and Practical Zsh Configuration</a><time datetime="2025-09-26T14:15:54.000Z" title="Created Sep. 26th, 2025 - 22:15:54 22:15:54">Sep. 26th, 2025 - 22:15:54</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/03.jpeg)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By Tony Lewis</span></div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=e=>{const t=(e=>{if(!e)return null;const t=e.trim().split(/[\s,]+/).map(e=>Number(e));return 4!==t.length||t.some(e=>Number.isNaN(e))?null:t})(e.getAttribute("viewBox"));if(t)return t;try{const t=e.getBBox();if(t&&t.width&&t.height)return[t.x,t.y,t.width,t.height]}catch(e){}const n=Number(e.getAttribute("width"))||0,i=Number(e.getAttribute("height"))||0;return n>0&&i>0?[0,0,n,i]:[0,0,100,100]},t=(e,t)=>{e.setAttribute("viewBox",`${t[0]} ${t[1]} ${t[2]} ${t[3]}`)},n=(e,t,n)=>Math.max(t,Math.min(n,e)),i=({source:e,initViewBox:t})=>{const n=(()=>{if("string"==typeof e){const t=document.createElement("template");t.innerHTML=e.trim();const n=t.content.querySelector("svg");return n?n.cloneNode(!0):null}return e&&"function"==typeof e.cloneNode?e.cloneNode(!0):null})();if(!n)return;t&&4===t.length&&n.setAttribute("viewBox",t.join(" ")),n.getAttribute("xmlns")||n.setAttribute("xmlns","http://www.w3.org/2000/svg"),!n.getAttribute("xmlns:xlink")&&n.outerHTML.includes("xlink:")&&n.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");const i="dark"===document.documentElement.getAttribute("data-theme"),r=getComputedStyle(document.body).backgroundColor||(i?"#1e1e1e":"#ffffff");n.style.background||(n.style.background=r);const o=(new XMLSerializer).serializeToString(n),s=new Blob([`<!doctype html><html><head><meta charset="utf-8" />\n      <style>\n        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${r}; }\n        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }\n      </style>\n      </head><body>${o}</body></html>`],{type:"text/html;charset=utf-8"}),a=URL.createObjectURL(s);window.open(a,"_blank","noopener"),setTimeout(()=>URL.revokeObjectURL(a),3e4)},r=(e,t,n,i)=>{const r=e[2]*t,o=e[3]*t;return[n-(n-e[0])*t,i-(i-e[1])*t,r,o]},o=i=>{const o=i.querySelector("svg");if(!o)return;const s=e(o);if(i.__mermaidInitViewBox=s,i.__mermaidCurViewBox=s.slice(),t(o,s),i.__mermaidGestureBound)return;i.__mermaidGestureBound=!0;const a=(t,n)=>{const r=o.getBoundingClientRect(),s=i.__mermaidCurViewBox||e(o);return{x:s[0]+(t-r.left)*(s[2]/r.width),y:s[1]+(n-r.top)*(s[3]/r.height),rect:r,vb:s}},d={pointers:new Map,startVb:null,startDist:0,startCenter:null},m=e=>{e=(e=>{const t=i.__mermaidInitViewBox||e,r=.1*t[2],o=10*t[2],s=.1*t[3],a=10*t[3];return e[2]=n(e[2],r,o),e[3]=n(e[3],s,a),e})(e),i.__mermaidCurViewBox=e,t(o,e)},l=e=>{d.pointers.delete(e.pointerId),0===d.pointers.size?(d.startVb=null,d.startDist=0,d.startCenter=null,i.__mermaidLastSinglePointer=null):1===d.pointers.size&&(i.__mermaidLastSinglePointer=[...d.pointers.values()][0])};o.addEventListener("pointerdown",t=>{if("mouse"!==t.pointerType||0===t.button)if(o.setPointerCapture(t.pointerId),d.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),1===d.pointers.size)d.startVb=(i.__mermaidCurViewBox||e(o)).slice();else if(2===d.pointers.size){const t=[...d.pointers.values()],n=t[0].x-t[1].x,r=t[0].y-t[1].y;d.startDist=Math.hypot(n,r),d.startVb=(i.__mermaidCurViewBox||e(o)).slice(),d.startCenter={x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2}}}),o.addEventListener("pointermove",t=>{if(d.pointers.has(t.pointerId))if(d.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),1===d.pointers.size&&d.startVb){const n=[...d.pointers.values()][0],r=(t.clientX,t.movementX,t.clientY,t.movementY,i.__mermaidLastSinglePointer||n),s=n.x-r.x,l=n.y-r.y;i.__mermaidLastSinglePointer=n;const{rect:c}=a(n.x,n.y),u=(i.__mermaidCurViewBox||e(o)).slice(),p=s*(u[2]/c.width),h=l*(u[3]/c.height);m([u[0]-p,u[1]-h,u[2],u[3]])}else if(2===d.pointers.size&&d.startVb&&d.startDist>0){const e=[...d.pointers.values()],t=e[0].x-e[1].x,n=e[0].y-e[1].y,i=Math.hypot(t,n);if(!i)return;const o=d.startDist/i,s={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},l=a(s.x,s.y),c=l.x,u=l.y,p=r(d.startVb,o,c,u);m(p)}}),o.addEventListener("pointerup",l),o.addEventListener("pointercancel",l),o.addEventListener("wheel",t=>{t.preventDefault();const n=t.deltaY>0?1.1:.9,{x:s,y:d}=a(t.clientX,t.clientY),l=(i.__mermaidCurViewBox||e(o)).slice();m(r(l,n,s,d))},{passive:!1}),o.addEventListener("dblclick",()=>{const e=i.__mermaidInitViewBox;e&&(i.__mermaidCurViewBox=e.slice(),t(o,e))})},s=e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"forest";e.forEach((e,n)=>{const r=e.firstElementChild,s=e.querySelector("svg");s&&s.remove(),e.__mermaidGestureBound=!1;const a=r.dataset.config?JSON.parse(r.dataset.config):{};a.theme||(a.theme=t);const d="mermaid-"+n,m=`%%{init: ${JSON.stringify(a)}}%%\n`+r.textContent,l=mermaid.render(d,m),c=t=>{r.insertAdjacentHTML("afterend",t),o(e),e.__mermaidOriginalSvg=t,(e=>{let t=e.querySelector(".mermaid-open-btn");t||(t=document.createElement("button"),t.type="button",t.className="mermaid-open-btn",e.appendChild(t)),t.innerHTML='<i class="fa fa-search fa-fw" aria-hidden="true"></i>',t.__mermaidViewerBound||(t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const n=e.__mermaidOriginalSvg||e.querySelector("svg");if(!n)return;const r=e.__mermaidInitViewBox;i({source:n,initViewBox:r})}),t.__mermaidViewerBound=!0)})(e)};"string"==typeof l?c(l):l.then(({svg:e})=>c(e))})},a=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>s(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",a,"mermaid"),window.pjax?a():document.addEventListener("DOMContentLoaded",a)})()</script><script>(()=>{let n=window.walineFn||null;const e="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,t=(n,t=document,i=window.location.pathname)=>{const o=n({el:t.querySelector("#waline-wrap"),serverURL:"https://comment.tonys-studio.top",pageview:!0,dark:'html[data-theme="dark"]',comment:!0,path:i});e&&(window.shuoshuoComment.destroyWaline=()=>{o.destroy(),t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))})},i=(e,i)=>{n?t(n,e,i):btf.getCSS("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css").then(()=>import("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js")).then(({init:o})=>{n=o||Waline.init,t(n,e,i),window.walineFn=n})};e?window.shuoshuoComment={loadComment:i}:setTimeout(i,0)})()</script></div><script src="/static/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> Loading Database</span></div><div class="local-search-input"><input placeholder="Looking for something?üîç" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>