<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Empower ASP.NET Core With Elasticsearch | TONY'S STUDIO</title><meta name="author" content="Tony Lewis"><meta name="copyright" content="Tony Lewis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Using Elasticsearch in ASP.NET Core project with NEST">
<meta property="og:type" content="article">
<meta property="og:title" content="Empower ASP.NET Core With Elasticsearch">
<meta property="og:url" content="https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/">
<meta property="og:site_name" content="TONY&#39;S STUDIO">
<meta property="og:description" content="Using Elasticsearch in ASP.NET Core project with NEST">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/07.jpeg">
<meta property="article:published_time" content="2023-12-21T14:28:48.000Z">
<meta property="article:modified_time" content="2025-08-12T04:25:00.500Z">
<meta property="article:author" content="Tony Lewis">
<meta property="article:tag" content="Tutorial">
<meta property="article:tag" content="ASP.NET Core">
<meta property="article:tag" content="Elasticsearch">
<meta property="article:tag" content="Kibana">
<meta property="article:tag" content="NEST">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/07.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Empower ASP.NET Core With Elasticsearch",
  "url": "https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/07.jpeg",
  "datePublished": "2023-12-21T14:28:48.000Z",
  "dateModified": "2025-08-12T04:25:00.500Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Lewis",
      "url": "https://tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="codeva-R6O16YoeQt"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#300303')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "sthrplbt7c");
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":10,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":256,"languages":{"author":"Author: Tony Lewis","link":"Link: ","source":"Source: TONY'S STUDIO","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#871798","bgDark":"#C81025","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Empower ASP.NET Core With Elasticsearch',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.6/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/css/barber-shop.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/back_img.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">92</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/07.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Empower ASP.NET Core With Elasticsearch</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Empower ASP.NET Core With Elasticsearch</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-12-21T14:28:48.000Z" title="Created Dec. 21st, 2023 - 22:28:48 22:28:48">Dec. 21st, 2023 - 22:28:48</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-12T04:25:00.500Z" title="Updated Aug. 12th, 2025 - 12:25:00 12:25:00">Aug. 12th, 2025 - 12:25:00</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web-Development/">Web Development</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web-Development/ASP-NET/">ASP.NET</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>13mins</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Empower-ASP-NET-Core-with-Elasticsearch/#post-comment"><span class="waline-comment-count" data-path="/posts/Empower-ASP-NET-Core-with-Elasticsearch/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Prologue"><a href="#Prologue" class="headerlink" title="Prologue"></a>Prologue</h1><p>Well, in previous posts, we’ve <a href="/posts/Setup-Elasticsearch-with-Kibana">Setup Elasticsearch with Kibana</a>, and enabled our project to <a href="/posts/Ingest-Data-from-MySQL-to-Elasticsearch">Ingest Data from MySQL to Elasticsearch</a>. In this article, of course, we are going to answer the question on how to use Elasticsearch in our application, which is an ASP.NET Core Web API project. To be specific, we’re using .NET 8. 🤩</p>
<p>If you want to run your application on Linux, and have no idea how to do it, see <a href="/posts/Cross-platform-Development-with-NET-Core">Cross-platform Development with .NET Core</a>.</p>
<hr>
<h1 id="1-Setup-the-Project"><a href="#1-Setup-the-Project" class="headerlink" title="1. Setup the Project"></a>1. Setup the Project</h1><p>We’ll use the project structure in <a href="/posts/Thoughts-on-Basic-Structure-of-ASP-NET">Thoughts on Basic Structure of ASP.NET Core Web API</a>. Although Minified API is introduced in ASP.NET Core, I still prefer using <code>Startup.cs</code>. Maybe I’ll make some changes later. 🫠</p>
<h2 id="1-1-Install-NuGet-Package"><a href="#1-1-Install-NuGet-Package" class="headerlink" title="1.1 Install NuGet Package"></a>1.1 Install NuGet Package</h2><p>To use Elasticsearch in ASP.NET Core, we need the <a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-net">NEST</a> NuGet package.</p>
<img src="/posts/Empower-ASP-NET-Core-with-Elasticsearch/image-20231214231900101.png" alt="image-20231214231900101" style="zoom:50%;">

<h2 id="1-2-Add-Dependency-Injection"><a href="#1-2-Add-Dependency-Injection" class="headerlink" title="1.2 Add Dependency Injection"></a>1.2 Add Dependency Injection</h2><p>First, we need to add an option entry for elastic search. Of course you can hard code it into your project, but this provides you more flexibility.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;ElasticOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;DefaultConnection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Then, create a class for it.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ElasticOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ElasticSection = <span class="string">&quot;ElasticOptions&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DefaultConnection &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And finally, in <code>Startup.cs</code>, we can write this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration _configuration;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _configuration = configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">var</span> elasticOptions = <span class="keyword">new</span> ElasticOptions();</span><br><span class="line">        _configuration.GetRequiredSection(ElasticOptions.ElasticSection).Bind(elasticOptions);</span><br><span class="line">        <span class="keyword">var</span> pool = <span class="keyword">new</span> SingleNodeConnectionPool(<span class="keyword">new</span> Uri(elasticOptions.DefaultConnection));</span><br><span class="line">        <span class="keyword">var</span> client = <span class="keyword">new</span> ElasticClient(<span class="keyword">new</span> ConnectionSettings(pool));</span><br><span class="line">        services.AddSingleton&lt;IElasticClient&gt;(client);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, you are ready to use Elasticsearch.</p>
<h2 id="1-3-Connection-Settings"><a href="#1-3-Connection-Settings" class="headerlink" title="1.3 Connection Settings"></a>1.3 Connection Settings</h2><h3 id="1-3-1-Basic-Authentication"><a href="#1-3-1-Basic-Authentication" class="headerlink" title="1.3.1 Basic Authentication"></a>1.3.1 Basic Authentication</h3><p>Now that we learnt the basic configuration of Elasticsearch connection, let’s look at it a step further.</p>
<p>If you configured basic authentication for Elasticsearch, you then need username and password to communicate with Elasticsearch API. So let’s add some more fields in configuration file.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;ElasticOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;DefaultConnection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:9200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EnableBasicAuth&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your username&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your password&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Correspondingly, we have to change our option class.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ElasticOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ElasticSection = <span class="string">&quot;ElasticOptions&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DefaultConnection &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> EnableBasicAuth &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Username &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At last, in <code>Startup.cs</code>, if we enable basic authentication, add username and password to connection settings.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">ConnectionSettings settings = <span class="keyword">new</span> ConnectionSettings(pool)</span><br><span class="line"><span class="keyword">if</span> (elasticOptions.EnableBasicAuth)</span><br><span class="line">&#123;</span><br><span class="line">    settings.BasicAuthentication(elasticOptions.Username, elasticOptions.Password);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> ElasticClient(settings);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-2-Some-More-Options"><a href="#1-3-2-Some-More-Options" class="headerlink" title="1.3.2 Some More Options"></a>1.3.2 Some More Options</h3><p>Later, if you run into mysterious errors with Elasticsearch connection, calm down. It may not be your fault, but improperly configured options.</p>
<p>First of all, if you’re using an older version of Elasticsearch client (e.g. 7.x), but deployed the latest version (e.g. 8.x) on your server, you should better enable API versioning header.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">settings.EnableApiVersioningHeader();</span><br></pre></td></tr></table></figure>

<p>The other one may be tricky, as you may not encounter in most cases. However, if it ever occurs, there’s few answer on the Internet.</p>
<p>This happens, if you concurrently send multiple requests with one Elasticsearch client instance, this error will be thrown. The solution is to enable pipelining, and disable direct streaming.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">settings.EnableHttpPipelining()</span><br><span class="line">    .DisableDirectStreaming();</span><br></pre></td></tr></table></figure>

<p>Also, use <code>IsValid</code> to check if the response is successful or not. Don’t use other flags.</p>
<hr>
<h1 id="2-Index-Document"><a href="#2-Index-Document" class="headerlink" title="2. Index Document"></a>2. Index Document</h1><p>Although we’ve learnt how to ingest data from MySQL to Elasticsearch, in which there’s no need to manually index data into Elasticsearch, sometimes we may not need MySQL and have to put data directly into Elasticsearch.</p>
<h2 id="2-1-Creating-Models-for-Elasticsearch"><a href="#2-1-Creating-Models-for-Elasticsearch" class="headerlink" title="2.1 Creating Models for Elasticsearch"></a>2.1 Creating Models for Elasticsearch</h2><p>Well, emm… let’s put it simple. (<del>Not because I don’t know how.</del>) For our document, it is actually an C# Object view of a JSON object. NEST will serialize and deserialize between this model and JSON it uses in RESTful API. So just a simple object. And I think it is not a good idea for nested objects. (Or I’m missing something.)</p>
<div class="note warning flat"><p>Just keep this model simple. If you use <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/statements-expressions-operators/expression-bodied-members">expression-bodied members</a>, NEST will also include it, even if you don’t want it appear in your index.</p>
</div>

<p>So, a proper model should look like this. Well, fields like <code>int</code> and <code>DateTime</code> are acceptable.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">ElasticModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Description &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime Updated &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you really want add some other fields into your model, use Elasticsearch attributes, e.g. <code>[Ignore]</code> to tell NEST which fields are not for indexing.</p>
<h2 id="2-1-Index-A-Single-Model"><a href="#2-1-Index-A-Single-Model" class="headerlink" title="2.1 Index A Single Model"></a>2.1 Index A Single Model</h2><p>Assume that we inject <code>IElasticClient</code> to our services as <code>_client</code>. Then we can simply index a model with <code>Index</code> or its async brother. It is preferred to set the index name manually if you have multiple indices. The ID is not required, as Elasticsearch can create it for you automatically.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.IndexAsync&lt;ElasticModel&gt;(model, op =&gt; op</span><br><span class="line">    .Index(type)</span><br><span class="line">    .Id(model.Id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<div class="note info flat"><p>You don’t need to create the index first, as Elasticsearch will automatically create it if the index does not exist before.</p>
</div>

<h2 id="2-2-Bulk-Index-Models"><a href="#2-2-Bulk-Index-Models" class="headerlink" title="2.2 Bulk Index Models"></a>2.2 Bulk Index Models</h2><p>For data that comes in large scales, we may need to bulk index them. Luckily, NEST provides us with <code>BulkDescriptor</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bulkDescriptor = <span class="keyword">new</span> BulkDescriptor();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> model <span class="keyword">in</span> models)</span><br><span class="line">&#123;</span><br><span class="line">    bulkDescriptor.Index&lt;ElasticModel&gt;(op =&gt; op</span><br><span class="line">        .Document(model)</span><br><span class="line">        .Id(model.Id)</span><br><span class="line">        .Index(<span class="string">&quot;demo&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">await</span> _client.BulkAsync(bulkDescriptor);</span><br></pre></td></tr></table></figure>

<p>Note that the return value of bulk operation is always success, but individual operation may fail.</p>
<div class="note info flat"><p>To improve the performance of your application in such scenario with heavy indexing or updating tasks, see <a href="/posts/Bulk-Task-Optimization-in-C/">Bulk Task Optimization in C#</a>.</p>
</div>

<hr>
<h1 id="3-Let-the-Search-Begin"><a href="#3-Let-the-Search-Begin" class="headerlink" title="3. Let the Search Begin!"></a>3. Let the Search Begin!</h1><p>NEST provides strongly typed requests and responses for Elasticsearch APIs, so it is quite easy for us to do search stuffs. However, it is more like translating RESTful API to NEST API. So you can refer to the official documentation for searching with RESTful API <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.11/search-search.html">Search API</a>.</p>
<p>Basically, it is easy to change between these two types of API, but there are some cases when the translation is not that obvious, which are what I’m going to talk about.</p>
<h2 id="3-1-Basic-Search"><a href="#3-1-Basic-Search" class="headerlink" title="3.1 Basic Search"></a>3.1 Basic Search</h2><h3 id="3-1-1-Search-with-ID"><a href="#3-1-1-Search-with-ID" class="headerlink" title="3.1.1 Search with ID"></a>3.1.1 Search with ID</h3><p>First of all, you should inject <code>IElasticClient</code> to your service. Suppose it is called <code>_client</code>.</p>
<p>Let’s start with searching by ID. In any search, we should specify which index we’re going to search. As ID is fixed, there’s no need for partial or even fuzzy match, we just need to use <code>Term</code> query, which will not analyze words.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;ElasticModel&gt;&gt; GetModelsById(IEnumerable&lt;<span class="built_in">string</span>&gt; ids)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">var</span> container = <span class="keyword">new</span> QueryContainer();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> id <span class="keyword">in</span> ids)</span><br><span class="line">    &#123;</span><br><span class="line">        container |= <span class="keyword">new</span> QueryContainerDescriptor&lt;ElasticModel&gt;()</span><br><span class="line">            .Term(m =&gt; m.Field(f =&gt; f.Id).Value(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ISearchResponse&lt;ElasticModel&gt; response = <span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">        .Index(<span class="string">&quot;demo&quot;</span>).Query(q =&gt; q.Bool(b =&gt; b.Should(container))));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.IsValid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SearchException(response.DebugInformation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response.Documents.ToList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, we use <code>Documents</code> in <code>response</code>. Astute readers will note that in RESTful API, the results are in hits, and NEST does provide <code>response.Hits</code> field for all hit results. So what’s the difference?</p>
<p>To put it simple, elements in <code>Hits</code> represents the hits list in RESTful response, which include extra fields, like <code>Score</code>. However, <code>Documents</code> only contain <code>_source</code> filed.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hits<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;works&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12346&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">12346</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Design Pattern&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GoF patterns&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;updated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-11-18T14:14:06&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-Search-with-many-conditions"><a href="#3-1-2-Search-with-many-conditions" class="headerlink" title="3.1.2 Search with  many conditions"></a>3.1.2 Search with  many conditions</h3><p>Here, we get all models whose ID is in a given list. In this case, a better solution is to build a query container, and add all id matches as single queries. So here is how it works. It is actually a logic query, see <a href="#3-5-Logic-Operator">Logic Operator</a>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;ElasticModel&gt;&gt; GetModelsById(IEnumerable&lt;<span class="built_in">string</span>&gt; words)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">var</span> container = <span class="keyword">new</span> QueryContainer();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> id <span class="keyword">in</span> ids)</span><br><span class="line">    &#123;</span><br><span class="line">        container |= <span class="keyword">new</span> QueryContainerDescriptor&lt;ElasticModel&gt;()</span><br><span class="line">            .Term(m =&gt; m.Field(f =&gt; f.Name).Value(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ISearchResponse&lt;ElasticModel&gt; response = <span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">        .Index(<span class="string">&quot;demo&quot;</span>).Query(q =&gt; q.Bool(b =&gt; b.Should(container))));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.IsValid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SearchException(response.DebugInformation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response.Documents.ToList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It’s a little tricky that <code>QueryContainer</code> uses operator overload to achieve “OR” or “AND” operation, instead of a method.</p>
<div class="note success flat"><p>In order to expose high level API, NEST seems to use many “descriptors” when constructing requests.</p>
</div>

<h2 id="3-2-Fuzzy-Match"><a href="#3-2-Fuzzy-Match" class="headerlink" title="3.2 Fuzzy Match"></a>3.2 Fuzzy Match</h2><p>One of Elasticsearch’s advantages is that it supports fuzzy search. To use fuzzy search, you should use <code>Match</code> query instead of <code>Term</code>, and set fuzziness manually. Here the fuzziness is defined as Levenshtein Edit distance (or number of edits). Supported distances are 0, 1, 2.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">            .Index(<span class="string">&quot;demo&quot;</span>)</span><br><span class="line">            .Query(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Description)</span><br><span class="line">                .Query(<span class="string">&quot;algorihm&quot;</span>).Fuzziness(Fuzziness.EditDistance(<span class="number">1</span>)))));</span><br></pre></td></tr></table></figure>

<div class="note info flat"><p>Get use to <code>))))...)</code> with NEST. 🤭</p>
</div>

<h2 id="3-3-Pagination"><a href="#3-3-Pagination" class="headerlink" title="3.3 Pagination"></a>3.3 Pagination</h2><p>Of course, Elasticsearch supports pagination, but with <code>from</code> and <code>size</code>. It is easy to convert page and page size to from and size. Here, we assume that page starts from 0.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">            .Index(<span class="string">&quot;index name&quot;</span>)</span><br><span class="line">            .From(page * pageSize)</span><br><span class="line">            .Size(pageSize)</span><br><span class="line">            <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<div class="note danger flat"><p>You shouldn’t use pagination to iterate through all data! By default, Elasticsearch allow maximum 10000 records to be returned, which means <code>from</code> + <code>size</code> should less than 10000. To do this, use <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scroll-api.html">Scroll API</a> instead.</p>
</div>

<h2 id="3-4-Sorting"><a href="#3-4-Sorting" class="headerlink" title="3.4 Sorting"></a>3.4 Sorting</h2><p>Well, sorting is relatively simpler. Just specify the field and order in search.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">            .Index(<span class="string">&quot;index name&quot;</span>)</span><br><span class="line">            .From(page * pageSize)</span><br><span class="line">            .Size(pageSize)</span><br><span class="line">            .Sort(m =&gt; m.Field(f =&gt; f.Updated, SortOrder.Descending))</span><br><span class="line">            .Query(<span class="comment">/* ... */</span>);</span><br></pre></td></tr></table></figure>

<h2 id="3-5-Logic-Operator"><a href="#3-5-Logic-Operator" class="headerlink" title="3.5 Logic Operator"></a>3.5 Logic Operator</h2><p>Elasticsearch support logic AND, OR and NOT in query. To do this, we only need a bool query.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">    .Index(<span class="string">&quot;demo&quot;</span>)</span><br><span class="line">    .From(dto.Page * dto.PageSize)</span><br><span class="line">    .Size(dto.PageSize)</span><br><span class="line">    .Query(q =&gt; q.Bool(b =&gt; b</span><br><span class="line">        .Must(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">&quot;hello&quot;</span>)))</span><br><span class="line">        .Should(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">&quot;there&quot;</span>)))</span><br><span class="line">        .MustNot(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">&quot;General&quot;</span>)))));</span><br></pre></td></tr></table></figure>

<p><code>Must</code> is AND, <code>Should</code> is OR, and <code>MustNot</code> is NOT.</p>
<hr>
<h1 id="Appendix-Some-Tricks"><a href="#Appendix-Some-Tricks" class="headerlink" title="Appendix: Some Tricks"></a>Appendix: Some Tricks</h1><h2 id="A-Dynamic-Field"><a href="#A-Dynamic-Field" class="headerlink" title="A. Dynamic Field"></a>A. Dynamic Field</h2><p>For common queries, flexibility may be the biggest concern. For example, we may need to dynamically change the field we want to search based on the request parameter. So here is how we change field based on query.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Expression&lt;Func&lt;ElasticModel, <span class="built_in">string</span>&gt;&gt;? GetField(<span class="built_in">string</span> field)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> field <span class="keyword">switch</span> &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> =&gt; w =&gt; w.Name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span> =&gt; w =&gt; w.Description,</span><br><span class="line">        _ =&gt; <span class="literal">null</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We have to return <code>Expression</code> instead of <code>Func</code>, as <code>Func</code> cannot be converted into <code>Expresesion</code> directly. We can only initiate Linq expression with a lambda.</p>
<p>With this, we can achieve dynamic field in query. You may need to check null before pass it to <code>Field</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q.Match(m =&gt; m.Field(GetField(<span class="string">&quot;name&quot;</span>)).Query(cond.Value))</span><br></pre></td></tr></table></figure>

<h2 id="B-Complex-Condition"><a href="#B-Complex-Condition" class="headerlink" title="B. Complex Condition"></a>B. Complex Condition</h2><p>When we do logic operations, the condition may not be fixed. So there’s a problem of constructing the bool query. Here is an example of build flexible bool query.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BoolQueryDescriptor&lt;ElasticModel&gt; <span class="title">ConstructQueryDescriptor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    BoolQueryDescriptor&lt;ElasticModel&gt; descriptor</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    descriptor = descriptor.Must(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">&quot;hello&quot;</span>)));</span><br><span class="line">    descriptor = descriptor.Should(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">&quot;there&quot;</span>)));</span><br><span class="line">    descriptor = descriptor.MustNot(q =&gt; q.Match(m =&gt; m.Field(f =&gt; f.Name).Query(<span class="string">&quot;General&quot;</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>With this, you can simply call this function in bool query.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> _client.SearchAsync&lt;ElasticModel&gt;(s =&gt; s</span><br><span class="line">    .Index(<span class="string">&quot;demo&quot;</span>)</span><br><span class="line">    .From(dto.Page * dto.PageSize)</span><br><span class="line">    .Size(dto.PageSize)</span><br><span class="line">    .Query(q =&gt; q.Bool(b =&gt; ConstructQueryDescriptor(b)));</span><br></pre></td></tr></table></figure>

<p>The same goes with other types of queries.</p>
<hr>
<h1 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h1><p>It is really easy to communicate with Elasticsearch with NEST. The APIs are overall, natural to use and understand. Just so much better than it in Python, which does not have any type at all, thus lacks productivity.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://tonys-studio.top">Tony Lewis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/">https://blog.tonys-studio.top/posts/Empower-ASP-NET-Core-with-Elasticsearch/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Tutorial/">Tutorial</a><a class="post-meta__tags" href="/tags/ASP-NET-Core/">ASP.NET Core</a><a class="post-meta__tags" href="/tags/Elasticsearch/">Elasticsearch</a><a class="post-meta__tags" href="/tags/Kibana/">Kibana</a><a class="post-meta__tags" href="/tags/NEST/">NEST</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Windows-File-Explorer-Performance-Issue-with-PDF/" title="Windows File Explorer Performance Issue With PDF"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/24/09.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Windows File Explorer Performance Issue With PDF</div></div><div class="info-2"><div class="info-item-1">Troubleshoot Windows File Explorer performance issue with PDF files</div></div></div></a><a class="pagination-related" href="/posts/Bulk-Task-Optimization-in-C/" title="Bulk Task Optimization in C#"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/05/07.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Bulk Task Optimization in C#</div></div><div class="info-2"><div class="info-item-1">Optimize bulk task in C# using async/wait.</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Setup-Elasticsearch-with-Kibana/" title="Setup Elasticsearch With Kibana"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/05.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Dec. 10th, 2023 - 11:11:26</div><div class="info-item-2">Setup Elasticsearch With Kibana</div></div><div class="info-2"><div class="info-item-1">Setup Elasticsearch with Kibana on Ubuntu server.</div></div></div></a><a class="pagination-related" href="/posts/Ingest-Data-from-MySQL-to-Elasticsearch/" title="Ingest Data From MySQL to Elasticsearch"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/22/03.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Dec. 11th, 2023 - 16:03:43</div><div class="info-item-2">Ingest Data From MySQL to Elasticsearch</div></div><div class="info-2"><div class="info-item-1">Using Logstash to sync MySQL and Elasticsearch</div></div></div></a><a class="pagination-related" href="/posts/AOP-in-Spring-Boot/" title="AOP in Spring Boot"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/09.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jul. 12th, 2024 - 11:26:45</div><div class="info-item-2">AOP in Spring Boot</div></div><div class="info-2"><div class="info-item-1">Concept and application of Aspect-oriented programming in Spring Boot</div></div></div></a><a class="pagination-related" href="/posts/Create-sudo-enabled-User-on-Linux/" title="Create Sudo-Enabled User on Linux"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/04/07.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Feb. 1st, 2024 - 13:36:29</div><div class="info-item-2">Create Sudo-Enabled User on Linux</div></div><div class="info-2"><div class="info-item-1">Create sudo-enabled user on Ubuntu 20.04</div></div></div></a><a class="pagination-related" href="/posts/Deploy-MySQL-on-Linux-Server/" title="Deploy MySQL on Linux Server"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/02/08.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 27th, 2023 - 22:59:00</div><div class="info-item-2">Deploy MySQL on Linux Server</div></div><div class="info-2"><div class="info-item-1">Deploy MySQL server on Ubuntu Server</div></div></div></a><a class="pagination-related" href="/posts/Getting-Started-with-CUDA/" title="Getting Started With CUDA"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/02/01.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 4th, 2024 - 14:05:56</div><div class="info-item-2">Getting Started With CUDA</div></div><div class="info-2"><div class="info-item-1">Take your first step into CUDA&reg; to unleash the power of your GPU!</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="author-info-name">Tony Lewis</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">92</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It won't be long before the armies of the Republic track us here.<br>You can visit this site at both:<li><a href="http://blog.tonys-studio.top/" target="_blank">Main Site</a></li><li><a href="https://lord-turmoil.github.io/" target="_blank">Github Mirror Site</a></li></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prologue"><span class="toc-text">Prologue</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Setup-the-Project"><span class="toc-text">1. Setup the Project</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Install-NuGet-Package"><span class="toc-text">1.1 Install NuGet Package</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Add-Dependency-Injection"><span class="toc-text">1.2 Add Dependency Injection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Connection-Settings"><span class="toc-text">1.3 Connection Settings</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-Basic-Authentication"><span class="toc-text">1.3.1 Basic Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-Some-More-Options"><span class="toc-text">1.3.2 Some More Options</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Index-Document"><span class="toc-text">2. Index Document</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Creating-Models-for-Elasticsearch"><span class="toc-text">2.1 Creating Models for Elasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Index-A-Single-Model"><span class="toc-text">2.1 Index A Single Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Bulk-Index-Models"><span class="toc-text">2.2 Bulk Index Models</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Let-the-Search-Begin"><span class="toc-text">3. Let the Search Begin!</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Basic-Search"><span class="toc-text">3.1 Basic Search</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-Search-with-ID"><span class="toc-text">3.1.1 Search with ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-Search-with-many-conditions"><span class="toc-text">3.1.2 Search with  many conditions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Fuzzy-Match"><span class="toc-text">3.2 Fuzzy Match</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Pagination"><span class="toc-text">3.3 Pagination</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Sorting"><span class="toc-text">3.4 Sorting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-Logic-Operator"><span class="toc-text">3.5 Logic Operator</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Appendix-Some-Tricks"><span class="toc-text">Appendix: Some Tricks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Dynamic-Field"><span class="toc-text">A. Dynamic Field</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B-Complex-Condition"><span class="toc-text">B. Complex Condition</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Epilogue"><span class="toc-text">Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/13/08.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Getting Started With Coq"/></a><div class="content"><a class="title" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq">Getting Started With Coq</a><time datetime="2025-08-08T04:30:12.000Z" title="Created Aug. 8th, 2025 - 12:30:12 12:30:12">Aug. 8th, 2025 - 12:30:12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-02-Something-on-the-Screen/" title="Game Engine 0 to 1 (02): Something on the Screen"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/02/07.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Game Engine 0 to 1 (02): Something on the Screen"/></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-02-Something-on-the-Screen/" title="Game Engine 0 to 1 (02): Something on the Screen">Game Engine 0 to 1 (02): Something on the Screen</a><time datetime="2025-07-04T12:07:57.000Z" title="Created Jul. 4th, 2025 - 20:07:57 20:07:57">Jul. 4th, 2025 - 20:07:57</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-01-It-Starts-Now/" title="Game Engine 0 to 1 (01): It Starts Now"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/05/05.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Game Engine 0 to 1 (01): It Starts Now"/></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-01-It-Starts-Now/" title="Game Engine 0 to 1 (01): It Starts Now">Game Engine 0 to 1 (01): It Starts Now</a><time datetime="2025-06-01T06:45:32.000Z" title="Created Jun. 1st, 2025 - 14:45:32 14:45:32">Jun. 1st, 2025 - 14:45:32</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-00-Nothing-s-Here/" title="Game Engine 0 to 1 (00): Nothing's Here"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/07/13.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Game Engine 0 to 1 (00): Nothing's Here"/></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-00-Nothing-s-Here/" title="Game Engine 0 to 1 (00): Nothing's Here">Game Engine 0 to 1 (00): Nothing's Here</a><time datetime="2025-05-27T11:05:29.000Z" title="Created May. 27th, 2025 - 19:05:29 19:05:29">May. 27th, 2025 - 19:05:29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Demystifying-NAT-in-P2P/" title="Demystifying NAT in P2P"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/07/03.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Demystifying NAT in P2P"/></a><div class="content"><a class="title" href="/posts/Demystifying-NAT-in-P2P/" title="Demystifying NAT in P2P">Demystifying NAT in P2P</a><time datetime="2025-04-25T08:36:44.000Z" title="Created Apr. 25th, 2025 - 16:36:44 16:36:44">Apr. 25th, 2025 - 16:36:44</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/07.jpeg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2025 By Tony Lewis</span></div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://comment.tonys-studio.top',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      comment: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Anything you would like to search?🔍" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="Framework Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="Theme Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly%205.3.3-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally." title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>