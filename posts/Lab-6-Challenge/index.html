<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lab 6 Challenge | TONY'S STUDIO</title><meta name="author" content="Tony Skywalker"><meta name="copyright" content="Tony Skywalker"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Lab 6 Challenge - A More Powerful Shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Lab 6 Challenge">
<meta property="og:url" content="https://blog.tonys-studio.top/posts/Lab-6-Challenge/">
<meta property="og:site_name" content="TONY&#39;S STUDIO">
<meta property="og:description" content="Lab 6 Challenge - A More Powerful Shell">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/11.jpeg">
<meta property="article:published_time" content="2023-06-18T15:28:24.000Z">
<meta property="article:modified_time" content="2025-08-08T04:35:31.573Z">
<meta property="article:author" content="Tony Skywalker">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="BUAA">
<meta property="article:tag" content="Shell">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/11.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lab 6 Challenge",
  "url": "https://blog.tonys-studio.top/posts/Lab-6-Challenge/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/11.jpeg",
  "datePublished": "2023-06-18T15:28:24.000Z",
  "dateModified": "2025-08-08T04:35:31.573Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Skywalker",
      "url": "https://tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Lab-6-Challenge/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="codeva-R6O16YoeQt"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#300303')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "h2swkizghx");</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":10,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":256,"languages":{"author":"Author: Tony Skywalker","link":"Link: ","source":"Source: TONY'S STUDIO","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#871798","bgDark":"#C81025","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lab 6 Challenge',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.6/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/css/barber-shop.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/back_img.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">92</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/11.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Lab 6 Challenge</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lab 6 Challenge</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-06-18T15:28:24.000Z" title="Created Jun. 18th, 2023 - 23:28:24 23:28:24">Jun. 18th, 2023 - 23:28:24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-08T04:35:31.573Z" title="Updated Aug. 8th, 2025 - 12:35:31 12:35:31">Aug. 8th, 2025 - 12:35:31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/">BUAA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/OS/">OS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>12mins</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Lab-6-Challenge/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Lab-6-Challenge/#post-comment"><span class="waline-comment-count" data-path="/posts/Lab-6-Challenge/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="BUAA-2023-Spring-OS"><a href="#BUAA-2023-Spring-OS" class="headerlink" title="BUAA 2023 Spring OS"></a>BUAA 2023 Spring OS</h1><img src="/posts/Lab-6-Challenge/image-20230618215842372.png" alt="image-20230618215842372" style="zoom: 80%;">

<p>Primary architecture based on <a target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil/PassBashPro">PassBash</a>. Code available at:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil/2023-Spring-OS/tree/lab6-challenge">GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/tonys-studio/2023-spring-os/tree/lab6-challenge/">Gitee</a></li>
</ul>
<p>Copyright © Tony’s Studio 2023</p>
<hr>
<h1 id="1-Overall-Design"><a href="#1-Overall-Design" class="headerlink" title="1. Overall Design"></a>1. Overall Design</h1><h2 id="1-1-Demand-Analysis"><a href="#1-1-Demand-Analysis" class="headerlink" title="1.1 Demand Analysis"></a>1.1 Demand Analysis</h2><p>The guiding book may differ each year, and right now, as I’m writing, is 2023. However, the basic requirements for a Shell 🐚  are generally the same.</p>
<ol>
<li>Friendly user interaction.</li>
<li>Command &amp; <del>Conquer</del> argument parsing.</li>
<li>Job scheduling.</li>
</ol>
<p>I think the first one is quite comprehensive, since it is always difficult to provide better user experiences. Here, my understanding of a friendly Shell is that it must at least support free editing, history command and, completion perhaps.</p>
<p>So, I implemented Pash, with primary features as follows.</p>
<ol>
<li>Free editing experience. Not only direction key, but also Home, End, Delete, even Ctrl.</li>
<li>Enhanced user experience. Provide clear error info, support command history, and auto-completion on Tab.</li>
<li>Complete redirection. Add support for <code>&gt;&gt;</code>.</li>
<li>Beautiful interface with ANSI colors.</li>
<li>Clean and tidy directory structure.</li>
</ol>
<h2 id="1-2-Architecture"><a href="#1-2-Architecture" class="headerlink" title="1.2 Architecture"></a>1.2 Architecture</h2><p>The original shell looks like this.</p>
<img src="/posts/Lab-6-Challenge/shell_old.svg" alt="shell_old" style="zoom:80%;">

<p>And Pash, is like this. Only better. With internal command and external command unified, we can parse them altogether, and enable redirection and pipe for internal commands.</p>
<p><img src="/posts/Lab-6-Challenge/shell_new.svg" alt="shell_new"></p>
<p>Here is another figure showing all modules of Pash.</p>
<p><img src="/posts/Lab-6-Challenge/module.svg" alt="module"></p>
<hr>
<h1 id="2-Implementation"><a href="#2-Implementation" class="headerlink" title="2. Implementation"></a>2. Implementation</h1><blockquote>
<p>All functions that are exclusive to Pash are declared in <code>user/include/pash.h</code>, and the definition of Pash is in <code>user/pash.c</code>, while auxiliary functions and other modules are in <code>user/lib/pashlib.c</code>.</p>
</blockquote>
<h2 id="2-1-Input-Module"><a href="#2-1-Input-Module" class="headerlink" title="2.1 Input Module"></a>2.1 Input Module</h2><h3 id="2-1-1-Raw-Input"><a href="#2-1-1-Raw-Input" class="headerlink" title="2.1.1 Raw Input"></a>2.1.1 Raw Input</h3><p>Input module is what I considered most well designed. It is powerful and flexible. For low-level input, it uses <code>getch</code> function that is similar to function with the same name in Windows <code>conio.h</code>. It rely on a system call.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/syscall_all.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_getch</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> scancharc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// user/lib/syscall_lib.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">syscall_getch</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ch = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((ch = msyscall(SYS_getch)) == <span class="number">0</span>)</span><br><span class="line">        syscall_yield();</span><br><span class="line">    <span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-Input-Recognition"><a href="#2-1-2-Input-Recognition" class="headerlink" title="2.1.2 Input Recognition"></a>2.1.2 Input Recognition</h3><p>Well, in MOS, special keys are in form of ANSI code, just like what in Linux. So it could be a little annoying to recognize these keys. However, with finite state machine, it would be a problem no more. The state machine looks just like what is shown below, but some layers are omitted since there is only one node in those layers. Each leaf node is registered with a event handler corresponding to the input, and non-leaf node with a handler to determine the next node.</p>
<p><img src="/posts/Lab-6-Challenge/lab6-challenge-input.svg" alt="lab6-challenge-input"></p>
<p>Well, in code, this state machine consists of these two types of functions. And to maintain a consistent input state, I use a input context structure. <code>input_opt_t</code> will be elaborated later.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/pashlib.c</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> <span class="type">_input_action_t</span>(<span class="type">const</span> <span class="type">input_opt_t</span>* opt, <span class="type">input_ctx_t</span>* ctx);</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> <span class="type">_input_handler_t</span>(<span class="type">const</span> <span class="type">input_opt_t</span>* opt, <span class="type">input_ctx_t</span>* ctx);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">input_ctx_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span>* buffer; <span class="comment">// input buffer</span></span><br><span class="line">    <span class="type">int</span> pos;      <span class="comment">// current cursor position</span></span><br><span class="line">    <span class="type">int</span> length;   <span class="comment">// total input length</span></span><br><span class="line">    <span class="type">int</span> ch;	      <span class="comment">// next character to put into buffer</span></span><br><span class="line">    <span class="type">int</span> index;    <span class="comment">// current history record index</span></span><br><span class="line">    <span class="type">int</span> count;    <span class="comment">// total number of history records</span></span><br><span class="line">&#125; <span class="type">input_ctx_t</span> __attribute__((aligned(<span class="number">32</span>)));</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Important:</strong> One thing to notice is that, for this struct, we have to use <code>__attribute__((aligned(32)))</code>, or unexpected error will raise. It is sure to be a problem of byte alignment, but I could not explain it yet.</p>
</blockquote>
<h3 id="2-1-3-Input-Options"><a href="#2-1-3-Input-Options" class="headerlink" title="2.1.3 Input Options"></a>2.1.3 Input Options</h3><p>One of the primary features of this input module is that is support custom options. This is the part I’m most satisfied with.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">input_history_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> (*init)(<span class="type">int</span>*);           <span class="comment">// initialize number of history records</span></span><br><span class="line">    <span class="type">int</span> (*append)(<span class="type">const</span> <span class="type">char</span>*);  <span class="comment">// append new history record</span></span><br><span class="line">    <span class="type">int</span> (*get)(<span class="type">int</span>, <span class="type">char</span>*);      <span class="comment">// get specific history record</span></span><br><span class="line">&#125; <span class="type">input_history_t</span> __attribute__((aligned(<span class="number">16</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// current input, completion, revert distance</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*<span class="type">input_competer_t</span>)</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">char</span>*, <span class="type">int</span>*)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">input_opt_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> minLen;                  <span class="comment">// minimum input length</span></span><br><span class="line">    <span class="type">int</span> maxLen;                  <span class="comment">// maximum input length</span></span><br><span class="line">    <span class="type">int</span> interruptible;           <span class="comment">// whether can be interrupted if minimum length not satisfied</span></span><br><span class="line">    <span class="type">input_history_t</span>* history;    <span class="comment">// history service callback</span></span><br><span class="line">    <span class="type">input_completer_t</span> completer; <span class="comment">// completion service callback</span></span><br><span class="line">&#125; <span class="type">input_opt_t</span> __attribute__((aligned(<span class="number">32</span>)));</span><br></pre></td></tr></table></figure>

<p>Here, I’d like to show you some examples. Expand it as you wish.</p>
<details class="toggle"><summary class="toggle-button" style>Input Option Example</summary><div class="toggle-content"><p>This is a piece of code extracted from history handling part of input. Some extra checks are removed to reduce passage length.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// command starts with white space will not be saved (like Linux)</span></span><br><span class="line"><span class="keyword">if</span> (opt.history &amp;&amp; (!(*buffer == <span class="string">&#x27;\0&#x27;</span> || *buffer == <span class="string">&#x27; &#x27;</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    strstripr(buffer, <span class="string">&#x27; &#x27;</span>);                <span class="comment">// remove trailing white spaces</span></span><br><span class="line">    <span class="keyword">if</span> (!is_the_same(buffer, last_record)) <span class="comment">// do not record repeated command</span></span><br><span class="line">    &#123;</span><br><span class="line">        opt.history-&gt;append(buffer);</span><br><span class="line">        <span class="built_in">strcpy</span>(last_record, buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And another one is about completion. It is registered to Tab key.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> _input_tab(<span class="type">const</span> <span class="type">input_opt_t</span>* opt, <span class="type">input_ctx_t</span>* ctx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!opt-&gt;completer)  <span class="comment">// no completion service registered</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[MAXPATHLEN];</span><br><span class="line">    <span class="type">int</span> revert;</span><br><span class="line">    <span class="type">int</span> ret = opt-&gt;completer(ctx-&gt;buffer, buffer, &amp;revert);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>)  <span class="comment">// no available completions</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    _input_end(opt, ctx);  <span class="comment">// set cursor to the end of input</span></span><br><span class="line">    <span class="keyword">while</span> (revert-- &gt; <span class="number">0</span>)</span><br><span class="line">        _input_backspace(opt, ctx);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* completion = buffer;</span><br><span class="line">    <span class="keyword">while</span> (*completion)</span><br><span class="line">    &#123;</span><br><span class="line">        ctx-&gt;ch = *completion;</span><br><span class="line">        _input_char(opt, ctx);</span><br><span class="line">        completion++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<blockquote>
<p>For the concrete implementation of history and completion service, please refer to my git repository. 😉</p>
</blockquote>
<h2 id="2-2-Command-Resolving"><a href="#2-2-Command-Resolving" class="headerlink" title="2.2 Command Resolving"></a>2.2 Command Resolving</h2><h3 id="2-2-1-Command-Parsing"><a href="#2-2-1-Command-Parsing" class="headerlink" title="2.2.1 Command Parsing"></a>2.2.1 Command Parsing</h3><p>Basic command parsing remains almost the same. However, it no longer do this in a forked child process. And the execution flow changes slightly for <code>;</code> and <code>&amp;</code> support. Mainly use <code>hasNext</code> and <code>needWait</code> flags to tell Shell to continue parsing, or end. Here, I only showed code essentially related to <code>;</code> and <code>&amp;</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> _runcmd(<span class="type">char</span>* cmd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> hasNext;</span><br><span class="line">    <span class="type">int</span> needWait;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        hasNext = <span class="number">0</span>;</span><br><span class="line">        needWait = <span class="number">1</span>;</span><br><span class="line">        ret = _parsecmd(cmd, &amp;argc, argv, &amp;rightpipe);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)       <span class="comment">// ; or &amp;</span></span><br><span class="line">        &#123;</span><br><span class="line">            hasNext = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (ret == <span class="number">2</span>)  <span class="comment">// &amp;</span></span><br><span class="line">                needWait = <span class="number">0</span>;</span><br><span class="line">            cmd = <span class="literal">NULL</span>;	 <span class="comment">// next turn will continue parse on previous cmd</span></span><br><span class="line">        &#125;</span><br><span class="line">        argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">int</span> child = _execv(argv[<span class="number">0</span>], argv);</span><br><span class="line">        <span class="keyword">if</span> ((child &gt; <span class="number">0</span>) &amp;&amp; needWait)</span><br><span class="line">            wait(child);</span><br><span class="line">        <span class="keyword">if</span> (rightpipe)</span><br><span class="line">            wait(rightpipe);</span><br><span class="line">    &#125; <span class="keyword">while</span> (hasNext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> _parsecmd(<span class="type">char</span>* cmd, <span class="type">int</span>* argc, <span class="type">char</span>* argv[], <span class="type">int</span>* rightpipe)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (; ; )</span><br><span class="line">    &#123;</span><br><span class="line">        type = get_token(<span class="literal">NULL</span>, &amp;token);</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> TK_SEMI_COLON:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">case</span> TK_AMPERSAND:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, the process of getting token in command also uses a state machine. (It is a good thing.)</p>
<img src="/posts/Lab-6-Challenge/lab6-challenge-parse.svg" alt="lab6-challenge-parse" style="zoom:80%;">

<h3 id="2-2-2-Command-Execution"><a href="#2-2-2-Command-Execution" class="headerlink" title="2.2.2 Command Execution"></a>2.2.2 Command Execution</h3><p>After parsing, shell will then execute the command. Here, both internal and external command are first handled in <code>_execv</code> of Pash itself. If it is not a internal command, Pash will use library function <code>execv</code> to execute the command.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/pash.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> _execv(<span class="type">char</span>* cmd, <span class="type">char</span>* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = execvi(cmd, argv);  <span class="comment">// return -1 if internal command not exists</span></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> execv(cmd, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// user/lib/lib.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> prog[<span class="number">1024</span>] = <span class="string">&quot;/bin/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strchr</span>(path, <span class="string">&#x27;/&#x27;</span>))  <span class="comment">// user directory to call command</span></span><br><span class="line">        <span class="built_in">strcpy</span>(prog, path);</span><br><span class="line">    <span class="keyword">else</span>                    <span class="comment">// default command will be looked up in /bin</span></span><br><span class="line">        <span class="built_in">strcat</span>(prog, path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_ends_with(prog, <span class="string">&quot;.sh&quot;</span>))	<span class="comment">// auto-recognize .sh script</span></span><br><span class="line">        <span class="keyword">return</span> execl(<span class="string">&quot;pash&quot;</span>, <span class="string">&quot;pash&quot;</span>, prog, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!is_ends_with(prog, <span class="string">&quot;.b&quot;</span>))  <span class="comment">// auto-complete .b extention</span></span><br><span class="line">        <span class="built_in">strcat</span>(prog, <span class="string">&quot;.b&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> spawn(prog, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-Patch-for-Redirection"><a href="#2-2-3-Patch-for-Redirection" class="headerlink" title="2.2.3 Patch for Redirection"></a>2.2.3 Patch for Redirection</h3><p>Since we moved command parsing in Pash process, and internal command also support redirection, so Pash it self will be affected by commands with redirection and pipe. Therefore, the standard input and output must be reset after the execution of these commands.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/pash.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!interactive)  <span class="comment">// backup original I/O</span></span><br><span class="line">    &#123;</span><br><span class="line">        backupfd[<span class="number">0</span>] = dup(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">        panic_on(backupfd[<span class="number">0</span>] &lt; <span class="number">0</span>);</span><br><span class="line">        backupfd[<span class="number">1</span>] = dup(<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">        panic_on(backupfd[<span class="number">1</span>] &lt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _restore_stream()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!redirect)  <span class="comment">// redirect flag</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!interactive)  <span class="comment">// restore redirected I/O</span></span><br><span class="line">    &#123;</span><br><span class="line">        dup(backupfd[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">        dup(backupfd[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>               <span class="comment">// restore standard console I/O</span></span><br><span class="line">    &#123;</span><br><span class="line">        close(<span class="number">0</span>);</span><br><span class="line">        panic_on(opencons() != <span class="number">0</span>);</span><br><span class="line">        panic_on(dup(<span class="number">0</span>, <span class="number">1</span>) &lt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-4-Argument-Parsing"><a href="#2-2-4-Argument-Parsing" class="headerlink" title="2.2.4 Argument Parsing"></a>2.2.4 Argument Parsing</h3><p>The original MOS uses an argument parsing macro from Plan 9… It is good, but is almost unreadable. So here, I implemented <code>getopt</code> function to resemble the one in Linux. It’s a little long, so just refer to my repository. Here I just give you a simple example of how it is used. (Error handling are removed to reduce passage length.)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/tree.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_args</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line">    <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;dh&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">                dirOnly = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">                showHelp = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;!&#x27;</span>:</span><br><span class="line">                <span class="built_in">strcpy</span>(targetPath, optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">                printfc(ERROR_COLOR, <span class="string">&quot;Unknown parameter \&quot;-%c\&quot;\n&quot;</span>, optopt);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-File-System"><a href="#2-3-File-System" class="headerlink" title="2.3 File System"></a>2.3 File System</h2><h3 id="2-3-1-Present-Working-Directory"><a href="#2-3-1-Present-Working-Directory" class="headerlink" title="2.3.1 Present Working Directory"></a>2.3.1 Present Working Directory</h3><p>This is simple, just place this stuff to PCB is OK.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">char</span> env_pwd[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Then, just implement some functions to handle this.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include/lib.h</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">access</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">int</span> type)</span>; <span class="comment">// type is used to perform extra check if exists</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getcwd</span><span class="params">(<span class="type">char</span>* path)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">chdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kern/syscall_all.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_set_pwd</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(curenv-&gt;env_pwd, path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_get_pwd</span><span class="params">(<span class="type">char</span>* path)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(path, curenv-&gt;env_pwd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-Absolute-Path"><a href="#2-3-2-Absolute-Path" class="headerlink" title="2.3.2 Absolute Path"></a>2.3.2 Absolute Path</h3><p>Once we have complicated path, it comes the problem that, how to get absolute path? It is impossible (at least for not) for a file to get its parent, even worse, we have to deal with path that looks like <code>home/../../opt/./el...</code>. So we have to request file system process to do this for us.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/file.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fullpath</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename, <span class="type">char</span>* path)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> dir[MAXPATHLEN] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">    _make_fullpath(filename, dir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fsipc_fullpath(dir, path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/fs.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">file_fullpath</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">char</span>* fullpath)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> walk_fullpath(path, fullpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Actually, we can get the parent of a <code>struct File</code> using <code>File::f_dir</code>. But I failed to do so in user library function. I didn’t have time to figure out why, perhaps you can do it. 🧐</p>
<p>Anyway, when we only have filename, isn’t it more simpler to directly get the absolute path than open a directory, then traverse its parent?</p>
</blockquote>
<h3 id="2-3-3-Open-Mode"><a href="#2-3-3-Open-Mode" class="headerlink" title="2.3.3 Open Mode"></a>2.3.3 Open Mode</h3><p>To realize <code>&gt;&gt;</code>, and history function, we have to implement <code>O_APPEND</code> mode for opening file, and of course, <code>O_CREAT</code> also. What’s more, a detail when open with <code>O_WRONLY</code>, we should clear the content of the file.</p>
<h2 id="2-4-Extra"><a href="#2-4-Extra" class="headerlink" title="2.4 Extra"></a>2.4 Extra</h2><h3 id="2-4-1-Directory-Structure"><a href="#2-4-1-Directory-Structure" class="headerlink" title="2.4.1 Directory Structure"></a>2.4.1 Directory Structure</h3><p>To make everything in place, I refactored file structure of MOS to resemble Linux. Isn’t it tidy?</p>
<img src="/posts/Lab-6-Challenge/image-20230618230931509.png" alt="image-20230618230931509" style="zoom: 67%;">

<p>And we have to change how we burn files into MOS disk in <code>fs/Makefile</code>.</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FSIMGFILES := rootfs/init.b  \</span><br><span class="line">              rootfs/bin/    \</span><br><span class="line">              rootfs/home/   \</span><br><span class="line">              rootfs/etc/    \</span><br><span class="line">              $(fs-files)</span><br><span class="line"></span><br><span class="line"><span class="section">image: <span class="variable">$(tools_dir)</span>/fsformat</span></span><br><span class="line">    dd if=/dev/zero of=../target/fs.img bs=4096 count=1024 2&gt;/dev/null</span><br><span class="line">    mkdir -p rootfs/home/mos/</span><br><span class="line">    mkdir -p rootfs/bin</span><br><span class="line">    </span><br><span class="line">    cp -vf <span class="variable">$(USERAPPS)</span> -t rootfs/home/mos/</span><br><span class="line">    cp -vf <span class="variable">$(USERBINS)</span> -t rootfs/bin</span><br><span class="line">    mv -vf rootfs/bin/init.b rootfs/init.b</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$(tools_dir)</span>/fsformat ../target/fs.img $<span class="variable">$(printf &#x27;%s\n&#x27; <span class="variable">$(FSIMGFILES)</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-2-User-Profile"><a href="#2-4-2-User-Profile" class="headerlink" title="2.4.2 User Profile"></a>2.4.2 User Profile</h3><p>In Pash, we stored user profile in file, rather than hard code. And uses a library function to get this.</p>
<p><img src="/posts/Lab-6-Challenge/image-20230618231304158.png" alt="image-20230618231304158"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.h</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">profile</span><span class="params">(<span class="type">char</span>* username, <span class="type">char</span>* path, <span class="type">int</span> create)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-3-Colorful-Output"><a href="#2-4-3-Colorful-Output" class="headerlink" title="2.4.3 Colorful Output"></a>2.4.3 Colorful Output</h3><p>Here, we also use ANSI code to output colorful characters. And we wrapped it in <code>printfc</code>. (I renamed previous <code>user/lib/fprintf.c</code> to <code>user/lib/printf.c</code>.)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/printf.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">printfc</span><span class="params">(<span class="type">int</span> color, <span class="type">const</span> <span class="type">char</span>* fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[%dm&quot;</span>, color);	<span class="comment">// set color</span></span><br><span class="line">    va_list ap;</span><br><span class="line">    va_start(ap, fmt);</span><br><span class="line">    <span class="type">int</span> r = <span class="built_in">vfprintf</span>(<span class="number">1</span>, fmt, ap);</span><br><span class="line">    va_end(ap);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);	<span class="comment">// reset color</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// user/include/lib.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK   0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED     1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ...     ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOREGROUND(COLOR) ((COLOR) + 30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BACKGROUND(COLOR) ((COLOR) + 40)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOREGROUND_INTENSE(COLOR) (FOREGROUND(COLOR) + 60)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BACKGROUND_INTENSE(COLOR) (BACKGROUND(COLOR) + 60)</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="3-Epilogue"><a href="#3-Epilogue" class="headerlink" title="3. Epilogue"></a>3. Epilogue</h1><p>Well, I guess this is a general overview of Pash. However, there are a lot pitfalls that I didn’t mention. Some of them were really obscure that I could not fully comprehend. But, it is truly exciting to see Pash running on MOS. 😁</p>
<img src="/posts/Lab-6-Challenge/image-20230618215754490.png" alt="image-20230618215754490" style="zoom: 50%;">

<p style="text-align: center"><i>"When I left you, I was but the learner. Next time, I will be, the master."</i></p>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://tonys-studio.top">Tony Skywalker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Lab-6-Challenge/">https://blog.tonys-studio.top/posts/Lab-6-Challenge/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OS/">OS</a><a class="post-meta__tags" href="/tags/BUAA/">BUAA</a><a class="post-meta__tags" href="/tags/Shell/">Shell</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Lab-6-Reflection/" title="Lab 6 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/11/02.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Lab 6 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 6 - Pipe & Shell</div></div></div></a><a class="pagination-related" href="/posts/Troubleshoot-High-CPU-Usage-by-the-System-Process/" title="Troubleshoot High CPU Usage by the &quot;System&quot; Process"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/10/09.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Troubleshoot High CPU Usage by the "System" Process</div></div><div class="info-2"><div class="info-item-1">Solve high CPU usage caused by improper folder optimization</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/File-System-IPC/" title="File System IPC"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/00.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:57</div><div class="info-item-2">File System IPC</div></div><div class="info-2"><div class="info-item-1">Brief on File System IPC Mechanism</div></div></div></a><a class="pagination-related" href="/posts/Lab-2-Extra-Reflection/" title="Lab 2 Extra Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/02/00.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 6th, 2023 - 19:53:06</div><div class="info-item-2">Lab 2 Extra Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 2 Extra</div></div></div></a><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/05/05.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 20th, 2023 - 17:07:01</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Lab-5-Reflection/" title="Lab 5 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/07.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:42</div><div class="info-item-2">Lab 5 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 5 - File System</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Reflection/" title="Lab 6 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/11/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:19</div><div class="info-item-2">Lab 6 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 6 - Pipe & Shell</div></div></div></a><a class="pagination-related" href="/posts/Page-Directory-Self-Mapping/" title="Page Directory Self Mapping"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/02/08.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Mar. 25th, 2023 - 20:56:35</div><div class="info-item-2">Page Directory Self Mapping</div></div><div class="info-2"><div class="info-item-1">Understanding page directory self mapping</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="author-info-name">Tony Skywalker</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">92</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It won't be long before the armies of the Republic track us here.<br>You can visit this site at both:<li><a href="http://blog.tonys-studio.top/" target="_blank">Main Site</a></li><li><a href="https://lord-turmoil.github.io/" target="_blank">Github Mirror Site</a></li></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BUAA-2023-Spring-OS"><span class="toc-text">BUAA 2023 Spring OS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Overall-Design"><span class="toc-text">1. Overall Design</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Demand-Analysis"><span class="toc-text">1.1 Demand Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Architecture"><span class="toc-text">1.2 Architecture</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Implementation"><span class="toc-text">2. Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Input-Module"><span class="toc-text">2.1 Input Module</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-Raw-Input"><span class="toc-text">2.1.1 Raw Input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-Input-Recognition"><span class="toc-text">2.1.2 Input Recognition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-Input-Options"><span class="toc-text">2.1.3 Input Options</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Command-Resolving"><span class="toc-text">2.2 Command Resolving</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-Command-Parsing"><span class="toc-text">2.2.1 Command Parsing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-Command-Execution"><span class="toc-text">2.2.2 Command Execution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-Patch-for-Redirection"><span class="toc-text">2.2.3 Patch for Redirection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-Argument-Parsing"><span class="toc-text">2.2.4 Argument Parsing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-File-System"><span class="toc-text">2.3 File System</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-Present-Working-Directory"><span class="toc-text">2.3.1 Present Working Directory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-Absolute-Path"><span class="toc-text">2.3.2 Absolute Path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-Open-Mode"><span class="toc-text">2.3.3 Open Mode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Extra"><span class="toc-text">2.4 Extra</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-Directory-Structure"><span class="toc-text">2.4.1 Directory Structure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-User-Profile"><span class="toc-text">2.4.2 User Profile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-Colorful-Output"><span class="toc-text">2.4.3 Colorful Output</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Epilogue"><span class="toc-text">3. Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/07.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Getting Started With Coq"/></a><div class="content"><a class="title" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq">Getting Started With Coq</a><time datetime="2025-08-08T04:30:12.000Z" title="Created Aug. 8th, 2025 - 12:30:12 12:30:12">Aug. 8th, 2025 - 12:30:12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-02-Something-on-the-Screen/" title="Game Engine 0 to 1 (02): Something on the Screen"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/04/08.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Game Engine 0 to 1 (02): Something on the Screen"/></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-02-Something-on-the-Screen/" title="Game Engine 0 to 1 (02): Something on the Screen">Game Engine 0 to 1 (02): Something on the Screen</a><time datetime="2025-07-04T12:07:57.000Z" title="Created Jul. 4th, 2025 - 20:07:57 20:07:57">Jul. 4th, 2025 - 20:07:57</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-01-It-Starts-Now/" title="Game Engine 0 to 1 (01): It Starts Now"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/04.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Game Engine 0 to 1 (01): It Starts Now"/></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-01-It-Starts-Now/" title="Game Engine 0 to 1 (01): It Starts Now">Game Engine 0 to 1 (01): It Starts Now</a><time datetime="2025-06-01T06:45:32.000Z" title="Created Jun. 1st, 2025 - 14:45:32 14:45:32">Jun. 1st, 2025 - 14:45:32</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-00-Nothing-s-Here/" title="Game Engine 0 to 1 (00): Nothing's Here"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/24/06.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Game Engine 0 to 1 (00): Nothing's Here"/></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-00-Nothing-s-Here/" title="Game Engine 0 to 1 (00): Nothing's Here">Game Engine 0 to 1 (00): Nothing's Here</a><time datetime="2025-05-27T11:05:29.000Z" title="Created May. 27th, 2025 - 19:05:29 19:05:29">May. 27th, 2025 - 19:05:29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Demystifying-NAT-in-P2P/" title="Demystifying NAT in P2P"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/13/06.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Demystifying NAT in P2P"/></a><div class="content"><a class="title" href="/posts/Demystifying-NAT-in-P2P/" title="Demystifying NAT in P2P">Demystifying NAT in P2P</a><time datetime="2025-04-25T08:36:44.000Z" title="Created Apr. 25th, 2025 - 16:36:44 16:36:44">Apr. 25th, 2025 - 16:36:44</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/11.jpeg);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By Tony Skywalker</div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://comment.tonys-studio.top',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      comment: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Anything you would like to search?🔍" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="Framework Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="Theme Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly%205.3.3-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally." title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>