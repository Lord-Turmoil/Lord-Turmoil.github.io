<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Lab 2 Extra Reflection | TONY'S STUDIO</title><meta name="author" content="Tony Lewis"><meta name="copyright" content="Tony Lewis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Reflection on 2023 BUAA OS Lab 2 Extra"><meta property="og:type" content="article"><meta property="og:title" content="Lab 2 Extra Reflection"><meta property="og:url" content="https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/"><meta property="og:site_name" content="TONY&#39;S STUDIO"><meta property="og:description" content="Reflection on 2023 BUAA OS Lab 2 Extra"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/24/05.jpeg"><meta property="article:published_time" content="2023-04-06T11:53:06.000Z"><meta property="article:modified_time" content="2026-02-25T11:02:33.253Z"><meta property="article:author" content="Tony Lewis"><meta property="article:tag" content="OS"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/24/05.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lab 2 Extra Reflection",
  "url": "https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/24/05.jpeg",
  "datePublished": "2023-04-06T11:53:06.000Z",
  "dateModified": "2026-02-25T11:02:33.253Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Lewis",
      "url": "https://www.tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//www.clarity.ms"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#300303")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","undefined")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),r=window.matchMedia("(prefers-color-scheme: dark)"),c=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(c.matches)a();else if(r.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}r.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?o():a())})}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a)}(),btf.addGlobalFn("pjaxComplete",()=>{_hmt.push(["_trackPageview",window.location.pathname])},"baidu_analytics")</script><script>!function(t,e,n,c,r,s,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/sthrplbt7c",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,a)}(window,document,"clarity","script")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:3,unescape:!1,pagination:{enable:!0,hitsPerPage:8},languages:{hits_empty:"No results found for: ${query}",hits_stats:"${hits} articles found"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!1,post:!1},runtime:"days",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:256,languages:{author:"Author: Tony Lewis",link:"Link: ",source:"Source: TONY'S STUDIO",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#871798",bgDark:"#C81025",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!1,islazyloadPlugin:!1,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Lab 2 Extra Reflection",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/static/custom.css"><meta name="generator" content="Hexo 8.1.1"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",()=>{Pace.restart()},"pace_restart")</script><link rel="stylesheet" href="/static/barber-shop.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div class="bg-animation" id="web_bg" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/background.png)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/24/05.jpeg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Lab 2 Extra Reflection</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> Back to Home</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lab 2 Extra Reflection</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-04-06T11:53:06.000Z" title="Created Apr. 6th, 2023 - 19:53:06 19:53:06">Apr. 6th, 2023 - 19:53:06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-02-25T11:02:33.253Z" title="Updated Feb. 25th, 2026 - 19:02:33 19:02:33">Feb. 25th, 2026 - 19:02:33</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Course/">Course</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Course/Operating-System-BUAA/">Operating System (BUAA)</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">1.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>10mins</span></span><span class="post-meta-separator">|</span><span data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Lab-2-Extra-Reflection/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Lab-2-Extra-Reflection/#post-comment"><span class="waline-comment-count" data-path="/posts/Lab-2-Extra-Reflection/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><html><head></head><body><h1 id="BUAA-OS-2023-Spring"><a href="#BUAA-OS-2023-Spring" class="headerlink" title="BUAA OS 2023 Spring"></a>BUAA OS 2023 Spring</h1><hr><p>Due to misunderstanding of some concepts and the meaning of some functions, I failed on lab 2 extra. So much thanks to the TA who helped me understand these stuffs. Thus, a reflection here, I have.</p><p>To be honest, the problem is not that difficult, but if you’re not clear with related concepts, you may get into much trouble. So, here I just want to demonstrate some key points of it.</p><p>Here is the original problem description, you can expand it optionally.</p><details class="toggle"><summary class="toggle-button">Problem</summary><div class="toggle-content"><p><img src="/posts/Lab-2-Extra-Reflection/image-20230406202127222.png" alt="image-20230406202127222"></p></div></details><hr><blockquote><p>To get a better understanding of this article, you can refer to my previous post here:</p><ul><li><a href="/posts/Page-Directory-Self-Mapping/">Page Directory Self Mapping</a></li></ul></blockquote><h2 id="Traverse-Page-Table-Entries"><a href="#Traverse-Page-Table-Entries" class="headerlink" title="Traverse Page Table Entries"></a>Traverse Page Table Entries</h2><p>In this problem, to swap in or out a page need a complete traverse of the page table of current process. But why? Why not just a single page? Well, you know, multiple virtual page could be mapped to the same physical address, so we have to make sure all these pages are correctly marked. Therefore, a complete traverse is needed.</p><p>Then, you may ask again, there are so many page table entries, won’t it take too long? Emm… some page directories are not valid, so the page table entries will be skipped.</p><p>So, how do we traverse page table entries?</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Traverse page table entries.</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> PAGE_ENTRY_CNT = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> pdx = <span class="number">0</span>; pdx &lt; PAGE_ENTRY_CNT; pdx++)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (!(pgdir[pdx] &amp; PTE_V))	<span class="comment">// skip invalid page directory entry</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// The address of page table should be kernel address for os access,</span></span><br><span class="line">    <span class="comment">// but the content of page table entry is physical address.</span></span><br><span class="line">    Pte* pgtbl = (Pte*)KADDR(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> ptx = <span class="number">0</span>; ptx &lt; PAGE_ENTRY_CNT; ptx++)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (!(pgtbl[ptx] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        <span class="comment">// operations on valid page table entry</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="Flush-TLB"><a href="#Flush-TLB" class="headerlink" title="Flush TLB"></a>Flush TLB</h2><p>Another point that is difficult to understand is the action to clear old TLB entry. The structure of TLB entry is as follows.</p><img src="/posts/Lab-2-Extra-Reflection/image-20230406204026763.png" alt="image-20230406204026763" style="zoom:67%"><p>VPN is virtual page number, if we takes it out and make low 12 bits zero, it will be the start virtual address of a virtual page. The same goes with PFN, which is Page Frame number, a.k.a. Physical Page number (PPN).</p><p>To invalidate a page directory entry, we actually flush the VPN it mapped to. Yeah, the VPN it mapped to, but how to get it? In <code>pgdir_walk()</code> function, we create or get a page table entry of the given <code>va</code>, which is exactly what we want here. So, again, what does <code>pgdir_walk()</code> really mean?</p><h3 id="pgdir-walk"><a href="#pgdir-walk" class="headerlink" title="pgdir_walk()"></a><code>pgdir_walk()</code></h3><p><del>I found that I didn’t understand this function before.</del> Here is the definition of this tricky function.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Overview:</span></span><br><span class="line"><span class="comment"> *   Given 'pgdir', a pointer to a page directory, 'pgdir_walk' returns a pointer</span></span><br><span class="line"><span class="comment"> *   to the page table entry (with permission PTE_D|PTE_V) for virtual address 'va'.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Pre-Condition:</span></span><br><span class="line"><span class="comment"> *   'pgdir' is a two-level page table structure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Post-Condition:</span></span><br><span class="line"><span class="comment"> *   If we're out of memory, return -E_NO_MEM.</span></span><br><span class="line"><span class="comment"> *   Otherwise, we get the page table entry, store the value of page table entry</span></span><br><span class="line"><span class="comment"> *   to *ppte, and return 0, indicating success.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">pgdir_walk</span><span class="params">(Pde* pgdir, u_long va, <span class="type">int</span> create, Pte** ppte)</span>;</span><br></pre></td></tr></tbody></table></figure><p>Depending on the value of <code>create</code>, we can get the page table entry mapped to virtual address <code>va</code>, or create the missing page table. (Since we use two-level page table, where the second level won’t be created until needed.) And what we used here is the so called VPN, which could be further explained as PDX and PTX. Again, here is a picture of it.</p><img src="/posts/Lab-2-Extra-Reflection/image-20230406205510542.png" alt="image-20230406205510542" style="zoom:67%"><p>Get it? Are we getting it? (By Steve Jobs on iPhone’s release conference.)</p><p>The <code>va</code> here is exactly what we use later in <code>tlb_invalidate()</code>. What? You still don’t know what <code>va</code> is? Just take some time to read the previous post <a href="/posts/Page-Directory-Self-Mapping/">Page Directory Self Mapping</a>.</p><p>So the purpose of <code>pgdir_walk()</code> is just to get the corresponding page table entry of the virtual address <code>va</code>, or create it if not allocated before.</p><h3 id="tlb-invalidate"><a href="#tlb-invalidate" class="headerlink" title="tlb_invalidate()"></a><code>tlb_invalidate()</code></h3><p>Here is the definition of related functions. Now you should know what’s the correct <code>va</code> to pass.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invalidate the TLB entry with specified 'asid' and virtual address 'va'.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">tlb_invalidate</span><span class="params">(u_int asid, u_long va)</span></span><br><span class="line">{</span><br><span class="line">    tlb_out(PTE_ADDR(va) | (asid &lt;&lt; <span class="number">6</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Flush the TLB entry with EntryHi Register set to 'entryhi'.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">tlb_out</span><span class="params">(u_int entryhi)</span>;</span><br></pre></td></tr></tbody></table></figure><p>In <code>tlb_invalidate()</code>, we called <code>tlb_out()</code> function, which is written in MIPS. To access TLB in MIPS, we use <code>EntryHi</code> and <code>EntryLo</code> registers. <code>EntryHi</code> as key and <code>EntryLo</code> as value. So, here, to flush the entry, we need the key to specify which entry to flush, and the key is what we call <code>entryhi</code>. As a parameter and the first parameter, it will be passed as <code>$a0</code> in MIPS.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">LEAF(tlb_out)</span><br><span class="line">.set noreorder</span><br><span class="line">    mfc0    t0, CP0_ENTRYHI  # Store previous value for context restore.</span><br><span class="line">    mtc0    a0, CP0_ENTRYHI  # Make CP0.EntryHi the parameter we passed.</span><br><span class="line">    </span><br><span class="line">    # Get corresponding value of CP0.EntryHi and store it to CP0.Index register.</span><br><span class="line">    # nop has to be added for pipline execution reason.</span><br><span class="line">    nop</span><br><span class="line">    tlbp</span><br><span class="line">    nop</span><br><span class="line">    </span><br><span class="line">    # Get the result of tlbp from CP0.Index</span><br><span class="line">    mfc0    t1, CP0_INDEX</span><br><span class="line">    </span><br><span class="line">.set reorder</span><br><span class="line">    # If no such entry, highest bit of Index will be set to 1, which</span><br><span class="line">    # makes it a negative value, and then skip flush operation.</span><br><span class="line">    bltz    t1, NO_SUCH_ENTRY  # bltz: branch (if) less than zero</span><br><span class="line">	</span><br><span class="line">.set noreorder</span><br><span class="line">    # Clear TLB entry by setting key and value to zero.</span><br><span class="line">    # Here, CP0.EntryHi and CP0.EntryLo0 are just a step stone for us</span><br><span class="line">    # to operate TLB, they will be used later in tlbwi</span><br><span class="line">    mtc0    zero, CP0_ENTRYHI</span><br><span class="line">    mtc0    zero, CP0_ENTRYLO0  # MIPS 3000 only has CP0.EntryLo0.</span><br><span class="line">    nop</span><br><span class="line"></span><br><span class="line">    # Write CP0.EntryLo0 and CP0.EntryLo1 to TLB</span><br><span class="line">    tlbwi</span><br><span class="line"></span><br><span class="line">.set reorder</span><br><span class="line"></span><br><span class="line"># These instructions will be executed whether there is such an entry or not.</span><br><span class="line">NO_SUCH_ENTRY:</span><br><span class="line">    mtc0    t0, CP0_ENTRYHI  # Restore old value.</span><br><span class="line">    j       ra</span><br><span class="line">END(tlb_out)</span><br></pre></td></tr></tbody></table></figure><blockquote><p>“The even page entries in the TLB (such as PFN0) come from <code>CP0.EntryLo0</code>. Similarly, odd page entries come from <code>CP0.EntryLo1</code>.” From <em>MD00090-2B-MIPS32PRA-AFP-06.02</em>, Page 32.</p><p>However, we use MIPS 3000, which doesn’t have such feature. It only has <code>CP0.EntryLo0</code>.</p></blockquote><p>Here are some explanation to TLB related instructions.</p><blockquote><p><code>tlbr</code> (read): Using the value in <code>CP0.Index</code> to read the corresponding entry to <code>CP0.EntryHi</code> and <code>CP0.EntryLo</code>.</p><p><code>tlbwi</code> (write): Using the value in <code>CP0.Index</code> to write the value of <code>CP0.EntryHi</code> and <code>CP0.EntryLo</code> to corresponding TLB entry.</p><p><code>tlbwr</code> (write random): Write <code>CP0.EntryHi</code> and <code>CP0.EntryLo</code> to a random TLB entry. Here, a register with random value is used, which is in fact a counter.</p><p><code>tlbp</code> (probe): Using the value in <code>CP0.EntryHi</code> as key (including VPN and ASID) to find corresponding entry in TLB. If there is such an entry, the index of it will be stored at <code>CP0.Index</code>. Other wise, the highest bit of <code>CP0.Index</code> will be set to 1 to make it a negative number, indicating a failure.</p></blockquote><p>So, let get back to the problem one last time. Now, everything is clear. We traverse the page table entries, and get the legal ones. Then, do the … things.</p><p>As we know, “Talk is cheap, show me the code.” So, just show the code. ;)</p><details class="toggle"><summary class="toggle-button">Code</summary><div class="toggle-content"><p>To make it shorter, I removed some blank lines. We’re really sorry about this. :(</p><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">Swap out</button><button type="button" class="tab">Swap in</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface for 'Passive Swap Out'</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ensure_free_page</span><span class="params">(Pde* pgdir, u_int asid)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Select a page to swap out to disk.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span>* <span class="title">pp</span> =</span> pa2page(SWAP_PAGE_BASE);</span><br><span class="line">    <span class="comment">// Allocate swap page on disk.</span></span><br><span class="line">    u_char* da = disk_alloc();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> pdx = <span class="number">0</span>; pdx &lt; PAGE_ENTRY_CNT; pdx++)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (!(pgdir[pdx] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        Pte* pgtbl = (Pte*)KADDR(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> ptx = <span class="number">0</span>; ptx &lt; PAGE_ENTRY_CNT; ptx++)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (!(pgtbl[ptx] &amp; PTE_V))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (PPN(pgtbl[ptx]) == page2ppn(pp))</span><br><span class="line">            {</span><br><span class="line">                u_long va = (pdx &lt;&lt; PDSHIFT) | (ptx &lt;&lt; PGSHIFT);</span><br><span class="line">                u_long perm = PTE_PERM(pgtbl[ptx]);</span><br><span class="line">                perm = PTE_CLR(perm, PTE_V);</span><br><span class="line">                perm = PTE_SET(perm, PTE_SWP);</span><br><span class="line">                pgtbl[ptx] = PTE_ADDR(da) | perm;</span><br><span class="line">                <span class="comment">// Now you should know what 'va' means. :P</span></span><br><span class="line">                tlb_invalidate(asid, va);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">memcpy</span>(da, (<span class="type">void</span>*)page2kva(pp), BY2PG);</span><br><span class="line">    LIST_INSERT_HEAD(&amp;page_free_swappable_list, pp, pp_link);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Page* <span class="title function_">swap_alloc</span><span class="params">(Pde* pgdir, u_int asid)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Must ensure there is page to swap.</span></span><br><span class="line">    <span class="keyword">if</span> (LIST_EMPTY(&amp;page_free_swappable_list))</span><br><span class="line">       ensure_free_page(pgdir, asid);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span>* <span class="title">pp</span> =</span> LIST_FIRST(&amp;page_free_swappable_list);</span><br><span class="line">    LIST_REMOVE(pp, pp_link);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span>*)page2kva(pp), <span class="number">0</span>, BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pp;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-item-content"><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interfaces for 'Active Swap In'</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">is_swapped</span><span class="params">(Pde* pgdir, u_long va)</span></span><br><span class="line">{</span><br><span class="line">    Pte* pte;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Not page_lookup() here, since the page we look for might be</span></span><br><span class="line"><span class="comment">     * swapped out with PTE_V set to zero. This will be regarded as</span></span><br><span class="line"><span class="comment">     * error by page_lookup(), which will then make pte NULL, causing</span></span><br><span class="line"><span class="comment">     * the final return to be false, rather than true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pgdir_walk(pgdir, va, <span class="number">0</span>, &amp;pte);</span><br><span class="line">    <span class="keyword">return</span> pte &amp;&amp; (*pte &amp; PTE_SWP) &amp;&amp; !(*pte &amp; PTE_V);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">swap</span><span class="params">(Pde* pgdir, u_int asid, u_long va)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// va may not be aligned by page, but this doesn't affect this lab.</span></span><br><span class="line">    va = ROUNDDOWN(va, BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span>* <span class="title">pp</span> =</span> swap_alloc(pgdir, asid);</span><br><span class="line">    Pte* pte;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Find the pte corresponding to given va.</span></span><br><span class="line"><span class="comment">     * Notice that, this va is one of the pte that mapped to the swapped out</span></span><br><span class="line"><span class="comment">     * page, while all pte(s) that mapped to the swapped page contains the</span></span><br><span class="line"><span class="comment">     * da we want.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pgdir_walk(pgdir, va, &amp;pte);</span><br><span class="line">    assert(pte);</span><br><span class="line"></span><br><span class="line">    u_char* da = (u_char*)PTE_ADDR(*pte);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span>*)page2kva(pp), da, BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> pdx = <span class="number">0</span>; pdx &lt; PAGE_ENTRY_CNT; pdx++)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (!(pgdir[pdx] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        Pte* pgtbl = (Pte*)KADDR(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> ptx = <span class="number">0</span>; ptx &lt; PAGE_ENTRY_CNT; ptx++)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (!((pgtbl[ptx] &amp; PTE_SWP) &amp;&amp; !(pgtbl[ptx] &amp; PTE_V)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (PPN(pgtbl[ptx]) == PPN(da))</span><br><span class="line">            {</span><br><span class="line">                u_long vaddr = (pdx &lt;&lt; PDSHIFT) | (ptx &lt;&lt; PGSHIFT);</span><br><span class="line">                u_long perm = PTE_PERM(pgtbl[ptx]);</span><br><span class="line">                perm = PTE_SET(perm, PTE_V);</span><br><span class="line">                perm = PTE_CLR(perm, PTE_SWP);</span><br><span class="line">                pgtbl[ptx] = page2pa(pp) | perm;</span><br><span class="line">                tlb_invalidate(asid, vaddr);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    disk_free(da);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">Pte <span class="title function_">swap_lookup</span><span class="params">(Pde* pgdir, u_int asid, u_long va)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// If corresponding page is swapped out, swap it in</span></span><br><span class="line">    <span class="keyword">if</span> (is_swapped(pgdir, va))</span><br><span class="line">	    swap(pgdir, asid, va);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Look up page table element.</span></span><br><span class="line">    <span class="comment">// Here, the pte to va is sure to exist</span></span><br><span class="line">    Pte* ppte;</span><br><span class="line">    page_lookup(pgdir, va, &amp;ppte);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ppte == <span class="literal">NULL</span> ? <span class="number">0</span> : *ppte;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></details></body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.tonys-studio.top">Tony Lewis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/">https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OS/">OS</a></div><div class="post-share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_wechat"></a><a class="a2a_button_qzone"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/10/09.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Page-Directory-Self-Mapping/" title="Page Directory Self Mapping"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/01/07.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Page Directory Self Mapping</div></div><div class="info-2"><div class="info-item-1">Understanding page directory self mapping</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Configure-VS-for-Non-MSVC-Projects/" title="Configure Visual Studio for Non-MSVC Projects"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/09/07.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 27th, 2023 - 09:13:37</div><div class="info-item-2">Configure Visual Studio for Non-MSVC Projects</div></div><div class="info-2"><div class="info-item-1">Configure VS IntelliSense for GCC</div></div></div></a><a class="pagination-related" href="/posts/Lab-5-Reflection/" title="Lab 5 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/22/00.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:42</div><div class="info-item-2">Lab 5 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 5 - File System</div></div></div></a><a class="pagination-related" href="/posts/File-System-IPC/" title="File System IPC"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/06/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:57</div><div class="info-item-2">File System IPC</div></div><div class="info-2"><div class="info-item-1">Brief on File System IPC Mechanism</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Challenge/" title="Lab 6 Challenge"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/15/09.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:24</div><div class="info-item-2">Lab 6 Challenge</div></div><div class="info-2"><div class="info-item-1">Lab 6 Challenge - A More Powerful Shell</div></div></div></a><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/10/09.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 20th, 2023 - 17:07:01</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Reflection/" title="Lab 6 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/10/09.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:19</div><div class="info-item-2">Lab 6 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 6 - Pipe & Shell</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="author-info-name">Tony Lewis</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Hello there!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BUAA-OS-2023-Spring"><span class="toc-text">BUAA OS 2023 Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Traverse-Page-Table-Entries"><span class="toc-text">Traverse Page Table Entries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flush-TLB"><span class="toc-text">Flush TLB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pgdir-walk"><span class="toc-text">pgdir_walk()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tlb-invalidate"><span class="toc-text">tlb_invalidate()</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Advanced-C-Workshop-2023-03/" title="Advanced C++ Workshop 2023 (03)"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/CSCS.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Advanced C++ Workshop 2023 (03)"></a><div class="content"><a class="title" href="/posts/Advanced-C-Workshop-2023-03/" title="Advanced C++ Workshop 2023 (03)">Advanced C++ Workshop 2023 (03)</a><time datetime="2026-02-22T13:16:59.000Z" title="Created Feb. 22nd, 2026 - 21:16:59 21:16:59">Feb. 22nd, 2026 - 21:16:59</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Advanced-C-Workshop-2023-02/" title="Advanced C++ Workshop 2023 (02)"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/CSCS.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Advanced C++ Workshop 2023 (02)"></a><div class="content"><a class="title" href="/posts/Advanced-C-Workshop-2023-02/" title="Advanced C++ Workshop 2023 (02)">Advanced C++ Workshop 2023 (02)</a><time datetime="2026-02-21T09:38:11.000Z" title="Created Feb. 21st, 2026 - 17:38:11 17:38:11">Feb. 21st, 2026 - 17:38:11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Advanced-C-Workshop-2023-01/" title="Advanced C++ Workshop 2023 (01)"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/CSCS.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Advanced C++ Workshop 2023 (01)"></a><div class="content"><a class="title" href="/posts/Advanced-C-Workshop-2023-01/" title="Advanced C++ Workshop 2023 (01)">Advanced C++ Workshop 2023 (01)</a><time datetime="2026-02-21T09:38:04.000Z" title="Created Feb. 21st, 2026 - 17:38:04 17:38:04">Feb. 21st, 2026 - 17:38:04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Symbolic-Execution-with-KLEE/" title="Symbolic Execution With KLEE"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/09/05.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Symbolic Execution With KLEE"></a><div class="content"><a class="title" href="/posts/Symbolic-Execution-with-KLEE/" title="Symbolic Execution With KLEE">Symbolic Execution With KLEE</a><time datetime="2025-11-28T09:39:23.000Z" title="Created Nov. 28th, 2025 - 17:39:23 17:39:23">Nov. 28th, 2025 - 17:39:23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/ahsoka/09.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="A Fancy and Practical Zsh Configuration"></a><div class="content"><a class="title" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration">A Fancy and Practical Zsh Configuration</a><time datetime="2025-09-26T14:15:54.000Z" title="Created Sep. 26th, 2025 - 22:15:54 22:15:54">Sep. 26th, 2025 - 22:15:54</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/24/05.jpeg)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By Tony Lewis</span></div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=e=>{const t=(e=>{if(!e)return null;const t=e.trim().split(/[\s,]+/).map(e=>Number(e));return 4!==t.length||t.some(e=>Number.isNaN(e))?null:t})(e.getAttribute("viewBox"));if(t)return t;try{const t=e.getBBox();if(t&&t.width&&t.height)return[t.x,t.y,t.width,t.height]}catch(e){}const n=Number(e.getAttribute("width"))||0,i=Number(e.getAttribute("height"))||0;return n>0&&i>0?[0,0,n,i]:[0,0,100,100]},t=(e,t)=>{e.setAttribute("viewBox",`${t[0]} ${t[1]} ${t[2]} ${t[3]}`)},n=(e,t,n)=>Math.max(t,Math.min(n,e)),i=({source:e,initViewBox:t})=>{const n=(()=>{if("string"==typeof e){const t=document.createElement("template");t.innerHTML=e.trim();const n=t.content.querySelector("svg");return n?n.cloneNode(!0):null}return e&&"function"==typeof e.cloneNode?e.cloneNode(!0):null})();if(!n)return;t&&4===t.length&&n.setAttribute("viewBox",t.join(" ")),n.getAttribute("xmlns")||n.setAttribute("xmlns","http://www.w3.org/2000/svg"),!n.getAttribute("xmlns:xlink")&&n.outerHTML.includes("xlink:")&&n.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");const i="dark"===document.documentElement.getAttribute("data-theme"),r=getComputedStyle(document.body).backgroundColor||(i?"#1e1e1e":"#ffffff");n.style.background||(n.style.background=r);const o=(new XMLSerializer).serializeToString(n),s=new Blob([`<!doctype html><html><head><meta charset="utf-8" />\n      <style>\n        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${r}; }\n        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }\n      </style>\n      </head><body>${o}</body></html>`],{type:"text/html;charset=utf-8"}),a=URL.createObjectURL(s);window.open(a,"_blank","noopener"),setTimeout(()=>URL.revokeObjectURL(a),3e4)},r=(e,t,n,i)=>{const r=e[2]*t,o=e[3]*t;return[n-(n-e[0])*t,i-(i-e[1])*t,r,o]},o=i=>{const o=i.querySelector("svg");if(!o)return;const s=e(o);if(i.__mermaidInitViewBox=s,i.__mermaidCurViewBox=s.slice(),t(o,s),i.__mermaidGestureBound)return;i.__mermaidGestureBound=!0;const a=(t,n)=>{const r=o.getBoundingClientRect(),s=i.__mermaidCurViewBox||e(o);return{x:s[0]+(t-r.left)*(s[2]/r.width),y:s[1]+(n-r.top)*(s[3]/r.height),rect:r,vb:s}},d={pointers:new Map,startVb:null,startDist:0,startCenter:null},m=e=>{e=(e=>{const t=i.__mermaidInitViewBox||e,r=.1*t[2],o=10*t[2],s=.1*t[3],a=10*t[3];return e[2]=n(e[2],r,o),e[3]=n(e[3],s,a),e})(e),i.__mermaidCurViewBox=e,t(o,e)},l=e=>{d.pointers.delete(e.pointerId),0===d.pointers.size?(d.startVb=null,d.startDist=0,d.startCenter=null,i.__mermaidLastSinglePointer=null):1===d.pointers.size&&(i.__mermaidLastSinglePointer=[...d.pointers.values()][0])};o.addEventListener("pointerdown",t=>{if("mouse"!==t.pointerType||0===t.button)if(o.setPointerCapture(t.pointerId),d.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),1===d.pointers.size)d.startVb=(i.__mermaidCurViewBox||e(o)).slice();else if(2===d.pointers.size){const t=[...d.pointers.values()],n=t[0].x-t[1].x,r=t[0].y-t[1].y;d.startDist=Math.hypot(n,r),d.startVb=(i.__mermaidCurViewBox||e(o)).slice(),d.startCenter={x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2}}}),o.addEventListener("pointermove",t=>{if(d.pointers.has(t.pointerId))if(d.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),1===d.pointers.size&&d.startVb){const n=[...d.pointers.values()][0],r=(t.clientX,t.movementX,t.clientY,t.movementY,i.__mermaidLastSinglePointer||n),s=n.x-r.x,l=n.y-r.y;i.__mermaidLastSinglePointer=n;const{rect:c}=a(n.x,n.y),u=(i.__mermaidCurViewBox||e(o)).slice(),p=s*(u[2]/c.width),h=l*(u[3]/c.height);m([u[0]-p,u[1]-h,u[2],u[3]])}else if(2===d.pointers.size&&d.startVb&&d.startDist>0){const e=[...d.pointers.values()],t=e[0].x-e[1].x,n=e[0].y-e[1].y,i=Math.hypot(t,n);if(!i)return;const o=d.startDist/i,s={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},l=a(s.x,s.y),c=l.x,u=l.y,p=r(d.startVb,o,c,u);m(p)}}),o.addEventListener("pointerup",l),o.addEventListener("pointercancel",l),o.addEventListener("wheel",t=>{t.preventDefault();const n=t.deltaY>0?1.1:.9,{x:s,y:d}=a(t.clientX,t.clientY),l=(i.__mermaidCurViewBox||e(o)).slice();m(r(l,n,s,d))},{passive:!1}),o.addEventListener("dblclick",()=>{const e=i.__mermaidInitViewBox;e&&(i.__mermaidCurViewBox=e.slice(),t(o,e))})},s=e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"forest";e.forEach((e,n)=>{const r=e.firstElementChild,s=e.querySelector("svg");s&&s.remove(),e.__mermaidGestureBound=!1;const a=r.dataset.config?JSON.parse(r.dataset.config):{};a.theme||(a.theme=t);const d="mermaid-"+n,m=`%%{init: ${JSON.stringify(a)}}%%\n`+r.textContent,l=mermaid.render(d,m),c=t=>{r.insertAdjacentHTML("afterend",t),o(e),e.__mermaidOriginalSvg=t,(e=>{let t=e.querySelector(".mermaid-open-btn");t||(t=document.createElement("button"),t.type="button",t.className="mermaid-open-btn",e.appendChild(t)),t.innerHTML='<i class="fa fa-search fa-fw" aria-hidden="true"></i>',t.__mermaidViewerBound||(t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const n=e.__mermaidOriginalSvg||e.querySelector("svg");if(!n)return;const r=e.__mermaidInitViewBox;i({source:n,initViewBox:r})}),t.__mermaidViewerBound=!0)})(e)};"string"==typeof l?c(l):l.then(({svg:e})=>c(e))})},a=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>s(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",a,"mermaid"),window.pjax?a():document.addEventListener("DOMContentLoaded",a)})()</script><script>(()=>{let n=window.walineFn||null;const e="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,t=(n,t=document,i=window.location.pathname)=>{const o=n({el:t.querySelector("#waline-wrap"),serverURL:"https://comment.tonys-studio.top",pageview:!0,dark:'html[data-theme="dark"]',comment:!0,path:i});e&&(window.shuoshuoComment.destroyWaline=()=>{o.destroy(),t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))})},i=(e,i)=>{n?t(n,e,i):btf.getCSS("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css").then(()=>import("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js")).then(({init:o})=>{n=o||Waline.init,t(n,e,i),window.walineFn=n})};e?window.shuoshuoComment={loadComment:i}:setTimeout(i,0)})()</script></div><script src="/static/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> Loading Database</span></div><div class="local-search-input"><input placeholder="Looking for something?🔍" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>