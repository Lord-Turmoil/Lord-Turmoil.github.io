<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lab 2 Extra Reflection | TONY'S STUDIO</title><meta name="author" content="Tony Skywalker"><meta name="copyright" content="Tony Skywalker"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Reflection on 2023 BUAA OS Lab 2 Extra">
<meta property="og:type" content="article">
<meta property="og:title" content="Lab 2 Extra Reflection">
<meta property="og:url" content="https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/">
<meta property="og:site_name" content="TONY&#39;S STUDIO">
<meta property="og:description" content="Reflection on 2023 BUAA OS Lab 2 Extra">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/09.jpeg">
<meta property="article:published_time" content="2023-04-06T11:53:06.000Z">
<meta property="article:modified_time" content="2025-02-28T12:38:24.709Z">
<meta property="article:author" content="Tony Skywalker">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="BUAA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/09.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lab 2 Extra Reflection",
  "url": "https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/09.jpeg",
  "datePublished": "2023-04-06T11:53:06.000Z",
  "dateModified": "2025-02-28T12:38:24.709Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Skywalker",
      "url": "https://tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="codeva-R6O16YoeQt"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#300303')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "h2swkizghx");</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":10,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":256,"languages":{"author":"Author: Tony Skywalker","link":"Link: ","source":"Source: TONY'S STUDIO","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#871798","bgDark":"#C81025","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lab 2 Extra Reflection',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.6/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/css/barber-shop.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/back_img.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/support/"><i class="fa-fw fas fa-hand-holding-heart"></i><span> Support</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/09.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Lab 2 Extra Reflection</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/support/"><i class="fa-fw fas fa-hand-holding-heart"></i><span> Support</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lab 2 Extra Reflection</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-04-06T11:53:06.000Z" title="Created Apr. 6th, 2023 - 19:53:06 19:53:06">Apr. 6th, 2023 - 19:53:06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-02-28T12:38:24.709Z" title="Updated Feb. 28th, 2025 - 20:38:24 20:38:24">Feb. 28th, 2025 - 20:38:24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/">BUAA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/OS/">OS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">1.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>10mins</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Lab-2-Extra-Reflection/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Lab-2-Extra-Reflection/#post-comment"><span class="waline-comment-count" data-path="/posts/Lab-2-Extra-Reflection/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="BUAA-OS-2023-Spring"><a href="#BUAA-OS-2023-Spring" class="headerlink" title="BUAA OS 2023 Spring"></a>BUAA OS 2023 Spring</h1><hr>
<p>Due to misunderstanding of some concepts and the meaning of some functions, I failed on lab 2 extra. So much thanks to the TA who helped me understand these stuffs. Thus, a reflection here, I have.</p>
<p>To be honest, the problem is not that difficult, but if you’re not clear with related concepts, you may get into much trouble. So, here I just want to demonstrate some key points of it.</p>
<p>Here is the original problem description, you can expand it optionally.</p>
<details class="toggle"><summary class="toggle-button" style>Problem</summary><div class="toggle-content"><p><img src="/posts/Lab-2-Extra-Reflection/image-20230406202127222.png" alt="image-20230406202127222"></p>
</div></details>

<hr>
<blockquote>
<p>To get a better understanding of this article, you can refer to my previous post here:</p>
<ul>
<li><a href="/posts/Page-Directory-Self-Mapping/">Page Directory Self Mapping</a></li>
</ul>
</blockquote>
<h2 id="Traverse-Page-Table-Entries"><a href="#Traverse-Page-Table-Entries" class="headerlink" title="Traverse Page Table Entries"></a>Traverse Page Table Entries</h2><p>In this problem, to swap in or out a page need a complete traverse of the page table of current process. But why? Why not just a single page? Well, you know, multiple virtual page could be mapped to the same physical address, so we have to make sure all these pages are correctly marked. Therefore, a complete traverse is needed.</p>
<p>Then, you may ask again, there are so many page table entries, won’t it take too long? Emm… some page directories are not valid, so the page table entries will be skipped.</p>
<p>So, how do we traverse page table entries?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Traverse page table entries.</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> PAGE_ENTRY_CNT = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> pdx = <span class="number">0</span>; pdx &lt; PAGE_ENTRY_CNT; pdx++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(pgdir[pdx] &amp; PTE_V))	<span class="comment">// skip invalid page directory entry</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// The address of page table should be kernel address for os access,</span></span><br><span class="line">    <span class="comment">// but the content of page table entry is physical address.</span></span><br><span class="line">    Pte* pgtbl = (Pte*)KADDR(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> ptx = <span class="number">0</span>; ptx &lt; PAGE_ENTRY_CNT; ptx++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(pgtbl[ptx] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        <span class="comment">// operations on valid page table entry</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Flush-TLB"><a href="#Flush-TLB" class="headerlink" title="Flush TLB"></a>Flush TLB</h2><p>Another point that is difficult to understand is the action to clear old TLB entry. The structure of TLB entry is as follows.</p>
<img src="/posts/Lab-2-Extra-Reflection/image-20230406204026763.png" alt="image-20230406204026763" style="zoom: 67%;">

<p>VPN is virtual page number, if we takes it out and make low 12 bits zero, it will be the start virtual address of a virtual page. The same goes with PFN, which is Page Frame number, a.k.a. Physical Page number (PPN).</p>
<p>To invalidate a page directory entry, we actually flush the VPN it mapped to. Yeah, the VPN it mapped to, but how to get it? In <code>pgdir_walk()</code> function, we create or get a page table entry of the given <code>va</code>, which is exactly what we want here. So, again, what does <code>pgdir_walk()</code> really mean?</p>
<h3 id="pgdir-walk"><a href="#pgdir-walk" class="headerlink" title="pgdir_walk()"></a><code>pgdir_walk()</code></h3><p><del>I found that I didn’t understand this function before.</del> Here is the definition of this tricky function.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Overview:</span></span><br><span class="line"><span class="comment"> *   Given &#x27;pgdir&#x27;, a pointer to a page directory, &#x27;pgdir_walk&#x27; returns a pointer</span></span><br><span class="line"><span class="comment"> *   to the page table entry (with permission PTE_D|PTE_V) for virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Pre-Condition:</span></span><br><span class="line"><span class="comment"> *   &#x27;pgdir&#x27; is a two-level page table structure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Post-Condition:</span></span><br><span class="line"><span class="comment"> *   If we&#x27;re out of memory, return -E_NO_MEM.</span></span><br><span class="line"><span class="comment"> *   Otherwise, we get the page table entry, store the value of page table entry</span></span><br><span class="line"><span class="comment"> *   to *ppte, and return 0, indicating success.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">pgdir_walk</span><span class="params">(Pde* pgdir, u_long va, <span class="type">int</span> create, Pte** ppte)</span>;</span><br></pre></td></tr></table></figure>

<p>Depending on the value of <code>create</code>, we can get the page table entry mapped to virtual address <code>va</code>, or create the missing page table. (Since we use two-level page table, where the second level won’t be created until needed.) And what we used here is the so called VPN, which could be further explained as PDX and PTX. Again, here is a picture of it. </p>
<img src="/posts/Lab-2-Extra-Reflection/image-20230406205510542.png" alt="image-20230406205510542" style="zoom:67%;">

<p>Get it? Are we getting it? (By Steve Jobs on iPhone’s release conference.)</p>
<p>The <code>va</code> here is exactly what we use later in <code>tlb_invalidate()</code>. What? You still don’t know what <code>va</code> is? Just take some time to read the previous post <a href="/posts/Page-Directory-Self-Mapping/">Page Directory Self Mapping</a>.</p>
<p>So the purpose of <code>pgdir_walk()</code> is just to get the corresponding page table entry of the virtual address <code>va</code>, or create it if not allocated before.</p>
<h3 id="tlb-invalidate"><a href="#tlb-invalidate" class="headerlink" title="tlb_invalidate()"></a><code>tlb_invalidate()</code></h3><p>Here is the definition of related functions. Now you should know what’s the correct <code>va</code> to pass.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invalidate the TLB entry with specified &#x27;asid&#x27; and virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">tlb_invalidate</span><span class="params">(u_int asid, u_long va)</span></span><br><span class="line">&#123;</span><br><span class="line">    tlb_out(PTE_ADDR(va) | (asid &lt;&lt; <span class="number">6</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Flush the TLB entry with EntryHi Register set to &#x27;entryhi&#x27;.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">tlb_out</span><span class="params">(u_int entryhi)</span>;</span><br></pre></td></tr></table></figure>

<p>In <code>tlb_invalidate()</code>, we called <code>tlb_out()</code> function, which is written in MIPS. To access TLB in MIPS, we use <code>EntryHi</code> and <code>EntryLo</code> registers. <code>EntryHi</code> as key and <code>EntryLo</code> as value. So, here, to flush the entry, we need the key to specify which entry to flush, and the key is what we call <code>entryhi</code>. As a parameter and the first parameter, it will be passed as <code>$a0</code> in MIPS.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">LEAF(tlb_out)</span><br><span class="line">.set noreorder</span><br><span class="line">    mfc0    t0, CP0_ENTRYHI  # Store previous value for context restore.</span><br><span class="line">    mtc0    a0, CP0_ENTRYHI  # Make CP0.EntryHi the parameter we passed.</span><br><span class="line">    </span><br><span class="line">    # Get corresponding value of CP0.EntryHi and store it to CP0.Index register.</span><br><span class="line">    # nop has to be added for pipline execution reason.</span><br><span class="line">    nop</span><br><span class="line">    tlbp</span><br><span class="line">    nop</span><br><span class="line">    </span><br><span class="line">    # Get the result of tlbp from CP0.Index</span><br><span class="line">    mfc0    t1, CP0_INDEX</span><br><span class="line">    </span><br><span class="line">.set reorder</span><br><span class="line">    # If no such entry, highest bit of Index will be set to 1, which</span><br><span class="line">    # makes it a negative value, and then skip flush operation.</span><br><span class="line">    bltz    t1, NO_SUCH_ENTRY  # bltz: branch (if) less than zero</span><br><span class="line">	</span><br><span class="line">.set noreorder</span><br><span class="line">    # Clear TLB entry by setting key and value to zero.</span><br><span class="line">    # Here, CP0.EntryHi and CP0.EntryLo0 are just a step stone for us</span><br><span class="line">    # to operate TLB, they will be used later in tlbwi</span><br><span class="line">    mtc0    zero, CP0_ENTRYHI</span><br><span class="line">    mtc0    zero, CP0_ENTRYLO0  # MIPS 3000 only has CP0.EntryLo0.</span><br><span class="line">    nop</span><br><span class="line"></span><br><span class="line">    # Write CP0.EntryLo0 and CP0.EntryLo1 to TLB</span><br><span class="line">    tlbwi</span><br><span class="line"></span><br><span class="line">.set reorder</span><br><span class="line"></span><br><span class="line"># These instructions will be executed whether there is such an entry or not.</span><br><span class="line">NO_SUCH_ENTRY:</span><br><span class="line">    mtc0    t0, CP0_ENTRYHI  # Restore old value.</span><br><span class="line">    j       ra</span><br><span class="line">END(tlb_out)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>“The even page entries in the TLB (such as PFN0) come from <code>CP0.EntryLo0</code>. Similarly, odd page entries come from <code>CP0.EntryLo1</code>.” From <em>MD00090-2B-MIPS32PRA-AFP-06.02</em>, Page 32.</p>
<p>However, we use MIPS 3000, which doesn’t have such feature. It only has <code>CP0.EntryLo0</code>.</p>
</blockquote>
<p>Here are some explanation to TLB related instructions.</p>
<blockquote>
<p><code>tlbr</code> (read): Using the value in <code>CP0.Index</code> to read the corresponding entry to <code>CP0.EntryHi</code> and <code>CP0.EntryLo</code>.</p>
<p><code>tlbwi</code> (write): Using the value in <code>CP0.Index</code> to write the value of <code>CP0.EntryHi</code> and <code>CP0.EntryLo</code> to corresponding TLB entry.</p>
<p><code>tlbwr</code> (write random): Write <code>CP0.EntryHi</code> and <code>CP0.EntryLo</code> to a random TLB entry. Here, a register with random value is used, which is in fact a counter.</p>
<p><code>tlbp</code> (probe): Using the value in <code>CP0.EntryHi</code> as key (including VPN and ASID) to find corresponding entry in TLB. If there is such an entry, the index of it will be stored at <code>CP0.Index</code>. Other wise, the highest bit of <code>CP0.Index</code> will be set to 1 to make it a negative number, indicating a failure.</p>
</blockquote>
<p>So, let get back to the problem one last time. Now, everything is clear. We traverse the page table entries, and get the legal ones. Then, do the … things.</p>
<p>As we know, “Talk is cheap, show me the code.” So, just show the code. ;)</p>
<details class="toggle"><summary class="toggle-button" style>Code</summary><div class="toggle-content"><p>To make it shorter, I removed some blank lines. We’re really sorry about this. :(</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">Swap out</button><button type="button" class="tab">Swap in</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface for &#x27;Passive Swap Out&#x27;</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ensure_free_page</span><span class="params">(Pde* pgdir, u_int asid)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Select a page to swap out to disk.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span>* <span class="title">pp</span> =</span> pa2page(SWAP_PAGE_BASE);</span><br><span class="line">    <span class="comment">// Allocate swap page on disk.</span></span><br><span class="line">    u_char* da = disk_alloc();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> pdx = <span class="number">0</span>; pdx &lt; PAGE_ENTRY_CNT; pdx++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(pgdir[pdx] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        Pte* pgtbl = (Pte*)KADDR(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> ptx = <span class="number">0</span>; ptx &lt; PAGE_ENTRY_CNT; ptx++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(pgtbl[ptx] &amp; PTE_V))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (PPN(pgtbl[ptx]) == page2ppn(pp))</span><br><span class="line">            &#123;</span><br><span class="line">                u_long va = (pdx &lt;&lt; PDSHIFT) | (ptx &lt;&lt; PGSHIFT);</span><br><span class="line">                u_long perm = PTE_PERM(pgtbl[ptx]);</span><br><span class="line">                perm = PTE_CLR(perm, PTE_V);</span><br><span class="line">                perm = PTE_SET(perm, PTE_SWP);</span><br><span class="line">                pgtbl[ptx] = PTE_ADDR(da) | perm;</span><br><span class="line">                <span class="comment">// Now you should know what &#x27;va&#x27; means. :P</span></span><br><span class="line">                tlb_invalidate(asid, va);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(da, (<span class="type">void</span>*)page2kva(pp), BY2PG);</span><br><span class="line">    LIST_INSERT_HEAD(&amp;page_free_swappable_list, pp, pp_link);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Page* <span class="title function_">swap_alloc</span><span class="params">(Pde* pgdir, u_int asid)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Must ensure there is page to swap.</span></span><br><span class="line">    <span class="keyword">if</span> (LIST_EMPTY(&amp;page_free_swappable_list))</span><br><span class="line">       ensure_free_page(pgdir, asid);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span>* <span class="title">pp</span> =</span> LIST_FIRST(&amp;page_free_swappable_list);</span><br><span class="line">    LIST_REMOVE(pp, pp_link);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span>*)page2kva(pp), <span class="number">0</span>, BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interfaces for &#x27;Active Swap In&#x27;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">is_swapped</span><span class="params">(Pde* pgdir, u_long va)</span></span><br><span class="line">&#123;</span><br><span class="line">    Pte* pte;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Not page_lookup() here, since the page we look for might be</span></span><br><span class="line"><span class="comment">     * swapped out with PTE_V set to zero. This will be regarded as</span></span><br><span class="line"><span class="comment">     * error by page_lookup(), which will then make pte NULL, causing</span></span><br><span class="line"><span class="comment">     * the final return to be false, rather than true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pgdir_walk(pgdir, va, <span class="number">0</span>, &amp;pte);</span><br><span class="line">    <span class="keyword">return</span> pte &amp;&amp; (*pte &amp; PTE_SWP) &amp;&amp; !(*pte &amp; PTE_V);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">swap</span><span class="params">(Pde* pgdir, u_int asid, u_long va)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// va may not be aligned by page, but this doesn&#x27;t affect this lab.</span></span><br><span class="line">    va = ROUNDDOWN(va, BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span>* <span class="title">pp</span> =</span> swap_alloc(pgdir, asid);</span><br><span class="line">    Pte* pte;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Find the pte corresponding to given va.</span></span><br><span class="line"><span class="comment">     * Notice that, this va is one of the pte that mapped to the swapped out</span></span><br><span class="line"><span class="comment">     * page, while all pte(s) that mapped to the swapped page contains the</span></span><br><span class="line"><span class="comment">     * da we want.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pgdir_walk(pgdir, va, &amp;pte);</span><br><span class="line">    assert(pte);</span><br><span class="line"></span><br><span class="line">    u_char* da = (u_char*)PTE_ADDR(*pte);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span>*)page2kva(pp), da, BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> pdx = <span class="number">0</span>; pdx &lt; PAGE_ENTRY_CNT; pdx++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(pgdir[pdx] &amp; PTE_V))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        Pte* pgtbl = (Pte*)KADDR(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> ptx = <span class="number">0</span>; ptx &lt; PAGE_ENTRY_CNT; ptx++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!((pgtbl[ptx] &amp; PTE_SWP) &amp;&amp; !(pgtbl[ptx] &amp; PTE_V)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (PPN(pgtbl[ptx]) == PPN(da))</span><br><span class="line">            &#123;</span><br><span class="line">                u_long vaddr = (pdx &lt;&lt; PDSHIFT) | (ptx &lt;&lt; PGSHIFT);</span><br><span class="line">                u_long perm = PTE_PERM(pgtbl[ptx]);</span><br><span class="line">                perm = PTE_SET(perm, PTE_V);</span><br><span class="line">                perm = PTE_CLR(perm, PTE_SWP);</span><br><span class="line">                pgtbl[ptx] = page2pa(pp) | perm;</span><br><span class="line">                tlb_invalidate(asid, vaddr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    disk_free(da);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Pte <span class="title function_">swap_lookup</span><span class="params">(Pde* pgdir, u_int asid, u_long va)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// If corresponding page is swapped out, swap it in</span></span><br><span class="line">    <span class="keyword">if</span> (is_swapped(pgdir, va))</span><br><span class="line">	    swap(pgdir, asid, va);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Look up page table element.</span></span><br><span class="line">    <span class="comment">// Here, the pte to va is sure to exist</span></span><br><span class="line">    Pte* ppte;</span><br><span class="line">    page_lookup(pgdir, va, &amp;ppte);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ppte == <span class="literal">NULL</span> ? <span class="number">0</span> : *ppte;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>
</div></details>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://tonys-studio.top">Tony Skywalker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/">https://blog.tonys-studio.top/posts/Lab-2-Extra-Reflection/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OS/">OS</a><a class="post-meta__tags" href="/tags/BUAA/">BUAA</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/05/09.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Page-Directory-Self-Mapping/" title="Page Directory Self Mapping"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/09/08.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Page Directory Self Mapping</div></div><div class="info-2"><div class="info-item-1">Understanding page directory self mapping</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/File-System-IPC/" title="File System IPC"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/07/15.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:57</div><div class="info-item-2">File System IPC</div></div><div class="info-2"><div class="info-item-1">Brief on File System IPC Mechanism</div></div></div></a><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/05/09.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 20th, 2023 - 17:07:01</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Lab-5-Reflection/" title="Lab 5 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/02/06.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:42</div><div class="info-item-2">Lab 5 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 5 - File System</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Reflection/" title="Lab 6 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/05.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:19</div><div class="info-item-2">Lab 6 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 6 - Pipe & Shell</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Challenge/" title="Lab 6 Challenge"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/01.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:24</div><div class="info-item-2">Lab 6 Challenge</div></div><div class="info-2"><div class="info-item-1">Lab 6 Challenge - A More Powerful Shell</div></div></div></a><a class="pagination-related" href="/posts/Page-Directory-Self-Mapping/" title="Page Directory Self Mapping"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/09/08.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Mar. 25th, 2023 - 20:56:35</div><div class="info-item-2">Page Directory Self Mapping</div></div><div class="info-2"><div class="info-item-1">Understanding page directory self mapping</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="author-info-name">Tony Skywalker</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It won't be long before the armies of the Republic track us here.<br>You can visit this site at both:<li><a href="http://blog.tonys-studio.top/" target="_blank">Main Site</a></li><li><a href="https://lord-turmoil.github.io/" target="_blank">Github Mirror Site</a></li></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BUAA-OS-2023-Spring"><span class="toc-text">BUAA OS 2023 Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Traverse-Page-Table-Entries"><span class="toc-text">Traverse Page Table Entries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flush-TLB"><span class="toc-text">Flush TLB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pgdir-walk"><span class="toc-text">pgdir_walk()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tlb-invalidate"><span class="toc-text">tlb_invalidate()</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Thoughts-on-Black-Hand-Strategy/" title="Thoughts on Black Hand Strategy"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/top/special/bh_top.jpg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Thoughts on Black Hand Strategy"/></a><div class="content"><a class="title" href="/posts/Thoughts-on-Black-Hand-Strategy/" title="Thoughts on Black Hand Strategy">Thoughts on Black Hand Strategy</a><time datetime="2025-02-28T12:37:42.000Z" title="Created Feb. 28th, 2025 - 20:37:42 20:37:42">Feb. 28th, 2025 - 20:37:42</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Setup-Modern-TypeScript-Project/" title="Setup Modern TypeScript Project"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/03/06.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Setup Modern TypeScript Project"/></a><div class="content"><a class="title" href="/posts/Setup-Modern-TypeScript-Project/" title="Setup Modern TypeScript Project">Setup Modern TypeScript Project</a><time datetime="2025-01-10T07:18:43.000Z" title="Created Jan. 10th, 2025 - 15:18:43 15:18:43">Jan. 10th, 2025 - 15:18:43</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Scam-From-Your-Own-Email-Address/" title="Scam From Your Own Email Address"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/top/special/scam.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Scam From Your Own Email Address"/></a><div class="content"><a class="title" href="/posts/Scam-From-Your-Own-Email-Address/" title="Scam From Your Own Email Address">Scam From Your Own Email Address</a><time datetime="2025-01-08T15:29:32.000Z" title="Created Jan. 8th, 2025 - 23:29:32 23:29:32">Jan. 8th, 2025 - 23:29:32</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Understanding-TypeScript-Philosophy/" title="Understanding TypeScript Philosophy"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/21/08.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Understanding TypeScript Philosophy"/></a><div class="content"><a class="title" href="/posts/Understanding-TypeScript-Philosophy/" title="Understanding TypeScript Philosophy">Understanding TypeScript Philosophy</a><time datetime="2025-01-04T05:58:47.000Z" title="Created Jan. 4th, 2025 - 13:58:47 13:58:47">Jan. 4th, 2025 - 13:58:47</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Modern-C-Project-with-CMake/" title="Modern C++ Project With CMake"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/24/11.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Modern C++ Project With CMake"/></a><div class="content"><a class="title" href="/posts/Modern-C-Project-with-CMake/" title="Modern C++ Project With CMake">Modern C++ Project With CMake</a><time datetime="2024-12-24T08:12:08.000Z" title="Created Dec. 24th, 2024 - 16:12:08 16:12:08">Dec. 24th, 2024 - 16:12:08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/09.jpeg);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By Tony Skywalker</div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://comment.tonys-studio.top',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      comment: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Anything you would like to search?🔍" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="Framework Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="Theme Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly%205.3.3-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally." title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>