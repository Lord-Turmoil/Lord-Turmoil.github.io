<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Deployment Practice With Kubernetes | TONY'S STUDIO</title><meta name="author" content="Tony Lewis"><meta name="copyright" content="Tony Lewis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="A practical walk through for deployment via Kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="Deployment Practice With Kubernetes"><meta property="og:url" content="https://blog.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/"><meta property="og:site_name" content="TONY&#39;S STUDIO"><meta property="og:description" content="A practical walk through for deployment via Kubernetes"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/05/04.jpeg"><meta property="article:published_time" content="2024-08-04T09:27:36.000Z"><meta property="article:modified_time" content="2025-11-14T07:03:16.584Z"><meta property="article:author" content="Tony Lewis"><meta property="article:tag" content="Deployment"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Repo Available"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/05/04.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Deployment Practice With Kubernetes",
  "url": "https://blog.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/05/04.jpeg",
  "datePublished": "2024-08-04T09:27:36.000Z",
  "dateModified": "2025-11-14T07:03:16.584Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Lewis",
      "url": "https://www.tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//www.clarity.ms"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#300303")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","undefined")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),r=window.matchMedia("(prefers-color-scheme: dark)"),c=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(c.matches)a();else if(r.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}r.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?o():a())})}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a)}(),btf.addGlobalFn("pjaxComplete",()=>{_hmt.push(["_trackPageview",window.location.pathname])},"baidu_analytics")</script><script>!function(t,e,n,c,r,s,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/sthrplbt7c",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,a)}(window,document,"clarity","script")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:3,unescape:!1,pagination:{enable:!0,hitsPerPage:8},languages:{hits_empty:"No results found for: ${query}",hits_stats:"${hits} articles found"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!1,post:!1},runtime:"days",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:256,languages:{author:"Author: Tony Lewis",link:"Link: ",source:"Source: TONY'S STUDIO",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#871798",bgDark:"#C81025",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!1,islazyloadPlugin:!1,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Deployment Practice With Kubernetes",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/static/custom.css"><meta name="generator" content="Hexo 8.1.1"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",()=>{Pace.restart()},"pace_restart")</script><link rel="stylesheet" href="/static/barber-shop.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/background.png)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/05/04.jpeg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Deployment Practice With Kubernetes</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> Back to Home</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Deployment Practice With Kubernetes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-04T09:27:36.000Z" title="Created Aug. 4th, 2024 - 17:27:36 17:27:36">Aug. 4th, 2024 - 17:27:36</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-11-14T07:03:16.584Z" title="Updated Nov. 14th, 2025 - 15:03:16 15:03:16">Nov. 14th, 2025 - 15:03:16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DevOps-Deployment/">DevOps &amp; Deployment</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DevOps-Deployment/Kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">3.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>22mins</span></span><span class="post-meta-separator">|</span><span data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Deployment-Practice-with-Kubernetes/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Deployment-Practice-with-Kubernetes/#post-comment"><span class="waline-comment-count" data-path="/posts/Deployment-Practice-with-Kubernetes/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><html><head></head><body><p style="text-align:center"><i>‚ÄúIt takes a minute to have a crush on someone,</i><br><i>an hour to like someone,</i><br><i>and a day to love someone...</i><br><i>but it takes a lifetime to forget someone.‚Äù</i></p><p style="text-align:right"><i>‚Äî Kahlil Gibran</i></p><h1 id="Prologue"><a href="#Prologue" class="headerlink" title="Prologue"></a>Prologue</h1><p>Suppose that you, my friend, are developing a software, how would you publish it? If it‚Äôs a client application, you may manually build it, upload the artifact, and that‚Äôs it. If it is a backend server‚Ä¶ Think about it, you have to stop the current service and re-deploy it (or them?). Such tedious work.ü•¥</p><p>For long people are trying to automate the development process. The deployment, usually involving only some script execution, can be automated relatively easier. By automatically build and deploy our product, we are practicing the idea of <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/what-is-ci-cd/"><strong>Continuous Integration/Continuous Delivery</strong></a>, a.k.a. CI/CD. Generally speaking, it is the process of automatically build, test and eventually publish our product.</p><p>Recently, I got some work on a Web application, and with what I learned in school, I decided to use CI/CD to automatically deploy it on my server. It ROCKS!üòçTherefore, I‚Äôm writing this article to record this excellent practice.</p><p>In this post, you‚Äôll learn:</p><ul><li>‚ÄúDockerize‚Äù a Spring Boot application.</li><li>Manage deployment with Kubernetes. (k3s to be specific.)</li><li>Deployment script practice.</li><li>Integration with GitHub CI/CD.</li><li>Some tips and troubleshoots.</li></ul><p>So, good luck, have fun!ü´°</p><div class="note info flat"><p>All code for this post can be found at <a target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil/DeploymentDemo">GitHub</a>.</p></div><hr><h1 id="Dockerizing-Spring-Boot-Application"><a href="#Dockerizing-Spring-Boot-Application" class="headerlink" title="Dockerizing Spring Boot Application"></a>Dockerizing Spring Boot Application</h1><p>In this part, I‚Äôll talk about the very basic of deploying your application with Docker. And it will be the foundation for more advanced deployment with Kubernetes.</p><h2 id="Install-Docker"><a href="#Install-Docker" class="headerlink" title="Install Docker"></a>Install Docker</h2><p>Well, although Docker is important in this post, it is not the point to go further into its installation. But it can be a problem now since, ‚Ä¶ some access restriction to the official Docker website. So you may use mirror when installing it.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># without mirror</span></span><br><span class="line">curl -fsSL https://test.docker.com -o test-docker.sh &amp;&amp; bash test-docker.sh</span><br><span class="line"><span class="comment"># with mirror</span></span><br><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh &amp;&amp; bash get-docker.sh --mirror Aliyun</span><br></pre></td></tr></tbody></table></figure><div class="note info flat"><p>For more information on Docker, you can refer to <a href="/posts/Getting-Started-with-Docker">Getting Started with Docker</a>.</p></div><p>There maybe some network issues when pulling images, you can refer to <a href="#Network-issues">Network Issues</a> for more information.</p><h2 id="Build-with-Dockerfile"><a href="#Build-with-Dockerfile" class="headerlink" title="Build with Dockerfile"></a>Build with <code>Dockerfile</code></h2><p>Assume that you already have a Spring Boot application ready for deployment, the first thing is to use <code>maven install</code> to pack it into a <code>.jar</code> executable file as shown below. In case ignored, you can change the version in the <code>pom.xml</code>.</p><img src="/posts/Deployment-Practice-with-Kubernetes/image-20240802205612336.png" alt="image-20240802205612336" style="zoom:50%"><p>Then, we need a <code>Dockerfile</code> to create an image from our <code>.jar</code>. The image runs our application only, so the <code>Dockerfile</code> is quite simple, copy our <code>.jar</code> into it, and run it on start. And don‚Äôt forget to expose our port.</p><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/Deployment-0.0.1.jar /app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8088</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/app.jar"</span>]</span></span><br></pre></td></tr></tbody></table></figure><div class="note success flat"><p>It is always a good practice to use a smaller base image, so here we use JDK slim from OpenJDK. Actually a JRE base image is better, but I didn‚Äôt find a suitable one.</p></div><p>And of course, you can add more arguments based on your use case.</p><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">"java"</span>, <span class="string">"-Duser.timezone=Asia/Shanghai"</span>, <span class="string">"-jar"</span>, <span class="string">"/app.jar"</span>, <span class="string">"--spring.profiles.active=dev"</span>]</span></span><br></pre></td></tr></tbody></table></figure><p>Then, we can build the Docker image with the following command.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker build -t deployment:0.0.1 .</span><br></pre></td></tr></tbody></table></figure><p>Finally, you can test run it with <code>docker run</code> (not in background), and test it with <code>curl</code> in a new terminal session.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker run -p 8088:8088 deployment:0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># new session</span></span><br><span class="line">curl localhost:8088/api/ping</span><br><span class="line">pong</span><br></pre></td></tr></tbody></table></figure><h2 id="More-Flexible-Dockerfile"><a href="#More-Flexible-Dockerfile" class="headerlink" title="More Flexible Dockerfile"></a>More Flexible <code>Dockerfile</code></h2><p>Although we have the application running with Docker, but we have to modify the <code>Dockerfile</code> for every version update. To tackle this problem, we can use <code>ARG</code> option in the <code>Dockerfile</code>. This <code>ARG</code> is required when building the image, you can also add a default value by using <code>ARG VERSION=0.0.1</code>.</p><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"><span class="keyword">ARG</span> VERSION</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/Deployment-<span class="variable">${VERSION}</span>.jar /app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8088</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/app.jar"</span>]</span></span><br></pre></td></tr></tbody></table></figure><p>So now, we can build the image with the following command. The rest is the same as before.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t deployment:0.0.1 --build-arg VERSION=0.0.1 .</span><br></pre></td></tr></tbody></table></figure><p>I think it is enough for our deployment purpose here. :)</p><hr><h1 id="Manage-Deployment-with-Kubernetes"><a href="#Manage-Deployment-with-Kubernetes" class="headerlink" title="Manage Deployment with Kubernetes"></a>Manage Deployment with Kubernetes</h1><p>Now, its time to introduce our big ‚≠ê today ‚Äî <a target="_blank" rel="noopener" href="https://kubernetes.io/">Kubernetes</a>! It is most famous for the ability to automatically deploy containerized application with high scalability. It is powerful yet extremely complex, so many consider it impossible to master Kubernetes. (I love this meme. ü§£)</p><p><img src="/posts/Deployment-Practice-with-Kubernetes/meme-1.png" alt="meme-1"></p><p>Kubernetes is, however, too powerful for small applications, so we usually use a lightweight distribution ‚Äî&nbsp;<a target="_blank" rel="noopener" href="https://k3s.io/">K3s</a>. In the following sections, we‚Äôll use k3s as demonstration. The ideas are the same, so I‚Äôll just use Kubernetes when talking about concepts.</p><h2 id="Install-K3s"><a href="#Install-K3s" class="headerlink" title="Install K3s"></a>Install K3s</h2><p>By default, K3s uses containered as the default container service. However, as the container layer is decoupled, we can also use Docker. To install K3s on your server, run the following command.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># official script</span></span><br><span class="line">curl -sfL https://get.k3s.io | sh -</span><br><span class="line"></span><br><span class="line"><span class="comment"># with mirror</span></span><br><span class="line">curl -sfL https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - --docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># set environment variable</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export KUBECONFIG=/etc/rancher/k3s/k3s.yaml'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># test if K3s works</span></span><br><span class="line"><span class="built_in">sudo</span> k3s kubectl get node</span><br></pre></td></tr></tbody></table></figure><p>Well, this is it. Next, we‚Äôre going to explore the basic concepts in Kubernetes.</p><h2 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h2><p>In Kubernetes, the main resources and their relations are shown in the following figure, and they can all be represented by a YAML file.</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>    
graph LR;
	A[Service]--expose--&gt;B
	B[Deployment]--manage--&gt;C
	C[Pod]--manage--&gt;D
	D[Container]
	E[ConfigMap]--config--&gt;B

  </pre></div><p>Pod provides a direct control over containers. It works like, a wrapper in Kubernetes. A pod may contain multiple containers to ensure additional features. You can get all running pods with the following command. And as container is not actually part of Kubernetes, you can get them with Docker commands.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubectl get pods</span><br><span class="line"><span class="built_in">sudo</span> docker ps</span><br></pre></td></tr></tbody></table></figure><p>Deployment, as its name indicates, is important in deployment. It is the key for scalability as it can seamlessly scale pods up or down. I‚Äôll show you how to create a deployment in the next section.</p><p>Finally, the Service expose the deployment, so that it can be accessed by the outside world. It ensures the deployment is consistent. For small scale deployment, however, I don‚Äôt think Service is that important, as Nginx could do the job. So I‚Äôm not going to talk about it now.</p><h2 id="Create-a-Deployment"><a href="#Create-a-Deployment" class="headerlink" title="Create a Deployment"></a>Create a Deployment</h2><p>Let‚Äôs get serious. Now, you have the Docker image, how to make the best of K3s to automatically deploy it? Well, talk is cheap, I just show the YAML file.</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment-demo</span>  <span class="comment"># name of the deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>  <span class="comment"># how many instances behind the deployment</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo</span>  <span class="comment"># indicates what pods to manage</span></span><br><span class="line">  <span class="attr">template:</span>  <span class="comment"># template for the pods in this deployment</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo</span>  <span class="comment"># pod label</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span>  <span class="comment"># whether share network from host</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deployment</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">deployment:0.0.1</span>  <span class="comment"># the image to deploy</span></span><br><span class="line">          <span class="attr">envFrom:</span>  <span class="comment"># set container environments</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">deployment-config</span></span><br><span class="line">          <span class="attr">volumeMounts:</span>  <span class="comment"># set volumes to mount</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/home/tonix/docker/deploy/data</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></tbody></table></figure><p>Some thing to explain. K3s manages containers in its own way, so we have to convert Docker configurations into K3s equivalent. The most common use is <code>-e</code> and <code>-v</code> to set environment variables and mounted volumes respectively.</p><p>To set environment variables for containers, you need to use config map. Here we import environments from <code>deployment-config</code>, so let‚Äôs see its definition. All environments are defined in <code>data</code> section.</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment-config</span>  <span class="comment"># name of the config map</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">PROFILE:</span> <span class="string">dev</span></span><br></pre></td></tr></tbody></table></figure><div class="note success flat"><p>The reason we use such an environment is to allow different active profile for our Spring Boot application.</p></div><p>To mount volumes, you just define it in the <code>deployment.yaml</code>.</p><p>One more thing, pay attention to <code>hostNetwork</code>. If your application need to access database or whatever needs network connection, you should set it true.</p><p>Finally, you can deploy your application by applying these two YAML files. To delete the deployment, just replace <code>apply</code> with <code>delete</code>.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubectl apply -f env.yaml</span><br><span class="line"><span class="built_in">sudo</span> kubectl apply -f deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> kubectl get deployments  <span class="comment"># view all deployments</span></span><br><span class="line">NAME              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment-demo   1/1     1            1           2m9s</span><br></pre></td></tr></tbody></table></figure><p>And you can again test it with <code>curl localhost:8088/api/ping</code>.</p><div class="note info flat"><p>If you updated your YAML files, there is no need to delete them before applying. K3s will automatically update it for you. However, if you updated your image (without changing the label), you have to delete the deployment first. Because K3s only update when the YAML file changes.</p></div><hr><h1 id="Deployment-Script-Breakdown"><a href="#Deployment-Script-Breakdown" class="headerlink" title="Deployment Script Breakdown"></a>Deployment Script Breakdown</h1><p>Now that you are familiar with every part of the deployment, let‚Äôs make a script to do it automatically.</p><h2 id="Script-Overview"><a href="#Script-Overview" class="headerlink" title="Script Overview"></a>Script Overview</h2><p>In the script, we are going to cover these steps.</p><ol><li>Automatically discover latest version and artifact.</li><li>Build Docker image.</li><li>Apply new deployment.</li></ol><p>The first step is a little tricky, as it automatically choose the latest version of your application.</p><p>At the same time, we want to log our deployment into a file.</p><h2 id="Version-Discovery"><a href="#Version-Discovery" class="headerlink" title="Version Discovery"></a>Version Discovery</h2><p>We use regular expression to find version in our published artifact, and choose the latest version to deploy.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iterate all files under `target' to find the latest version</span></span><br><span class="line">files=`<span class="built_in">ls</span> target/`</span><br><span class="line">max_version=0</span><br><span class="line">max_file=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$files</span>; <span class="keyword">do</span></span><br><span class="line">    version=`<span class="built_in">echo</span> <span class="variable">$file</span> | grep -oE <span class="string">"[0-9]+\.[0-9]+\.[0-9]+"</span>`</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$version</span>"</span> \&gt; <span class="string">"<span class="variable">$max_version</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        max_version=<span class="variable">$version</span></span><br><span class="line">        max_file=<span class="variable">$file</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$max_file</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] No file to deploy"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Deploying <span class="variable">$max_file</span>"</span> | <span class="built_in">tee</span> -a deploy.log</span><br></pre></td></tr></tbody></table></figure><p><code>tee</code> is a useful command when you want the output to be displayed on the terminal and wrote into a file.</p><h2 id="Build-Docker-Image"><a href="#Build-Docker-Image" class="headerlink" title="Build Docker Image"></a>Build Docker Image</h2><p>In this step, we use the <code>$max_version</code> as the argument to build our docker image.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ ! -f Dockerfile ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Dockerfile not found"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Building docker"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">sudo</span> docker build -t deployment:<span class="variable">$max_version</span> --build-arg VERSION=<span class="variable">$max_version</span> .</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Docker build failed"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Update-Deployment"><a href="#Update-Deployment" class="headerlink" title="Update Deployment"></a>Update Deployment</h2><p>Since we may change the version of our Docker image, so we‚Äôd better not hard code it in the YAML file. However, K3s doesn‚Äôt support argument when apply a new deployment, so we have to resolve it manually.</p><p>To address this problem, we rename our YAML file to <code>deployment.template.yaml</code>, and replace the image version with a safe placeholder <code>{VERSION}</code>. Then every time we create new deployment, we generate a new YAML file with the correct version. And since our Docker image changes on deployment, we should delete the previous deployment so that K3s can apply the latest deployment.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># constructing new deployment.yaml by replacing {VERSION} with $max_version</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Constructing new deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">touch</span> deployment.yaml</span><br><span class="line"><span class="built_in">mv</span> deployment.yaml deployment.yaml.old</span><br><span class="line"><span class="built_in">cat</span> deployment.template.yaml | sed <span class="string">"s/{VERSION}/<span class="variable">$max_version</span>/g"</span> &gt; deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># reload if deployment.yaml is different from deployment.yaml.old</span></span><br><span class="line"><span class="keyword">if</span> cmp -s deployment.yaml deployment.yaml.old; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[INFO] No change in deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[WARNING] Deleting previous deployment"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"sudo kubectl delete -f deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">sudo</span> kubectl delete -f deployment.yaml</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">rm</span> deployment.yaml.old</span><br></pre></td></tr></tbody></table></figure><p>At last, we can apply the new <code>deployment.yaml</code>.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Applying deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">sudo</span> kubectl apply -f env.yaml | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">sudo</span> kubectl apply -f deployment.yaml | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">sudo</span> kubectl apply -f deployment.yaml</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Failed to apply deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><p>What? You want a complete deployment script? Well, here it is.üòâ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"===== `date`"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"stop"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[WARNING] Stopping the deployment"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">sudo</span> kubectl delete -f deployment.yaml</span><br><span class="line">    <span class="built_in">sudo</span> kubectl delete -f env.yaml</span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate all files under `target' to find the latest version</span></span><br><span class="line">files=`<span class="built_in">ls</span> target/`</span><br><span class="line">max_version=0</span><br><span class="line">max_file=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$files</span>; <span class="keyword">do</span></span><br><span class="line">    version=`<span class="built_in">echo</span> <span class="variable">$file</span> | grep -oE <span class="string">"[0-9]+\.[0-9]+\.[0-9]+"</span>`</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$version</span>"</span> \&gt; <span class="string">"<span class="variable">$max_version</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        max_version=<span class="variable">$version</span></span><br><span class="line">        max_file=<span class="variable">$file</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$max_file</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] No file to deploy"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Deploying <span class="variable">$max_file</span>"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># build docker image</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f Dockerfile ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Dockerfile not found"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Building docker"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">sudo</span> docker build -t deployment:<span class="variable">$max_version</span> --build-arg VERSION=<span class="variable">$max_version</span> .</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Docker build failed"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># constructing new deployment.yaml by replacing {VERSION} with $max_version</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Constructing new deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">touch</span> deployment.yaml</span><br><span class="line"><span class="built_in">mv</span> deployment.yaml deployment.yaml.old</span><br><span class="line"><span class="built_in">cat</span> deployment.template.yaml | sed <span class="string">"s/{VERSION}/<span class="variable">$max_version</span>/g"</span> &gt; deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># reload if deployment.yaml is different from deployment.yaml.old</span></span><br><span class="line"><span class="keyword">if</span> cmp -s deployment.yaml deployment.yaml.old; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[INFO] No change in deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[WARNING] Deleting previous deployment"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"sudo kubectl delete -f deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">sudo</span> kubectl delete -f deployment.yaml</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">rm</span> deployment.yaml.old</span><br><span class="line"></span><br><span class="line"><span class="comment"># apply new deployment.yaml</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Applying deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">sudo</span> kubectl apply -f env.yaml</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Failed to apply env.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">sudo</span> kubectl apply -f deployment.yaml</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ERROR] Failed to apply deployment.yaml"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[INFO] Completed deployment of <span class="variable">$max_version</span>"</span> | <span class="built_in">tee</span> -a deploy.log</span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span> | <span class="built_in">tee</span> -a deploy.log</span><br></pre></td></tr></tbody></table></figure><p>Now, you are able to deploy your application with a single command!üéä</p><hr><h1 id="GitHub-CI-CD"><a href="#GitHub-CI-CD" class="headerlink" title="GitHub CI/CD"></a>GitHub CI/CD</h1><p>Although you can deploy with a script, you still have to manually build the artifact, upload it to the server and execute the script. How can the whole bunch of these errands be completely automated? The answer is ‚Äî CI/CD pipeline. In this section, I‚Äôll show you how to use GitHub CI/CD to enable automatic deployment.</p><h2 id="GitHub-Workflow"><a href="#GitHub-Workflow" class="headerlink" title="GitHub Workflow"></a>GitHub Workflow</h2><p>The first thing is to add a GitHub workflow file to your repository to enable GitHub Action. This example shows the minimum steps to build and publish a Spring Boot application. It says build and publish our product on every push to the <code>release</code> branch.</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">Deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">JDK</span> <span class="number">17</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-java@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">java-version:</span> <span class="string">'17'</span></span><br><span class="line">          <span class="attr">distribution:</span> <span class="string">'adopt'</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Maven</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">package</span> <span class="string">-DskipTests</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">to</span> <span class="string">server</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">appleboy/scp-action@v0.1.7</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">${{</span> <span class="string">secrets.HOST</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">${{</span> <span class="string">secrets.USERNAME</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">${{</span> <span class="string">secrets.SSH_PRIVATE_KEY</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">source:</span> <span class="string">"target/*.jar,Dockerfile,deployment.template.yaml,env.yaml"</span></span><br><span class="line">          <span class="attr">target:</span> <span class="string">${{</span> <span class="string">secrets.DEPLOY_PATH</span> <span class="string">}}</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">deploy</span> <span class="string">script</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">appleboy/ssh-action@v1.0.3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">${{</span> <span class="string">secrets.HOST</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">${{</span> <span class="string">secrets.USERNAME</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">${{</span> <span class="string">secrets.SSH_PRIVATE_KEY</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            cd ${{ secrets.DEPLOY_PATH }}</span></span><br><span class="line"><span class="string">            bash ./deploy.sh</span></span><br></pre></td></tr></tbody></table></figure><p>In the step ‚ÄúBuild with Maven‚Äù, we add <code>-DskipTests</code> because it makes no sense to test a program on deployment. And tests may fail if it involves database connection or environment sensitive operations. So just skip them, test before publishing.</p><p>When build is complete, we upload the artifact to the server, and run the <code>deploy.sh</code> we wrote in the last chapter. Here, it involves four GitHub action secrets. <code>HOST</code>, <code>USERNAME</code>, and <code>SSH_PRIVATE_KEY</code> are used to establish connection with the server while <code>DEPLOY_PATH</code> indicates where you want your application be deployed.</p><h2 id="SSH-Configuration"><a href="#SSH-Configuration" class="headerlink" title="SSH Configuration"></a>SSH Configuration</h2><p>I think there is no need to explain <code>HOST</code> and <code>USERNAME</code>. If you want use a normal user instead of root, refer to <a href="/posts/Create-sudo-enabled-User-on-Linux/">Create Sudo-Enabled User on Linux</a>. If you currently have a user, you may need to disable the password prompt, see <a href="/posts/Create-sudo-enabled-User-on-Linux/#Step-4-sudo-without-password-optional">Step 4. sudo without password</a>.</p><p>Then, the most important part comes to the <code>SSH_PRIVATE_KEY</code>. This allows GitHub action to be authenticated to access your server.</p><p>First, generate a SSH key pair on your PC (not the server). This is because we want to simulate a user login for GitHub action. And ed25519 algorithm is recommended. (You can choose RSA anyway.)</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh<span class="literal">-keygen</span> <span class="literal">-t</span> ed25519</span><br></pre></td></tr></tbody></table></figure><p>It will generate <code>id_ed25519</code> and <code>id_ed25519.pub</code> under <code>~/.ssh</code> (Windows is <code>%USERPROFILE%/.ssh</code>) directory. The content of <code>id_ed25519</code> is the <code>SSH_PRIVATE_KEY</code>. Then, we need to copy the public key to the server so that our private key will be authenticated.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id username@host</span><br></pre></td></tr></tbody></table></figure><p>For Windows users, there is an equivalent command combo to achieve this.</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ~/.ssh/id_ed25519.pub | ssh username@host <span class="string">"cat &gt;&gt; ~/.ssh/authorized_keys"</span></span><br></pre></td></tr></tbody></table></figure><div class="note warning flat"><p>In Windows, the EOL maybe CRLF, which will appear as <code>^M</code> in Linux. You can edit <code>authorized_keys</code> manually after copy.</p></div><h2 id="GitHub-Action-Secrets"><a href="#GitHub-Action-Secrets" class="headerlink" title="GitHub Action Secrets"></a>GitHub Action Secrets</h2><p>Open your repository, and add <code>HOST</code>, <code>USERNAME</code>, <code>SSH_PRIVATE_KEY</code> and <code>DEPLOY_PATH</code> to your repository secrets.</p><p><img src="/posts/Deployment-Practice-with-Kubernetes/image-20240804161440636.png" alt="image-20240804161440636"></p><div class="note warning flat"><p>I suggest keep no new line at the end of secrets.</p></div><h2 id="Trigger-the-Action"><a href="#Trigger-the-Action" class="headerlink" title="Trigger the Action"></a>Trigger the Action</h2><p>Everything is set, punch it! Push to the release branch and the action will run automatically.</p><img src="/posts/Deployment-Practice-with-Kubernetes/image-20240804170720367.png" alt="image-20240804170720367" style="zoom:50%"><p>And on our server, we can check the <code>deploy.log</code>.</p><img src="/posts/Deployment-Practice-with-Kubernetes/image-20240804170758874.png" alt="image-20240804170758874" style="zoom:50%"><div class="note success flat"><p>By using <code>.log</code> suffix, we can get a quite colorful highlighting in Visual Studio Code.üòã</p></div><p>Tada!üéâNow your application can be deployed automatically, and you can get rid of the distractions to your development process.üòÜ</p><hr><h1 id="Troubleshoot"><a href="#Troubleshoot" class="headerlink" title="Troubleshoot"></a>Troubleshoot</h1><h2 id="Network-issues"><a href="#Network-issues" class="headerlink" title="Network issues"></a>Network issues</h2><p>Unfortunately, docker is blocked by some ‚Äúunknown‚Äù forces, so you may need some mirror. I suggest you go search for them in the GitHub, or use the container acceleration service by Aliyun.</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"registry-mirrors"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">"https://dockerproxy.com"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">"https://docker.m.daocloud.io"</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>After changing the mirror, restart docker service.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></tbody></table></figure><h2 id="Unable-to-access-port-80"><a href="#Unable-to-access-port-80" class="headerlink" title="Unable to access port 80"></a>Unable to access port 80</h2><p>After you solved the network issue, you may soon encounter another weird problem accessing port 80. Whatever your Nginx configuration is, it will always respond with <code>404 page not found</code> in <strong>plain text</strong> (not the Nginx 404 page)! Even if you use <code>curl localhost:80</code> on the server. What the?ü§¨How is this possible?</p><p>Put it simple, k3s uses <strong>traefik</strong> by default which alters <code>iptables</code> to dispatch requests. It has a higher priority so requests won‚Äôt make it to Nginx. It is not a mandatory service so everything works fine when we don‚Äôt have the mirror, because k3s won‚Äôt be able to pull the image.</p><details class="toggle"><summary class="toggle-button">Details</summary><div class="toggle-content"><p>I tried to stop Nginx, <del>though apparently not the cause,</del> but the response remains. It means there is another service online. Then I tried <code>lsof -i:80</code>, but found nothing. I‚Äôm afraid there‚Äôs some sort of attack on me, so I checked all running processes. Well, I did find this: <strong>traefik</strong>. What a suspicious name, traffic, huh? Hijacked my requests?</p><p>Fortunately, it is not any virus. k3s will use traefik as the default router, which alters the system <code>iptables</code>. And since it uses <code>iptables</code>, we cannot find it via <code>lsof</code>. It will take over port 80 and 443 so any other services listening on these two ports will no longer work.ü•≤</p><p>But, why we don‚Äôt have such problem before? Because of the network issue, we‚Äôre unable to pull the traefix image without a mirror. Since it is not mandatory (unlike pause), so k3s will silently ignore it, therefore everything works fine. Now, with a mirror, k3s is able to pull all these images, and as a result,üí•, 404 not found.</p><p>How ironic, the solution, is also, the poison. By the way, it seems only the <strong>pause</strong> service is required,</p><p>Below are two articles that inspired me, much thanks.üôè</p><ul><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2330235">Ë¢´ÂùëÊÉ®‰∫ÜÔºå ÂÆâË£Ö‰∫Ü k3s Êú¨Âú∞ 80 Á´ØÂè£‰∏çËÉΩÁî®‰∫ÜÔºü</a></li><li><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16065421/6539867">Ëß£ÂÜ≥ÂÆâË£Ö‰∫Ük3s‰ª•Âêé80Âíå443Á´ØÂè£Ë¢´Âç†Áî®ÁöÑÈóÆÈ¢ò</a></li><li><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/faq/_index/#%E4%BD%BF%E7%94%A8-netstat-%E6%97%A0%E6%B3%95%E6%9F%A5%E5%88%B0-80-%E5%92%8C-443-%E7%AB%AF%E5%8F%A3">‰ΩøÁî® netstat Êó†Ê≥ïÊü•Âà∞ 80 Âíå 443 Á´ØÂè£?</a></li><li><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/faq/_index/#%E5%A6%82%E4%BD%95%E7%94%A8%E8%87%AA%E5%B7%B1%E7%9A%84-ingress-%E4%BB%A3%E6%9B%BF-traefik%EF%BC%9F">Â¶Ç‰ΩïÁî®Ëá™Â∑±ÁöÑ Ingress ‰ª£Êõø TraefikÔºü</a></li></ul></div></details><p>To disable traefik, one should follow these steps.</p><p><strong>Stop k3s</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubectl -n kube-system delete helmcharts.helm.cattle.io traefik</span><br><span class="line"><span class="built_in">sudo</span> service k3s stop</span><br></pre></td></tr></tbody></table></figure><p><strong>Disable traefik in service configuration</strong></p><p>Edit the k3s service at <code>/etc/systemd/system/k3s.service</code>, scroll to the bottom and add <code>--disable=traefik</code> option.</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ExecStart</span>=<span class="string">/usr/local/bin/k3s \</span></span><br><span class="line"><span class="string">    server \</span></span><br><span class="line"><span class="string">        '--docker' \</span></span><br><span class="line"><span class="string">        '--disable=traefik' \</span></span><br></pre></td></tr></tbody></table></figure><p>Then, reload services.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br></pre></td></tr></tbody></table></figure><p>It is optional to remove the traefik configuration file.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /var/lib/rancher/k3s/server/manifests/traefik.yaml</span><br></pre></td></tr></tbody></table></figure><p><strong>Restart k3s service</strong></p><p>Finally, start k3s and you won‚Äôt have the traefik service.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service k3s start</span><br></pre></td></tr></tbody></table></figure><p>Now, you‚Äôll again have control over port 80 and 443.</p><p>By the way, K3s enables many components which may not be required, so you can just disable them all. See the official document <a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/install-options/server-config/_index/#kubernetes-%E7%BB%84%E4%BB%B6">here</a>.</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ExecStart</span>=<span class="string">/usr/local/bin/k3s \</span></span><br><span class="line"><span class="string">    server \</span></span><br><span class="line"><span class="string">        '--docker' \</span></span><br><span class="line"><span class="string">        '--disable=traefik' \</span></span><br><span class="line"><span class="string">        '--disable=local-storage' \</span></span><br><span class="line"><span class="string">        '--disable=coredns' \</span></span><br><span class="line"><span class="string">        '--disable=metrics-server' \</span></span><br><span class="line"><span class="string">        '--disable=servicelb' \</span></span><br></pre></td></tr></tbody></table></figure><hr><h1 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h1><p>I think it is one of the longest post I have? This is the most comprehensive summary of my deployment experience so far, and I hope it could be useful for me, and of course for you.üòÜBefore, I was a little bit dismissive of Docker, but now, I am impressed by its portability and ease of use. It‚Äôs really convenient for scalable deployment.</p><div class="note danger flat"><p>But I am still <strong>NOT</strong> going to install Docker Desktop on my Windows PC!üò†</p></div><p>Well, I guess this is it? See you around. ·ìö·òè·ó¢</p></body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.tonys-studio.top">Tony Lewis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/">https://blog.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Repo-Available/">Repo Available</a><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/Deployment/">Deployment</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post-share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_wechat"></a><a class="a2a_button_qzone"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Kane-s-Wrath-Launch-Error-Troubleshoot/" title="Kane's Wrath Launch Error Troubleshoot"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/Kanes-Wrath-Launch-Error-Troubleshoot.png" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Kane's Wrath Launch Error Troubleshoot</div></div><div class="info-2"><div class="info-item-1">Troubleshoot launch error for Command & Conquer 3: Kane's Wrath</div></div></div></a><a class="pagination-related" href="/posts/Docker-Cheat-Sheet/" title="Docker Cheat Sheet"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/04/02.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Docker Cheat Sheet</div></div><div class="info-2"><div class="info-item-1">Collection of useful Docker commands</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Docker-Cheat-Sheet/" title="Docker Cheat Sheet"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/04/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jul. 27th, 2024 - 13:10:12</div><div class="info-item-2">Docker Cheat Sheet</div></div><div class="info-2"><div class="info-item-1">Collection of useful Docker commands</div></div></div></a><a class="pagination-related" href="/posts/Getting-Started-with-Docker/" title="Getting Started With Docker"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/21/10.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 1st, 2023 - 18:15:19</div><div class="info-item-2">Getting Started With Docker</div></div><div class="info-2"><div class="info-item-1">Brief introduction to Docker</div></div></div></a><a class="pagination-related" href="/posts/Configure-Swap-Space-for-Linux-Server/" title="Configure Swap Space for Linux Server"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/03/11.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Aug. 29th, 2023 - 11:46:33</div><div class="info-item-2">Configure Swap Space for Linux Server</div></div><div class="info-2"><div class="info-item-1">Add swap space on Linux server</div></div></div></a><a class="pagination-related" href="/posts/Deploy-MySQL-on-Linux-Server/" title="Deploy MySQL on Linux Server"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/ahsoka/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 27th, 2023 - 22:59:00</div><div class="info-item-2">Deploy MySQL on Linux Server</div></div><div class="info-2"><div class="info-item-1">Deploy MySQL server on Ubuntu Server</div></div></div></a><a class="pagination-related" href="/posts/Setup-Django-uWSGI-Nginx/" title="Setup Django + uWSGI + Nginx"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/ahsoka/10.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 29th, 2023 - 11:10:46</div><div class="info-item-2">Setup Django + uWSGI + Nginx</div></div><div class="info-2"><div class="info-item-1">Setup Django backend service using uWSGI and Nginx</div></div></div></a><a class="pagination-related" href="/posts/Setup-Elasticsearch-with-Kibana/" title="Setup Elasticsearch With Kibana"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/10/06.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Dec. 10th, 2023 - 11:11:26</div><div class="info-item-2">Setup Elasticsearch With Kibana</div></div><div class="info-2"><div class="info-item-1">Setup Elasticsearch with Kibana on Ubuntu server.</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="author-info-name">Tony Lewis</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Hello there!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prologue"><span class="toc-text">Prologue</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dockerizing-Spring-Boot-Application"><span class="toc-text">Dockerizing Spring Boot Application</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Install-Docker"><span class="toc-text">Install Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-with-Dockerfile"><span class="toc-text">Build with Dockerfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#More-Flexible-Dockerfile"><span class="toc-text">More Flexible Dockerfile</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Manage-Deployment-with-Kubernetes"><span class="toc-text">Manage Deployment with Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Install-K3s"><span class="toc-text">Install K3s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Concepts"><span class="toc-text">Concepts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-Deployment"><span class="toc-text">Create a Deployment</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Deployment-Script-Breakdown"><span class="toc-text">Deployment Script Breakdown</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Script-Overview"><span class="toc-text">Script Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Version-Discovery"><span class="toc-text">Version Discovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-Docker-Image"><span class="toc-text">Build Docker Image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update-Deployment"><span class="toc-text">Update Deployment</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GitHub-CI-CD"><span class="toc-text">GitHub CI&#x2F;CD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GitHub-Workflow"><span class="toc-text">GitHub Workflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSH-Configuration"><span class="toc-text">SSH Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitHub-Action-Secrets"><span class="toc-text">GitHub Action Secrets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Trigger-the-Action"><span class="toc-text">Trigger the Action</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Troubleshoot"><span class="toc-text">Troubleshoot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Network-issues"><span class="toc-text">Network issues</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unable-to-access-port-80"><span class="toc-text">Unable to access port 80</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Epilogue"><span class="toc-text">Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-03-What-Fonts-Do-I-have-A-Cross-Platform-Solution/" title="Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/24/07.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution"></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-03-What-Fonts-Do-I-have-A-Cross-Platform-Solution/" title="Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution">Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution</a><time datetime="2025-10-20T12:59:54.000Z" title="Created Oct. 20th, 2025 - 20:59:54 20:59:54">Oct. 20th, 2025 - 20:59:54</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/21/08.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="A Fancy and Practical Zsh Configuration"></a><div class="content"><a class="title" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration">A Fancy and Practical Zsh Configuration</a><time datetime="2025-09-26T14:15:54.000Z" title="Created Sep. 26th, 2025 - 22:15:54 22:15:54">Sep. 26th, 2025 - 22:15:54</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Lambda-Calculus-A-Preliminary-View/" title="Lambda Calculus: A Preliminary View"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/02/02.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Lambda Calculus: A Preliminary View"></a><div class="content"><a class="title" href="/posts/Lambda-Calculus-A-Preliminary-View/" title="Lambda Calculus: A Preliminary View">Lambda Calculus: A Preliminary View</a><time datetime="2025-09-16T08:25:34.000Z" title="Created Sep. 16th, 2025 - 16:25:34 16:25:34">Sep. 16th, 2025 - 16:25:34</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Music-Notation-with-Avid-Sibelius/" title="Music Notation With Avid Sibelius"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/Music-Notation-with-Avid-Sibelius.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Music Notation With Avid Sibelius"></a><div class="content"><a class="title" href="/posts/Music-Notation-with-Avid-Sibelius/" title="Music Notation With Avid Sibelius">Music Notation With Avid Sibelius</a><time datetime="2025-09-03T04:34:54.000Z" title="Created Sep. 3rd, 2025 - 12:34:54 12:34:54">Sep. 3rd, 2025 - 12:34:54</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/13.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Getting Started With Coq"></a><div class="content"><a class="title" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq">Getting Started With Coq</a><time datetime="2025-08-08T04:30:12.000Z" title="Created Aug. 8th, 2025 - 12:30:12 12:30:12">Aug. 8th, 2025 - 12:30:12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/05/04.jpeg)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Tony Lewis</span></div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"forest";e.forEach((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,a=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(r,a),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then(({svg:e})=>m(e))})})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{let n=window.walineFn||null;const e="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,t=(n,t=document,i=window.location.pathname)=>{const o=n({el:t.querySelector("#waline-wrap"),serverURL:"https://comment.tonys-studio.top",pageview:!0,dark:'html[data-theme="dark"]',comment:!0,path:i});e&&(window.shuoshuoComment.destroyWaline=()=>{o.destroy(),t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))})},i=(e,i)=>{n?t(n,e,i):btf.getCSS("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css").then(()=>import("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js")).then(({init:o})=>{n=o||Waline.init,t(n,e,i),window.walineFn=n})};e?window.shuoshuoComment={loadComment:i}:setTimeout(i,0)})()</script></div><script src="/static/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> Loading Database</span></div><div class="local-search-input"><input placeholder="Looking for something?üîç" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>