<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Bulk Task Optimization in C# | TONY'S STUDIO</title><meta name="author" content="Tony Lewis"><meta name="copyright" content="Tony Lewis"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Optimize bulk task in C# using async&#x2F;wait."><meta property="og:type" content="article"><meta property="og:title" content="Bulk Task Optimization in C#"><meta property="og:url" content="https://blog.tonys-studio.top/posts/Bulk-Task-Optimization-in-C/"><meta property="og:site_name" content="TONY&#39;S STUDIO"><meta property="og:description" content="Optimize bulk task in C# using async&#x2F;wait."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/08.jpeg"><meta property="article:published_time" content="2023-12-16T05:45:51.000Z"><meta property="article:modified_time" content="2025-10-20T13:03:42.318Z"><meta property="article:author" content="Tony Lewis"><meta property="article:tag" content="Repo Available"><meta property="article:tag" content="C#"><meta property="article:tag" content="Concurrency"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/08.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bulk Task Optimization in C#",
  "url": "https://blog.tonys-studio.top/posts/Bulk-Task-Optimization-in-C/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/08.jpeg",
  "datePublished": "2023-12-16T05:45:51.000Z",
  "dateModified": "2025-10-20T13:03:42.318Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Lewis",
      "url": "https://www.tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/Bulk-Task-Optimization-in-C/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//www.clarity.ms"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#300303")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","undefined")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),r=window.matchMedia("(prefers-color-scheme: dark)"),c=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(c.matches)a();else if(r.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}r.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?o():a())})}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a)}(),btf.addGlobalFn("pjaxComplete",()=>{_hmt.push(["_trackPageview",window.location.pathname])},"baidu_analytics")</script><script>!function(t,e,n,c,r,s,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/sthrplbt7c",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,a)}(window,document,"clarity","script")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:3,unescape:!1,pagination:{enable:!0,hitsPerPage:8},languages:{hits_empty:"No results found for: ${query}",hits_stats:"${hits} articles found"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!1,post:!1},runtime:"days",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:256,languages:{author:"Author: Tony Lewis",link:"Link: ",source:"Source: TONY'S STUDIO",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#871798",bgDark:"#C81025",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!1,islazyloadPlugin:!1,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Bulk Task Optimization in C#",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/static/custom.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.6/lib/runtime.min.css" media="print" onload='this.media="all"'><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",()=>{Pace.restart()},"pace_restart")</script><link rel="stylesheet" href="/static/barber-shop.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/background.png)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/08.jpeg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">Bulk Task Optimization in C#</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> Back to Home</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Bulk Task Optimization in C#</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-12-16T05:45:51.000Z" title="Created Dec. 16th, 2023 - 13:45:51 13:45:51">Dec. 16th, 2023 - 13:45:51</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-10-20T13:03:42.318Z" title="Updated Oct. 20th, 2025 - 21:03:42 21:03:42">Oct. 20th, 2025 - 21:03:42</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Software-Engineering/">Software Engineering</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Software-Engineering/Best-Practices/">Best Practices</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">1.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>9mins</span></span><span class="post-meta-separator">|</span><span data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/Bulk-Task-Optimization-in-C/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/Bulk-Task-Optimization-in-C/#post-comment"><span class="waline-comment-count" data-path="/posts/Bulk-Task-Optimization-in-C/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p style="text-align:center"><i>&ldquo;Life is not just the passing of time.</i><br><i>Life is the collection of experiences and their intensity.&rdquo;</i></p><p style="text-align:right"><i>&mdash; Jim Rohn</i></p><h1 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h1><p>Recently, I‚Äôm doing some data processing works, in which performance is quite a challenge. So, think of it, you have a big data set, separated to many parts, each containing many data entries. (You can take that data is in form of JSON.) You want to analyze them, and finally put them to your database. What is the basic procedure to do this?</p><ul><li>Open the file, read all JSON objects to a list.</li><li>Then process the list of JSON, and convert it to a list of models you want to put into the database.</li><li>At last, use a bulk insert to put them to the database.</li></ul><p>Easy, huh? üòè But, what if, the size of the data file is count in <strong>GB</strong>, which may contain millions of data entries? üò® In this case, simply load all data into memory is not feasible. And such large chunk of data may overwhelm relational database. For example, MySQL will likely to crash, causing the whole database unavailable. So, what‚Äôs the cure? ü§î</p><p>Fortunately, we are using C#, which provides many approaches to deal with this.</p><div class="note warning flat"><p>This article contains many codes, be prepared. ü´°</p></div><div class="note info flat"><p>You can find the source code at <a target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil/Bulk-Task-Optimization">Bulk Task Optimization</a>.</p></div><hr><h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><p>To make it clear, I‚Äôll show you a basic outline of the program. First, is our <code>ITask</code> interface. You know, for test, our data size is much smaller.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">ITask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> DataSize = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> DataProcessingTime = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> DataSavingTime = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Run</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And, our original task without any optimization. Exactly three steps as we mentioned above. Here I used <code>Sleep</code> to simulate time consuming tasks.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OriginalTask</span> : <span class="title">ITask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Run</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;<span class="built_in">int</span>&gt; data = LoadData();</span><br><span class="line">        ProcessData(data);</span><br><span class="line">        SaveData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;<span class="built_in">int</span>&gt; <span class="title">LoadData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;<span class="built_in">int</span>&gt; data = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ITask.DataSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            data.Add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ProcessData</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">int</span> item <span class="keyword">in</span> data)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.Write(item);</span><br><span class="line">            Console.Write(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            Thread.Sleep(ITask.DataProcessingTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SaveData</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Saving data...&quot;</span>);</span><br><span class="line">        Thread.Sleep(ITask.DataSavingTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And our benchmark class.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Globalization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Benchmark</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Measure</span>(<span class="params"><span class="built_in">string</span> name, ITask task</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;----- Benchmarking <span class="subst">&#123;name&#125;</span>...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Stopwatch stopwatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopwatch.Start();</span><br><span class="line">        task.Run();</span><br><span class="line">        stopwatch.Stop();</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;----- Elapsed time: &#123;0&#125;&quot;</span>, stopwatch.ElapsedMilliseconds.ToString(CultureInfo.InvariantCulture));</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>So in our main function, we can simply run and benchmark our task.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Benchmark.Measure(<span class="string">&quot;Original Task&quot;</span>, <span class="keyword">new</span> OriginalTask());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="Memory-Optimization"><a href="#Memory-Optimization" class="headerlink" title="Memory Optimization"></a>Memory Optimization</h1><p>So first, let‚Äôs deal with memory issues. The problems we‚Äôve encountered can be summarized as follows.</p><ul><li>A data file is too large to be loaded into memory.</li><li>Bulk update size is too large for the database.</li></ul><p>Let‚Äôs solve them one by one.</p><h2 id="Load-part-of-the-file"><a href="#Load-part-of-the-file" class="headerlink" title="Load part of the file?"></a>Load part of the file?</h2><p>In traditional C or C++, you can hardly think of a way to achieve this with minimal effort. Of course you can, just similar to <code>fgets</code> or else, but may not be that graceful. However, in C#, the dream comes true with <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/statements/yield"><code>yield</code> statement</a>.</p><p>All you need is to replace this <code>int</code> generator with a file reader. So in this way, we reduced our memory use in loading data.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">LoadPartTask</span> : <span class="title">ITask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Run</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;<span class="built_in">int</span>&gt; data = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> item <span class="keyword">in</span> <span class="title">AllData</span>())</span></span><br><span class="line">        &#123;</span><br><span class="line">            data.Add(ProcessData(item));</span><br><span class="line">        &#125;</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        SaveData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">AllData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ITask.DataSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">ProcessData</span>(<span class="params"><span class="built_in">int</span> item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.Write(item);</span><br><span class="line">        Console.Write(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        Thread.Sleep(ITask.DataProcessingTime);</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SaveData</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Saving data...&quot;</span>);</span><br><span class="line">        Thread.Sleep(ITask.DataSavingTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Split-up-bulk-update"><a href="#Split-up-bulk-update" class="headerlink" title="Split up bulk update?"></a>Split up bulk update?</h2><p>Well, this is simple, just split the data chunk. It differs with <code>LoadPartTask</code> only in <code>Run()</code>.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">SplitBulkTask</span> : <span class="title">ITask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Run</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;<span class="built_in">int</span>&gt; data = [];</span><br><span class="line">        <span class="built_in">int</span> bulkSize = <span class="number">5</span>;</span><br><span class="line">        <span class="built_in">int</span> currentSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> item <span class="keyword">in</span> <span class="title">AllData</span>())</span></span><br><span class="line">        &#123;</span><br><span class="line">            data.Add(ProcessData(item));</span><br><span class="line">            currentSize++;</span><br><span class="line">            <span class="keyword">if</span> (currentSize == bulkSize)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine();</span><br><span class="line">                SaveData(data);</span><br><span class="line">                data = [];</span><br><span class="line">                currentSize = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentSize &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine();</span><br><span class="line">            SaveData(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The size of bulk chunk is uncertain. It depends on your computer‚Äôs performance, the network threshold, and so on. You may need to adjust it based on the actual performance.</p><h2 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h2><p>If you run benchmark on these three, you can see how they behave. However, elapsed time means nothing as our goal here is not for speed.</p><p><img src="/posts/Bulk-Task-Optimization-in-C/image-20231216112435426.png" alt="image-20231216112435426"></p><hr><h1 id="Speed-Optimization"><a href="#Speed-Optimization" class="headerlink" title="Speed Optimization"></a>Speed Optimization</h1><h2 id="Using-async"><a href="#Using-async" class="headerlink" title="Using async"></a>Using <code>async</code></h2><p>Asynchronization is vital for speed optimization, so here we modify our <code>ITask</code> to support <code>async</code>. As we‚Äôve already solved the memory problems, here we omit the process of creating bulk chunk, taking them as a whole.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">IAsyncTask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> BulkCount = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> BulkProcessingTime = <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> BulkSavingTime = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Task <span class="title">Run</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then, for our Benchmark, we need add an overload.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Measure</span>(<span class="params"><span class="built_in">string</span> name, IAsyncTask task</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;----- Benchmarking <span class="subst">&#123;name&#125;</span>...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Stopwatch stopwatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">    stopwatch.Start();</span><br><span class="line">    task.Run().Wait();</span><br><span class="line">    stopwatch.Stop();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;----- Elapsed time: &#123;0&#125;&quot;</span>, stopwatch.ElapsedMilliseconds.ToString(CultureInfo.InvariantCulture));</span><br><span class="line">    Console.WriteLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Basic-async-task"><a href="#Basic-async-task" class="headerlink" title="Basic async task"></a>Basic async task</h2><p>Below is a preliminary version of your async task. We take some time to get bulk chunk, then some other to save the bulk. Later, our improvement will be done in <code>Run()</code> only since other process is memory related, and has been solved earlier.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BasicTask</span> : <span class="title">IAsyncTask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Run</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="function"><span class="built_in">int</span> item <span class="keyword">in</span> <span class="title">AllBulk</span>())</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.Write(<span class="string">$&quot;<span class="subst">&#123;item&#125;</span> &quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> SaveBulk(item);</span><br><span class="line">        &#125;</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">AllBulk</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; IAsyncTask.BulkCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Thread.Sleep(IAsyncTask.BulkProcessingTime);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">SaveBulk</span>(<span class="params"><span class="built_in">int</span> bulk</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> Task.Delay(IAsyncTask.BulkSavingTime);</span><br><span class="line">        Console.Write(<span class="string">$&quot;<span class="subst">&#123;bulk&#125;</span> &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you run benchmark on it, you‚Äôll see that, <code>async</code> does not work, as tasks are still done synchronized. Why?</p><p><img src="/posts/Bulk-Task-Optimization-in-C/image-20231216131442501.png" alt="image-20231216131442501"></p><p>This problem bothers me quite long, but the answer is quite straightforward. That is, we always <code>await</code> for the result, so that all operations are in a fixed order, which then cannot be paralleled.</p><p>So you may wonder again, in this case, how <code>async</code> works? Well, it does run asynchronized, but, with other threads. Itself still run synchronized.</p><h2 id="Pipeline-tasks"><a href="#Pipeline-tasks" class="headerlink" title="Pipeline tasks"></a>Pipeline tasks</h2><p>So how to make <code>Run()</code> itself run multiple tasks asynchronously? That is, creating more tasks and pipelining them. üò≤ The core problem is to identify processes that can be run parallelly, which, in our case, is getting bulk chunk, and saving data.</p><p>Here we create a pipeline with a max capacity of 5. At the beginning, initialize them with <code>CompletedTask</code>, so that the first run will not be blocked. Just remember to wait for all tasks to finish in the end. Other methods remain the same.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">PipelineTask</span> : <span class="title">IAsyncTask</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> MaxPipeline = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Task[] _tasks = <span class="keyword">new</span> Task[MaxPipeline];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Run</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; MaxPipeline; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            _tasks[i] = Task.CompletedTask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> currentTask = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="function"><span class="built_in">int</span> item <span class="keyword">in</span> <span class="title">AllBulk</span>())</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.Write(<span class="string">$&quot;<span class="subst">&#123;item&#125;</span> &quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> _tasks[currentTask];</span><br><span class="line">            _tasks[currentTask] = SaveBulk(item);</span><br><span class="line">            currentTask = (currentTask + <span class="number">1</span>) % MaxPipeline;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Task.WaitAll(_tasks);</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This way, when we call <code>SaveBulk</code>, the program will not be blocked. Instead, it only records the task, so that later we can wait for it. If the task already completed when wait for it, it means the pipeline is not busy. In this case, we reached the maximum speed, as the total time we spent is roughly all in <code>AllBulk()</code>. Otherwise, the pipeline is busy, but we can still get some <code>async</code> benefits.</p><h2 id="Benchmark-1"><a href="#Benchmark-1" class="headerlink" title="Benchmark"></a>Benchmark</h2><p>Here is the bench mark between basic async task and pipelined async task. Improvement is obvious.</p><p><img src="/posts/Bulk-Task-Optimization-in-C/image-20231216131435488.png" alt="image-20231216131435488"></p><h2 id="Tuning-pipeline-size"><a href="#Tuning-pipeline-size" class="headerlink" title="Tuning pipeline size"></a>Tuning pipeline size</h2><p>As we just mentioned, the performance largely rely on whether the pipeline is busy or not. So what‚Äôs a proper size for pipeline?</p><p>You can adjust pipeline size <code>MaxPipeline</code>, <code>BulkProcessingTime</code> and <code>BulkSavingTime</code> to find out. But in case you do not want to do it personally, I give you the answer. That is, <code>MaxPipeline ‚âà BulkSavingTime / BulkProcessingTime</code>. If <code>BulkProcessingTime</code> is greater than <code>BulkSavingTime</code>, size of 2 can do the job. Too many pipeline slots will not improve performance, just a little bit waste of resource.</p><h2 id="Advantages-against-traditional-thread"><a href="#Advantages-against-traditional-thread" class="headerlink" title="Advantages against traditional thread"></a>Advantages against traditional thread</h2><p>Using async method does create threads, but it has some advantages against traditional threading.</p><p>First, it is more flexible. You may already realized it is the classic ‚ÄúProducer - Consumer‚Äù model. For the traditional approach, we have to create a fixed number of threads, and using locks to sync them. However, simply using <code>aync/await</code> can dynamically create threads, reducing the number of idle threads. And, it eliminates the use of lock.</p><p>Second, ‚Ä¶ (<del>idk</del>)</p><hr><h1 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h1><p>Well, I think we‚Äôre getting better understanding of async task now. ü•≥</p><p>Have to say, C# is a good language. But, we always love C++. ü•∞</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.tonys-studio.top">Tony Lewis</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/Bulk-Task-Optimization-in-C/">https://blog.tonys-studio.top/posts/Bulk-Task-Optimization-in-C/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Repo-Available/">Repo Available</a><a class="post-meta__tags" href="/tags/C/">C#</a><a class="post-meta__tags" href="/tags/Concurrency/">Concurrency</a></div><div class="post-share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_wechat"></a><a class="a2a_button_qzone"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Empower-ASP-NET-Core-with-Elasticsearch/" title="Empower ASP.NET Core With Elasticsearch"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/05/04.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Empower ASP.NET Core With Elasticsearch</div></div><div class="info-2"><div class="info-item-1">Using Elasticsearch in ASP.NET Core project with NEST</div></div></div></a><a class="pagination-related" href="/posts/Cross-platform-Development-with-NET-Core/" title="Cross-Platform Development With .NET Core"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/02/03.jpeg" onerror='onerror=null,src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Cross-Platform Development With .NET Core</div></div><div class="info-2"><div class="info-item-1">Introduction to .NET Core cross-platform development.</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Thoughts-on-Building-Fluent-API/" title="Thoughts on Building Fluent API"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/06/02.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 1st, 2024 - 15:22:25</div><div class="info-item-2">Thoughts on Building Fluent API</div></div><div class="info-2"><div class="info-item-1">Getting started with your own Fluent API</div></div></div></a><a class="pagination-related" href="/posts/AOP-in-Spring-Boot/" title="AOP in Spring Boot"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/04/04.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jul. 12th, 2024 - 11:26:45</div><div class="info-item-2">AOP in Spring Boot</div></div><div class="info-2"><div class="info-item-1">Concept and application of Aspect-oriented programming in Spring Boot</div></div></div></a><a class="pagination-related" href="/posts/Deployment-Practice-with-Kubernetes/" title="Deployment Practice With Kubernetes"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/ahsoka/05.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Aug. 4th, 2024 - 17:27:36</div><div class="info-item-2">Deployment Practice With Kubernetes</div></div><div class="info-2"><div class="info-item-1">A practical walk through for deployment via Kubernetes</div></div></div></a><a class="pagination-related" href="/posts/Dungeon/" title="Dungeon"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/Dungeon.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jan. 4th, 2023 - 21:45:04</div><div class="info-item-2">Dungeon</div></div><div class="info-2"><div class="info-item-1">A rogue-like game developed with EasyX and FMOD in C++.</div></div></div></a><a class="pagination-related" href="/posts/Getting-Started-with-CUDA/" title="Getting Started With CUDA"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/14/10.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 4th, 2024 - 14:05:56</div><div class="info-item-2">Getting Started With CUDA</div></div><div class="info-2"><div class="info-item-1">Take your first step into CUDA&reg; to unleash the power of your GPU!</div></div></div></a><a class="pagination-related" href="/posts/Introduction-to-C-Game-Development/" title="Introduction to C++ Game Development"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/Introduction-to-C-Game-Development.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Aug. 12th, 2023 - 11:53:56</div><div class="info-item-2">Introduction to C++ Game Development</div></div><div class="info-2"><div class="info-item-1">Get started with C++ game development using EasyX</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/avatar.png" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/missing.gif"' alt="avatar"></div><div class="author-info-name">Tony Lewis</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">87</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Hello there!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Scenario"><span class="toc-text">Scenario</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Preparation"><span class="toc-text">Preparation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Memory-Optimization"><span class="toc-text">Memory Optimization</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Load-part-of-the-file"><span class="toc-text">Load part of the file?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Split-up-bulk-update"><span class="toc-text">Split up bulk update?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Benchmark"><span class="toc-text">Benchmark</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Speed-Optimization"><span class="toc-text">Speed Optimization</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-async"><span class="toc-text">Using async</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-async-task"><span class="toc-text">Basic async task</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline-tasks"><span class="toc-text">Pipeline tasks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Benchmark-1"><span class="toc-text">Benchmark</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tuning-pipeline-size"><span class="toc-text">Tuning pipeline size</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Advantages-against-traditional-thread"><span class="toc-text">Advantages against traditional thread</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Epilogue"><span class="toc-text">Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Game-Engine-0-to-1-03-What-Fonts-Do-I-have-A-Cross-Platform-Solution/" title="Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/14.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution"></a><div class="content"><a class="title" href="/posts/Game-Engine-0-to-1-03-What-Fonts-Do-I-have-A-Cross-Platform-Solution/" title="Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution">Game Engine 0 to 1 (03): What Fonts Do I Have? a Cross-Platform Solution</a><time datetime="2025-10-20T12:59:54.000Z" title="Created Oct. 20th, 2025 - 20:59:54 20:59:54">Oct. 20th, 2025 - 20:59:54</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/21/07.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="A Fancy and Practical Zsh Configuration"></a><div class="content"><a class="title" href="/posts/A-Fancy-And-Practical-Zsh-Configuration/" title="A Fancy and Practical Zsh Configuration">A Fancy and Practical Zsh Configuration</a><time datetime="2025-09-26T14:15:54.000Z" title="Created Sep. 26th, 2025 - 22:15:54 22:15:54">Sep. 26th, 2025 - 22:15:54</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Lambda-Calculus-A-Preliminary-View/" title="Lambda Calculus: A Preliminary View"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/mando/13/00.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Lambda Calculus: A Preliminary View"></a><div class="content"><a class="title" href="/posts/Lambda-Calculus-A-Preliminary-View/" title="Lambda Calculus: A Preliminary View">Lambda Calculus: A Preliminary View</a><time datetime="2025-09-16T08:25:34.000Z" title="Created Sep. 16th, 2025 - 16:25:34 16:25:34">Sep. 16th, 2025 - 16:25:34</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Music-Notation-with-Avid-Sibelius/" title="Music Notation With Avid Sibelius"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/posts/Music-Notation-with-Avid-Sibelius.jpg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Music Notation With Avid Sibelius"></a><div class="content"><a class="title" href="/posts/Music-Notation-with-Avid-Sibelius/" title="Music Notation With Avid Sibelius">Music Notation With Avid Sibelius</a><time datetime="2025-09-03T04:34:54.000Z" title="Created Sep. 3rd, 2025 - 12:34:54 12:34:54">Sep. 3rd, 2025 - 12:34:54</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/06/10.jpeg" onerror='this.onerror=null,this.src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/404.png"' alt="Getting Started With Coq"></a><div class="content"><a class="title" href="/posts/Getting-Started-with-Coq/" title="Getting Started With Coq">Getting Started With Coq</a><time datetime="2025-08-08T04:30:12.000Z" title="Created Aug. 8th, 2025 - 12:30:12 12:30:12">Aug. 8th, 2025 - 12:30:12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/static/cover/boba/07/08.jpeg)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Tony Lewis</span></div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"forest";e.forEach((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,a=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(r,a),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then(({svg:e})=>m(e))})})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{let n=window.walineFn||null;const e="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,t=(n,t=document,i=window.location.pathname)=>{const o=n({el:t.querySelector("#waline-wrap"),serverURL:"https://comment.tonys-studio.top",pageview:!0,dark:'html[data-theme="dark"]',comment:!0,path:i});e&&(window.shuoshuoComment.destroyWaline=()=>{o.destroy(),t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))})},i=(e,i)=>{n?t(n,e,i):btf.getCSS("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css").then(()=>import("https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js")).then(({init:o})=>{n=o||Waline.init,t(n,e,i),window.walineFn=n})};e?window.shuoshuoComment={loadComment:i}:setTimeout(i,0)})()</script></div><script src="/static/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> Loading Database</span></div><div class="local-search-input"><input placeholder="Looking for something?üîç" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax>function butterfly_footer_beautify_injector_config(){var e=document.getElementById("footer");console.log("Â∑≤ÊåÇËΩΩbutterfly_footer_beautify"),e.insertAdjacentHTML("beforeend",'<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="Framework Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo%205.4.2-blue?style=flat-square&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="Theme Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly%205.4.3-6513df?style=flat-square&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally." title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat-square&amp;logo=Claris" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_footer_beautify_injector_config()</script></body></html>