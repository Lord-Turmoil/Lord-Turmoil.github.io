<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>File System IPC | TONY'S STUDIO</title><meta name="author" content="Tony Skywalker"><meta name="copyright" content="Tony Skywalker"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#300303"><meta name="description" content="Brief on File System IPC Mechanism">
<meta property="og:type" content="article">
<meta property="og:title" content="File System IPC">
<meta property="og:url" content="https://blog.tonys-studio.top/posts/File-System-IPC/">
<meta property="og:site_name" content="TONY&#39;S STUDIO">
<meta property="og:description" content="Brief on File System IPC Mechanism">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/08.jpeg">
<meta property="article:published_time" content="2023-05-06T03:47:57.000Z">
<meta property="article:modified_time" content="2025-04-03T01:53:33.537Z">
<meta property="article:author" content="Tony Skywalker">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="BUAA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/08.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "File System IPC",
  "url": "https://blog.tonys-studio.top/posts/File-System-IPC/",
  "image": "https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/08.jpeg",
  "datePublished": "2023-05-06T03:47:57.000Z",
  "dateModified": "2025-04-03T01:53:33.537Z",
  "author": [
    {
      "@type": "Person",
      "name": "Tony Skywalker",
      "url": "https://tonys-studio.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/favicon.svg"><link rel="canonical" href="https://blog.tonys-studio.top/posts/File-System-IPC/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="codeva-R6O16YoeQt"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#300303')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?68629f5da0a0c3347b896920fbf164b5";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "h2swkizghx");</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":10,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":256,"languages":{"author":"Author: Tony Skywalker","link":"Link: ","source":"Source: TONY'S STUDIO","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#871798","bgDark":"#C81025","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'File System IPC',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.6/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/css/barber-shop.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/back_img.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/support/"><i class="fa-fw fas fa-hand-holding-heart"></i><span> Support</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/08.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/logo.svg" alt="Logo"><span class="site-name">TONY'S STUDIO</span></a><a class="nav-page-title" href="/"><span class="site-name">File System IPC</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-newspaper"></i><span> Posts</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/support/"><i class="fa-fw fas fa-hand-holding-heart"></i><span> Support</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-jedi fa-beat"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">File System IPC</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-05-06T03:47:57.000Z" title="Created May. 6th, 2023 - 11:47:57 11:47:57">May. 6th, 2023 - 11:47:57</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-04-03T01:53:33.537Z" title="Updated Apr. 3rd, 2025 - 09:53:33 09:53:33">Apr. 3rd, 2025 - 09:53:33</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/">BUAA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/BUAA/OS/">OS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">4.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>26mins</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span class="waline-pageview-count" data-path="/posts/File-System-IPC/"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/File-System-IPC/#post-comment"><span class="waline-comment-count" data-path="/posts/File-System-IPC/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="BUAA-2023-Spring-OS"><a href="#BUAA-2023-Spring-OS" class="headerlink" title="BUAA 2023 Spring OS"></a>BUAA 2023 Spring OS</h1><hr>
<blockquote>
<p><strong>Notice:</strong> This article serves as a DLC for <a href="../Lab-5-Reflection/">Lab 5 Reflection</a>. The main stuffs are there. 🫡</p>
<p><strong>Warning:</strong> If you are confused about some concepts in this article, or feel contents missing, please refer to that post first. (You can open two browser tabs at the same time.) 😉 </p>
</blockquote>
<hr>
<h1 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h1><h2 id="1-1-Main-Loop"><a href="#1-1-Main-Loop" class="headerlink" title="1.1 Main Loop"></a>1.1 Main Loop</h2><p>As we know, File System is an independent process in user space, so it has a main function. Let’s see what does it do.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/serv.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    user_assert(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> File) == BY2FILE);</span><br><span class="line">    debugf(<span class="string">&quot;FS is running\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    serve_init();</span><br><span class="line">    fs_init();</span><br><span class="line">    serve();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So, we can see that after two initialization, it will start to server other processes.</p>
<h2 id="1-2-Initialization"><a href="#1-2-Initialization" class="headerlink" title="1.2 Initialization"></a>1.2 Initialization</h2><p>File System’s initialization can be divided into two parts as we see above.</p>
<h3 id="1-2-1-serve-init"><a href="#1-2-1-serve-init" class="headerlink" title="1.2.1 serve_init"></a>1.2.1 <code>serve_init</code></h3><p>This part is quite simple, but it involves another concept - <code>opentab</code>. It is the global record for open files. And here we just initialized all the <code>opentab</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/serv.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">serve_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Set virtual address to map.</span></span><br><span class="line">    u_int va = FILEVA;</span><br><span class="line">    <span class="comment">// Initial array opentab.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAXOPEN; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        opentab[i].o_fileid = i;</span><br><span class="line">        opentab[i].o_ff = (<span class="keyword">struct</span> Filefd*)va;</span><br><span class="line">        va += BY2PG;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So let’s see what the hell <code>opentab</code> is. And oh, here it is. With every bit set to zero, except <code>opentab[0]</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/serv.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Open</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">File</span>* <span class="title">o_file</span>;</span> <span class="comment">// mapped descriptor for open file</span></span><br><span class="line">    u_int o_fileid;	     <span class="comment">// file id</span></span><br><span class="line">    <span class="type">int</span> o_mode;	         <span class="comment">// open mode</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Filefd</span>* <span class="title">o_ff</span>;</span> <span class="comment">// va of filefd page</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize to force into data section</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Open</span> <span class="title">opentab</span>[<span class="title">MAXOPEN</span>] =</span> &#123; &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125; &#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>As we know, if we do not initialize <code>opentab</code>, it will be placed to <code>.bss</code> section. So here we make a intentionally nonsense initialization to make it into <code>.data</code> section.</p>
<span class="hide-inline"><button type="button" class="hide-button" style>The reason is that...</button><span class="hide-content">How I suppose to know? 😭</span></span>
</blockquote>
<p>And, the <code>Open::o_mode</code> here is the same as the open mode in file. The available modes are defined in <code>user/include/lib.h</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> O_RDONLY  0x0000  <span class="comment">/* open for reading only */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> O_WRONLY  0x0001  <span class="comment">/* open for writing only */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> O_RDWR    0x0002  <span class="comment">/* open for reading and writing */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> O_ACCMODE 0x0003  <span class="comment">/* mask for above modes */</span></span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-fs-init"><a href="#1-2-2-fs-init" class="headerlink" title="1.2.2 fs_init"></a>1.2.2 <code>fs_init</code></h3><p>This part is more complicated, and can be divided again into three parts.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">fs_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    read_super();</span><br><span class="line">    check_write_block();</span><br><span class="line">    read_bitmap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<details class="toggle"><summary class="toggle-button" style>read_super</summary><div class="toggle-content"><p>Here, we simple read the super block from the disk and validate its content.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  fs/fs.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_super</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: read super block.</span></span><br><span class="line">    <span class="keyword">if</span> ((r = read_block(<span class="number">1</span>, &amp;blk, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        user_panic(<span class="string">&quot;cannot read superblock: %e&quot;</span>, r);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* super = blk;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Check fs magic nunber.</span></span><br><span class="line">    <span class="keyword">if</span> (super-&gt;s_magic != FS_MAGIC)</span><br><span class="line">        user_panic(<span class="string">&quot;bad file system magic number %x %x&quot;</span>, super-&gt;s_magic, FS_MAGIC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: validate disk size.</span></span><br><span class="line">    <span class="keyword">if</span> (super-&gt;s_nblocks &gt; DISKMAX / BY2BLK)</span><br><span class="line">        user_panic(<span class="string">&quot;file system is too large&quot;</span>);</span><br><span class="line"></span><br><span class="line">    debugf(<span class="string">&quot;superblock is good\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<details class="toggle"><summary class="toggle-button" style>check_write_block</summary><div class="toggle-content"><p>Well, I think this serves as a self diagnose?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">check_write_block</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    super = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// backup the super block.</span></span><br><span class="line">    <span class="comment">// copy the data in super block to the first block on the disk.</span></span><br><span class="line">    read_block(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">char</span>*)diskaddr(<span class="number">0</span>), (<span class="type">char</span>*)diskaddr(<span class="number">1</span>), BY2PG);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// smash it</span></span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span>*)diskaddr(<span class="number">1</span>), <span class="string">&quot;OOPS!\n&quot;</span>);</span><br><span class="line">    write_block(<span class="number">1</span>);</span><br><span class="line">    user_assert(block_is_mapped(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear it out</span></span><br><span class="line">    syscall_mem_unmap(<span class="number">0</span>, diskaddr(<span class="number">1</span>));</span><br><span class="line">    user_assert(!block_is_mapped(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validate the data read from the disk.</span></span><br><span class="line">    read_block(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    user_assert(<span class="built_in">strcmp</span>((<span class="type">char</span>*)diskaddr(<span class="number">1</span>), <span class="string">&quot;OOPS!\n&quot;</span>) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restore the super block.</span></span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">char</span>*)diskaddr(<span class="number">1</span>), (<span class="type">char</span>*)diskaddr(<span class="number">0</span>), BY2PG);</span><br><span class="line">    write_block(<span class="number">1</span>);</span><br><span class="line">    super = (<span class="keyword">struct</span> Super*)diskaddr(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><span class="hide-inline"><button type="button" class="hide-button" style>The reason we do this is that…</button><span class="hide-content">Again! How I suppose to know? 🥺</span></span></p>
</blockquote>
</div></details>

<details class="toggle"><summary class="toggle-button" style>read_bitmap</summary><div class="toggle-content"><p>We’ve already introduced it in that post, so here is the code again. 🤪</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/fs.c</span></span><br><span class="line"><span class="type">uint32_t</span>* bitmap;</span><br><span class="line"><span class="type">void</span> <span class="title function_">read_bitmap</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span>* blk = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: Calculate the number of the bitmap blocks, and read them into memory.</span></span><br><span class="line">    u_int nbitmap = super-&gt;s_nblocks / BIT2BLK + !!(super-&gt;s_nblocks % BIT2BLK);</span><br><span class="line">    <span class="keyword">for</span> (u_int i = <span class="number">0</span>; i &lt; nbitmap; i++)</span><br><span class="line">        read_block(i + <span class="number">2</span>, blk, <span class="number">0</span>);</span><br><span class="line">    bitmap = diskaddr(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Make sure the reserved and root blocks are marked in-use.</span></span><br><span class="line">    user_assert(!block_is_free(<span class="number">0</span>));</span><br><span class="line">    user_assert(!block_is_free(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: Make sure all bitmap blocks are marked in-use.</span></span><br><span class="line">    <span class="keyword">for</span> (u_int i = <span class="number">0</span>; i &lt; nbitmap; i++)</span><br><span class="line">        user_assert(!block_is_free(i + <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    debugf(<span class="string">&quot;read_bitmap is good\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<h2 id="1-3-Serve"><a href="#1-3-Serve" class="headerlink" title="1.3 Serve"></a>1.3 Serve</h2><p>After initialization, we can start to serve other processes. It is a never ending loop. See it by your self.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/serv.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">serve</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_int req, whom, perm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; ; )</span><br><span class="line">    &#123;</span><br><span class="line">        perm = <span class="number">0</span>;</span><br><span class="line">        req = ipc_recv(&amp;whom, (<span class="type">void</span>*)REQVA, &amp;perm);</span><br><span class="line">        <span class="comment">// All requests must contain an argument page</span></span><br><span class="line">        <span class="keyword">if</span> (!(perm &amp; PTE_V))</span><br><span class="line">        &#123;</span><br><span class="line">            debugf(<span class="string">&quot;Invalid request from %08x: no argument page\n&quot;</span>, whom);</span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">// just leave it hanging, waiting for the next request.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (req)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_OPEN:</span><br><span class="line">                serve_open(whom, (<span class="keyword">struct</span> Fsreq_open*)REQVA);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_MAP:</span><br><span class="line">                serve_map(whom, (<span class="keyword">struct</span> Fsreq_map*)REQVA);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_SET_SIZE:</span><br><span class="line">                serve_set_size(whom, (<span class="keyword">struct</span> Fsreq_set_size*)REQVA);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_CLOSE:</span><br><span class="line">                serve_close(whom, (<span class="keyword">struct</span> Fsreq_close*)REQVA);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_DIRTY:</span><br><span class="line">                serve_dirty(whom, (<span class="keyword">struct</span> Fsreq_dirty*)REQVA);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_REMOVE:</span><br><span class="line">                serve_remove(whom, (<span class="keyword">struct</span> Fsreq_remove*)REQVA);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FSREQ_SYNC:</span><br><span class="line">                serve_sync(whom);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                debugf(<span class="string">&quot;Invalid request code %d from %08x\n&quot;</span>, whom, req);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * IPC receiver does not map page to va by itself, this map is done</span></span><br><span class="line"><span class="comment">		 * by sender at the end of transaction. So... to save memory? Receiver</span></span><br><span class="line"><span class="comment">		 * here has to unmap this page by itself.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">        syscall_mem_unmap(<span class="number">0</span>, (<span class="type">void</span>*)REQVA);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The involved macros and request structures are defined in <code>user/include/fdreq.h</code></p>
</blockquote>
<p>So this is just a collection of requests, huh? (<del>Why not use a function pointer table like exceptions?</del> 🫤)</p>
<hr>
<h1 id="2-File-System-IPC"><a href="#2-File-System-IPC" class="headerlink" title="2. File System IPC"></a>2. File System IPC</h1><p>As user processes, we simply send a request to File System to get the corresponding service, and waiting the response from File System. For File System, as mentioned above, we just receive the request, handle it, and send the response back to the sender. Nice communication, right? 🤨</p>
<h2 id="2-1-IPC-Library-Function"><a href="#2-1-IPC-Library-Function" class="headerlink" title="2.1 IPC Library Function"></a>2.1 IPC Library Function</h2><p>In the last Lab, we implemented IPC related system calls, but we didn’t mention their user library interface. So… Here they are.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include/lib.h</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ipc_send</span><span class="params">(u_int whom, u_int val, <span class="type">const</span> <span class="type">void</span>* srcva, u_int perm)</span>;</span><br><span class="line">u_int <span class="title function_">ipc_recv</span><span class="params">(u_int* whom, <span class="type">void</span>* dstva, u_int* perm)</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In case you get confused, I’d like to have a brief explanation on its parameters. The most confusing ones may be <code>srcva</code>, <code>dstva</code> and <code>perm</code>.</p>
<p>At first, <code>ipc_recv</code> must be called by the receiver to enable IPC receiving. Then, it will <strong>block</strong> the process until a message is sent. Here, <code>whom</code> and <code>perm</code> are <strong>as a return values</strong>. The only <strong>in</strong> parameter is <code>dstva</code>, it indicates, if you want, the virtual address of the receiving page.</p>
<p>Then, the sender can send the message by <code>ipc_send</code>. Here, all parameters are in, with <code>whom</code> indicates the target process ID, <code>val</code> the value, <code>srcva</code> and <code>perm</code> for the page and permission if you want. This function will call <code>syscall_ipc_try_send</code>, which will return <code>-E_IPC_NOT_RECV</code> if target and result in a busy wait.</p>
<p><strong>Important!</strong> When page is delivered, it will <strong>not</strong> create a new physical page, but only map the original page to <code>dstva</code> in <code>ipc_recv</code> with a new permission <code>perm</code> we set in <code>ipc_send</code>. So the receiver and sender may view the same page with different permissions.</p>
</blockquote>
<details class="toggle"><summary class="toggle-button" style>ipc_send/recv</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/ipc.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ipc_send</span><span class="params">(u_int whom, u_int val, <span class="type">const</span> <span class="type">void</span>* srcva, u_int perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> r;</span><br><span class="line">	<span class="keyword">while</span> ((r = syscall_ipc_try_send(whom, val, srcva, perm)) == -E_IPC_NOT_RECV)</span><br><span class="line">	&#123;</span><br><span class="line">		syscall_yield();</span><br><span class="line">	&#125;</span><br><span class="line">	user_assert(r == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u_int <span class="title function_">ipc_recv</span><span class="params">(u_int* whom, <span class="type">void</span>* dstva, u_int* perm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r = syscall_ipc_recv(dstva);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>)</span><br><span class="line">        user_panic(<span class="string">&quot;syscall_ipc_recv err: %d&quot;</span>, r);</span><br><span class="line">    <span class="keyword">if</span> (whom)</span><br><span class="line">        *whom = env-&gt;env_ipc_from;</span><br><span class="line">    <span class="keyword">if</span> (perm)</span><br><span class="line">        *perm = env-&gt;env_ipc_perm;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;env_ipc_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<h2 id="2-2-File-System-IPC-Interface"><a href="#2-2-File-System-IPC-Interface" class="headerlink" title="2.2 File System IPC Interface"></a>2.2 File System IPC Interface</h2><p>To simplify IPC <strong>to</strong> File System, user library provided some interface for such IPCs. However, the are used as auxiliary functions and are not exposed directly to user process. (Although declared in <code>user/include/lib.h</code>, it doesn’t seem to be a good isolation.)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include/lib.h</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, u_int omode, <span class="keyword">struct</span> Fd* fd)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_map</span><span class="params">(u_int fileid, u_int offset, <span class="type">void</span>* dstva)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_set_size</span><span class="params">(u_int fileid, u_int size)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_close</span><span class="params">(u_int fileid)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_dirty</span><span class="params">(u_int fileid, u_int offset)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_sync</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>I just… just don’t understand why not specify parameter name in header file. 🤬 It is really annoying. And it doesn’t seem to have optional definitions. (Perhaps there will be?)</p>
</blockquote>
<p>These functions just works as a parameter wrapper. They simply wrap parameter to corresponding request structures, and send it to File System. Actually, they ended up by calling another auxiliary function to actually send the request.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/fsipc.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">fsipc</span><span class="params">(u_int type, <span class="type">void</span>* fsreq, <span class="type">void</span>* dstva, u_int* perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	u_int whom;	<span class="comment">// redundant</span></span><br><span class="line">	<span class="comment">// Our file system server must be the 2nd env.</span></span><br><span class="line">	ipc_send(envs[<span class="number">1</span>].env_id, type, fsreq, PTE_D);	</span><br><span class="line">	<span class="keyword">return</span> ipc_recv(&amp;whom, dstva, perm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>type</code> is just the IPC enumeration, such as <code>FSREQ_OPEN</code>, <code>FSREQ_CLOSE</code> as mentioned in <code>1.3</code>.</p>
<p><code>perm</code> will be combined with <code>PTE_V</code> to be the permission bits of the page at <code>dstva</code>. It intend to make the page writable because this is where our file descriptor locates (I’ll talk about this later), and we want File System to initialize this page for us.</p>
</blockquote>
<p>For <code>fsipc_xxx</code> functions, they will wrap request parameters, and finally call <code>fsipc</code> to send the request.</p>
<details class="toggle"><summary class="toggle-button" style>fsipc_open</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include/fsipc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fsreq_open</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">char</span> req_path[MAXPATHLEN];</span><br><span class="line">	u_int req_omode;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// user/lib/fsipc.c</span></span><br><span class="line">u_char fsipcbuf[BY2PG] __attribute__((aligned(BY2PG))); <span class="comment">// shared by all fsipc_xxx functions</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsipc_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, u_int omode, <span class="keyword">struct</span> Fd* fd)</span></span><br><span class="line">&#123;</span><br><span class="line">	u_int perm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Fsreq_open</span>* <span class="title">req</span>;</span></span><br><span class="line">	req = (<span class="keyword">struct</span> Fsreq_open*)fsipcbuf;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(path) &gt;= MAXPATHLEN)</span><br><span class="line">		<span class="keyword">return</span> -E_BAD_PATH;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">strcpy</span>((<span class="type">char</span>*)req-&gt;req_path, path);</span><br><span class="line">	req-&gt;req_omode = omode;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fsipc(FSREQ_OPEN, req, fd, &amp;perm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<p>The memory exchange during file IPC may be a little confusing. Take <code>open</code> as an example. The interface for user is only <code>open</code>. It will first call <code>fsipc_open</code> to send <code>fsipcbuf</code> to file system, which contains <code>Fsreq_open</code> as raw data. Then, File System receives this page, (only one physical page, but two references!), and create a physical page to store the newly create file descriptor, and make pointer <code>Open::off</code> points at it. Finally, File System deliver this page to user. Similarly, user only share the reference. 😉</p>
<p><img src="/posts/File-System-IPC/FS-IPC.svg" alt="FS-IPC"></p>
<hr>
<h1 id="3-File-System-Handler"><a href="#3-File-System-Handler" class="headerlink" title="3. File System Handler"></a>3. File System Handler</h1><h2 id="3-1-Handler-Function"><a href="#3-1-Handler-Function" class="headerlink" title="3.1 Handler Function"></a>3.1 Handler Function</h2><p>After a request is received, File System will call corresponding handler functions to do the actual work. There are quite a lot request handlers, as you can see in <code>serve</code> function, but generally of the same pattern. So here I just want to give several examples. They are all defined locally in <code>fs/serv.c</code>.</p>
<p><code>serve_open</code> will initialize file description page the user process passes to it. Of course, it will record open file in global tab.</p>
<details class="toggle"><summary class="toggle-button" style>serve_open</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">serve_open</span><span class="params">(u_int envid, <span class="keyword">struct</span> Fsreq_open* rq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Open</span>* <span class="title">o</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find a file id.</span></span><br><span class="line">    <span class="keyword">if</span> ((r = open_alloc(&amp;o)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ipc_send(envid, r, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open the file.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">File</span>* <span class="title">f</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((r = file_open(rq-&gt;req_path, &amp;f)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ipc_send(envid, r, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save the file pointer.</span></span><br><span class="line">    o-&gt;o_file = f;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill out the Filefd structure</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Filefd</span>* <span class="title">ff</span> =</span> (<span class="keyword">struct</span> Filefd*)o-&gt;o_ff;	<span class="comment">// redundant conversion</span></span><br><span class="line">    ff-&gt;f_file = *f;</span><br><span class="line">    ff-&gt;f_fileid = o-&gt;o_fileid;</span><br><span class="line">    o-&gt;o_mode = rq-&gt;req_omode;</span><br><span class="line">    ff-&gt;f_fd.fd_omode = o-&gt;o_mode;</span><br><span class="line">    ff-&gt;f_fd.fd_dev_id = devfile.dev_id; <span class="comment">// &#x27;devfile&#x27; is the global dev struct.</span></span><br><span class="line"></span><br><span class="line">    ipc_send(envid, <span class="number">0</span>, o-&gt;o_ff, PTE_D | PTE_LIBRARY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>❗ <strong>Important:</strong> Here is the first time we use <code>PTE_LIBRARY</code> to mark a page. That’s because file descriptor is shared between parent process and child process. With this flag, <code>fork</code> will not mark this page <code>COW</code> when duplicate pages of parent process.</p>
<p>ℹRefer to this post if you forget about <code>fork</code>: <a href="/posts/Lab-4-Reflection/">Lab 4 Reflection</a>. 😱</p>
<p>⚠ <strong>Reminder:</strong> <code>Open::o_fileid</code> is not the return value of <code>open</code>, which will be introduced later.</p>
</blockquote>
</div></details>

<p><code>serve_map</code> will map the given page to requested virtual address. This is used to load file from disk. You’ll get a clear view of it later in the user library function <code>open</code>. 😌</p>
<details class="toggle"><summary class="toggle-button" style>serve_map</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">serve_map</span><span class="params">(u_int envid, <span class="keyword">struct</span> Fsreq_map* rq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Open</span>* <span class="title">pOpen</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((r = open_lookup(envid, rq-&gt;req_fileid, &amp;pOpen)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ipc_send(envid, r, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u_int filebno = rq-&gt;req_offset / BY2BLK;</span><br><span class="line">    <span class="type">void</span>* blk;</span><br><span class="line">    <span class="keyword">if</span> ((r = file_get_block(pOpen-&gt;o_file, filebno, &amp;blk)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ipc_send(envid, r, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ipc_send(envid, <span class="number">0</span>, blk, PTE_D | PTE_LIBRARY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<p>Well, nothing to say, just remove the file.</p>
<details class="toggle"><summary class="toggle-button" style>serve_remove</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">serve_remove</span><span class="params">(u_int envid, <span class="keyword">struct</span> Fsreq_remove* rq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Step 1: Remove the file specified in &#x27;rq&#x27; using &#x27;file_remove&#x27; and store its return value.</span></span><br><span class="line">    file_remove(rq-&gt;req_path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Respond the return value to the requester &#x27;envid&#x27; using &#x27;ipc_send&#x27;.</span></span><br><span class="line">    ipc_send(envid, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<h2 id="3-2-Auxiliary-Function"><a href="#3-2-Auxiliary-Function" class="headerlink" title="3.2 Auxiliary Function"></a>3.2 Auxiliary Function</h2><p>If you go through the implementations of these IPC interfaces, you may see some essential functions that I never mentioned before. You can skip this part if you’re not interested at such details.</p>
<h3 id="2-3-1-serve-open"><a href="#2-3-1-serve-open" class="headerlink" title="2.3.1 serve_open"></a>2.3.1 <code>serve_open</code></h3><p>In this handler function, we’ll open a file, and initialize the file descriptor page user passed to us. You can find the body of <code>serve_open</code> above. There are two functions that are important here, <code>open_alloc</code> and <code>file_open</code>. Let’s see ‘em.</p>
<p>First, <code>open_alloc</code> simply allocate a <code>struct Open</code> from global open tab - <code>opentab</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/serv.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open_alloc</span><span class="params">(<span class="keyword">struct</span> Open** o)</span>;</span><br></pre></td></tr></table></figure>

<details class="toggle"><summary class="toggle-button" style>open_alloc</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/serv.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open_alloc</span><span class="params">(<span class="keyword">struct</span> Open** o)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find an available open-file table entry</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXOPEN; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (pageref(opentab[i].o_ff))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> ((r = syscall_mem_alloc(<span class="number">0</span>, opentab[i].o_ff, PTE_D | PTE_LIBRARY)) &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> r;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                opentab[i].o_fileid += MAXOPEN;</span><br><span class="line">                *o = &amp;opentab[i];</span><br><span class="line">                <span class="built_in">memset</span>((<span class="type">void</span>*)opentab[i].o_ff, <span class="number">0</span>, BY2PG);</span><br><span class="line">                <span class="keyword">return</span> (*o)-&gt;o_fileid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -E_MAX_OPEN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Here, we just allocate a page to store file descriptor. A little waste of memory, but makes it easier for memory exchange. And you can see that, if this open tab is used, it simple add a offset to <code>Open::o_fileid</code> to record the time it used. Interesting, huh. After this, the open file will be recorded in File System’s global open tab. </p>
<p><strong>Notice:</strong> <code>opentab</code> array is always there, what we allocate is the page at <code>Open::o_off</code>. Only the first allocation of a <code>Open</code> requires memory allocation, the page will not be freed, and will be reused next time.</p>
</blockquote>
</div></details>

<p>After a open tab is allocated, it can be looked up.</p>
<details class="toggle"><summary class="toggle-button" style>open_lookup</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">open_lookup</span><span class="params">(u_int envid, u_int fileid, <span class="keyword">struct</span> Open** po)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Open</span>* <span class="title">o</span> =</span> &amp;opentab[fileid % MAXOPEN];</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (pageref(o-&gt;o_ff) == <span class="number">1</span> || o-&gt;o_fileid != fileid)</span><br><span class="line">		<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">	*po = o;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></details>

<p>Here is a explanation for <code>pageref</code> check in <code>open_alloc</code> and <code>open_lookup</code>, read it as you will. 😉</p>
<details class="toggle"><summary class="toggle-button" style>explanation on `pageref`</summary><div class="toggle-content"><p>In <code>open_alloc</code>, we use <code>pageref</code> to determine whether a open tab is allocated or not. If not, then the reference is sure to be 0, and will be created, which will make this value <strong>1</strong>. Then, when <code>serve_open</code> ends, it will use <code>page_insert</code> to deliver the return value, which will make it <strong>2</strong>. <strong>Only when user process close all files can this value become 1 again.</strong> So reference <strong>1</strong> on allocation means it is to be used by a new file and should initialize again.</p>
<p>Then in <code>open_lookup</code>, we validate the <code>pageref</code> of <code>open</code>. Why <strong>1</strong> is invalid? Because only a successful open will complete all steps and return the page back to user process, make this reference <strong>2</strong>. Thus <strong>1</strong> may indicate a failure of open! Or, the user process just closed the file. More than 2 just means many processes share the same file, e.g. parent and child process. 🥱</p>
</div></details>

<p>Then, file open will get the corresponding <code>struct File</code>. Don’t be deceived by the name of this function. It is not literally “open file”, but only find the corresponding <code>struct File</code> with the given path. It’s so simple to be put here with out hide block.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/fs.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">file_open</span><span class="params">(<span class="type">char</span>* path, <span class="keyword">struct</span> File** file)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> walk_path(path, <span class="number">0</span>, file, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In case you forget, I put this figure here again. Am I nice? 🥰 So what this function get is actually just the <code>struct File</code>.</p>
<img src="/posts/File-System-IPC/File-Layout.svg" alt="File-Layout" style="zoom:80%;">

<p>So, what is <code>walk_path</code> again?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/fs.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">walk_path</span><span class="params">(<span class="type">char</span>* path, <span class="keyword">struct</span> File** pdir, <span class="keyword">struct</span> File** pfile, <span class="type">char</span>* lastelem)</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Some explanation to its parameters. Here, only <code>path</code> is a in parameter, and all the others are out. We assume that <code>pfile</code> is never <code>NULL</code>, meaning that it is a required parameter. (<del>If not, why you use this function?</del> Though you may just want to get <code>pdir</code>) and <code>pdir</code> and <code>lastelem</code> is optional. </p>
<blockquote>
<p>ℹ<strong>Notice:</strong> In my implementation, I altered this function to make <code>pfile</code> nullable too.</p>
</blockquote>
<p>If we successfully find the file (can be directory or regular file), <code>pdir</code> will be set to its parent directory, and <code>pfile</code> the file we find. In this case, <code>lastelem</code> is not used.</p>
<p>Otherwise, <code>pdir</code> and <code>pfile</code> are set to <code>NULL</code> and <code>walk_path</code> will return a error, and set <code>lastelem</code> to the last successful found file name. <strong>Not</strong> the full path of the last file. (I doubt if this is of any use.)</p>
</blockquote>
<p>This function is long but not complicate. It is a good example of traverse file structure. 🥱</p>
<details class="toggle"><summary class="toggle-button" style>walk_path</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">walk_path</span><span class="params">(<span class="type">char</span>* path, <span class="keyword">struct</span> File** pdir, <span class="keyword">struct</span> File** pfile, <span class="type">char</span>* lastelem)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> name[MAXNAMELEN];</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start at the root.</span></span><br><span class="line">    path = skip_slash(path);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">File</span>* <span class="title">file</span> =</span> &amp;super-&gt;s_root;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">File</span>* <span class="title">dir</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span>* p;</span><br><span class="line"></span><br><span class="line">    name[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pdir)</span><br><span class="line">        *pdir = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (pfile)</span><br><span class="line">        *pfile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the target file by name recursively.</span></span><br><span class="line">    <span class="keyword">while</span> (*path != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        dir = file;</span><br><span class="line">        p = path;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (*path != <span class="string">&#x27;/&#x27;</span> &amp;&amp; *path != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">            path++;</span><br><span class="line">        <span class="keyword">if</span> (path - p &gt;= MAXNAMELEN)</span><br><span class="line">            <span class="keyword">return</span> -E_BAD_PATH;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(name, p, path - p);</span><br><span class="line">        name[path - p] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        path = skip_slash(path);</span><br><span class="line">        <span class="keyword">if</span> (dir-&gt;f_type != FTYPE_DIR)</span><br><span class="line">            <span class="keyword">return</span> -E_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((r = dir_lookup(dir, name, &amp;file)) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == -E_NOT_FOUND &amp;&amp; *path == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pdir)</span><br><span class="line">                    *pdir = dir;</span><br><span class="line">                <span class="keyword">if</span> (lastelem)</span><br><span class="line">                    <span class="built_in">strcpy</span>(lastelem, name);</span><br><span class="line">                *pfile = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pdir)</span><br><span class="line">        *pdir = dir;</span><br><span class="line">    <span class="keyword">if</span> (pfile)</span><br><span class="line">        *pfile = file;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dir_lookup</span><span class="params">(<span class="keyword">struct</span> File* dir, <span class="type">char</span>* name, <span class="keyword">struct</span> File** file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: Calculate the number of blocks in &#x27;dir&#x27; via its size.</span></span><br><span class="line">    u_int nblk = dir-&gt;f_size / BY2BLK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Iterate through all blocks in the directory.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nblk; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Read the i&#x27;th block of &#x27;dir&#x27; and get its address to &#x27;blk&#x27;.</span></span><br><span class="line">        <span class="type">void</span>* blk;</span><br><span class="line">        <span class="keyword">if</span> ((r = file_get_block(dir, i, &amp;blk)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">File</span>* <span class="title">files</span> =</span> (<span class="keyword">struct</span> File*)blk;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the target among all &#x27;File&#x27;s in this block.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">struct</span> File* f = files; f &lt; files + FILE2BLK; ++f)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(f-&gt;f_name, name) == <span class="number">0</span>)	<span class="comment">// Karabast! &#x27;== 0&#x27;!</span></span><br><span class="line">            &#123;</span><br><span class="line">                f-&gt;f_dir = dir;	<span class="comment">// set this every time it is accessed?</span></span><br><span class="line">                *file = f;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -E_NOT_FOUND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>file_get_block</code> is just like a simplified <code>file_block_walk</code>, to get the block content of the corresponding file block id. Just refer to <a href="../Lab-5-Reflection/">Lab 5 Reflection</a> for more information. 🥴 Just be reminded that it will map block into memory if not loaded from disk yet.</p>
</blockquote>
</div></details>

<h3 id="2-3-2-serve-close"><a href="#2-3-2-serve-close" class="headerlink" title="2.3.2 serve_close"></a>2.3.2 <code>serve_close</code></h3><p>You may see this function in <code>serve_close</code>. Again, don’t be fooled by its name, it doesn’t really close the file, it only save the file to disk using <code>file_flush</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/fs.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">file_close</span><span class="params">(<span class="keyword">struct</span> File* f)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">file_flush</span><span class="params">(<span class="keyword">struct</span> File* f)</span>;</span><br></pre></td></tr></table></figure>

<details class="toggle"><summary class="toggle-button" style>file_close/flush</summary><div class="toggle-content"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/fs.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">file_close</span><span class="params">(<span class="keyword">struct</span> File* f)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Flush the file itself, if f&#x27;s f_dir is set, flush it&#x27;s f_dir.</span></span><br><span class="line">    file_flush(f);</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;f_dir)</span><br><span class="line">        file_flush(f-&gt;f_dir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">file_flush</span><span class="params">(<span class="keyword">struct</span> File* f)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    u_int bno;</span><br><span class="line">    u_int diskno;</span><br><span class="line"></span><br><span class="line">    u_int nblocks = f-&gt;f_size / BY2BLK + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (bno = <span class="number">0</span>; bno &lt; nblocks; bno++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((r = file_map_block(f, bno, &amp;diskno, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (block_is_dirty(diskno))</span><br><span class="line">            write_block(diskno);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Why we should flush parent directory? Well, you know, content of directory is its children’s <code>struct File</code>, so perhaps due to file size change or some else reason, this <code>struct File</code> may change. Therefore, update directory, we should.</p>
</blockquote>
</div></details>

<hr>
<h1 id="4-Library-File-Function"><a href="#4-Library-File-Function" class="headerlink" title="4. Library File Function"></a>4. Library File Function</h1><p>In the previous post <a href="../Lab-5-Reflection/">Lab 5 Reflection</a>, we’ve learnt some library functions, which doesn’t rely on File System IPC. And here, I’d like to introduce these two that depend on such IPC. 😯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include/lib.h</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">int</span> mode)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="4-1-open"><a href="#4-1-open" class="headerlink" title="4.1 open"></a>4.1 <code>open</code></h2><p>First, let’s see the definition of this function.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/file.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">int</span> mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: Alloc a new &#x27;Fd&#x27; using &#x27;fd_alloc&#x27; in fd.c.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Fd</span>* <span class="title">fd</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((r = fd_alloc(&amp;fd)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Prepare the &#x27;fd&#x27; using &#x27;fsipc_open&#x27; in fsipc.c.</span></span><br><span class="line">    <span class="keyword">if</span> ((r = fsipc_open(path, mode, fd)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: Set &#x27;va&#x27; to the address of the page where the &#x27;fd&#x27;&#x27;s data is cached.</span></span><br><span class="line">    <span class="type">char</span>* va = fd2data(fd);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Filefd</span>* <span class="title">ffd</span> =</span> (<span class="keyword">struct</span> Filefd*)fd;</span><br><span class="line">    u_int fileid = ffd-&gt;f_fileid;</span><br><span class="line">    u_int size = ffd-&gt;f_file.f_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 4: Alloc pages and map the file content using &#x27;fsipc_map&#x27;.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i += BY2PG)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((r = fsipc_map(fileid, i, va + i)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 5: Return the number of file descriptor using &#x27;fd2num&#x27;.</span></span><br><span class="line">    <span class="keyword">return</span> fd2num(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>So, you can have a complete view of open process now. We first find a suitable page to store the incoming file descriptor (only find, no allocation of memory). Then, we just call <code>fsipc_open</code>, which will end in <code>serve_open</code> to prepare such file descriptor page for us. Then, we can initialize some properties using this page.</p>
<p>Then, to get the content of the file, we just use <code>fsipc_map</code> that will call <code>serve_map</code> to load data from the disk, as you’ve known previously.</p>
<p>Finally, we return <code>fd2num(fd)</code> to the caller. So, <code>fileid</code> and the actual id user got are different.</p>
</blockquote>
<h2 id="4-2-close"><a href="#4-2-close" class="headerlink" title="4.2 close"></a>4.2 <code>close</code></h2><p>While <code>open</code> is only for file device, here <code>close</code> can be used to any device. As you can infer from the source file it located. As you can see, a function pointer does the dynamic job.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/fd.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fdnum)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Dev</span>* <span class="title">dev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Fd</span>* <span class="title">fd</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((r = fd_lookup(fdnum, &amp;fd)) &lt; <span class="number">0</span> || (r = dev_lookup(fd-&gt;fd_dev_id, &amp;dev)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = (*dev-&gt;dev_close)(fd);</span><br><span class="line">    fd_close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, for file device, this <code>Dev::dev_close</code> is <code>file_close</code>. A little long, so sorry about not make it inside a hide block.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/file.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">file_close</span><span class="params">(<span class="keyword">struct</span> Fd* fd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Filefd</span>* <span class="title">ffd</span> =</span> (<span class="keyword">struct</span> Filefd*)fd;</span><br><span class="line">	u_int fileid = ffd-&gt;f_fileid;</span><br><span class="line">	u_int size = ffd-&gt;f_file.f_size;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the start address storing the file&#x27;s content.</span></span><br><span class="line">	<span class="type">void</span>* va = fd2data(fd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tell the file server the dirty page.</span></span><br><span class="line">	<span class="keyword">for</span> (u_int i = <span class="number">0</span>; i &lt; size; i += BY2PG)</span><br><span class="line">		fsipc_dirty(fileid, i);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Request the file server to close the file with fsipc.</span></span><br><span class="line">	<span class="keyword">if</span> ((r = fsipc_close(fileid)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		debugf(<span class="string">&quot;cannot close the file\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Unmap the content of file, release memory.</span></span><br><span class="line">	<span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (u_int i = <span class="number">0</span>; i &lt; size; i += BY2PG)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((r = syscall_mem_unmap(<span class="number">0</span>, (<span class="type">void</span>*)(va + i))) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			debugf(<span class="string">&quot;cannont unmap the file.\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> r;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can see that in this function, we call <code>fsipc_close</code> that will eventually invoke <code>serve_close</code> to flush the file to the disk as a save job. Then, we just un-map the page for memory release.</p>
<p>Then, we have <code>fd_close</code>, as we known, it simply un-map the file descriptor page.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/fd.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fd_close</span><span class="params">(<span class="keyword">struct</span> Fd* fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    syscall_mem_unmap(<span class="number">0</span>, fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>❗ <strong>Important:</strong> So now, it’s time to review <code>serve_open</code> again! There, we check <code>pageref</code>, and sharing the file descriptor make its page reference be 2 or more. And here, as we close the file, user process will un-map this page one by one (if there are more than one process using this file), thus the reference will decrease until 1, which is the File System’s reference. And once it becomes 1, it means that all user processes have lost connect with this page, indicating the file is ultimately closed.</p>
</blockquote>
<hr>
<h1 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h1><p>Oops, I guess there are nothing to say anymore. I wonder if this is of any point. 😔 But, enjoy.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://tonys-studio.top">Tony Skywalker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tonys-studio.top/posts/File-System-IPC/">https://blog.tonys-studio.top/posts/File-System-IPC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OS/">OS</a><a class="post-meta__tags" href="/tags/BUAA/">BUAA</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Deploy-Hexo-on-Remote-Server/" title="Deploy Hexo on Remote Server"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/01/08.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Deploy Hexo on Remote Server</div></div><div class="info-2"><div class="info-item-1">Deploy Hexo on GitHub and Windows server</div></div></div></a><a class="pagination-related" href="/posts/Lab-5-Reflection/" title="Lab 5 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/10.jpeg" onerror="onerror=null;src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Lab 5 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 5 - File System</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Lab-2-Extra-Reflection/" title="Lab 2 Extra Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/13/03.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 6th, 2023 - 19:53:06</div><div class="info-item-2">Lab 2 Extra Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 2 Extra</div></div></div></a><a class="pagination-related" href="/posts/Lab-5-Reflection/" title="Lab 5 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/01/10.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> May. 6th, 2023 - 11:47:42</div><div class="info-item-2">Lab 5 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 5 - File System</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Challenge/" title="Lab 6 Challenge"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/01/09.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:24</div><div class="info-item-2">Lab 6 Challenge</div></div><div class="info-2"><div class="info-item-1">Lab 6 Challenge - A More Powerful Shell</div></div></div></a><a class="pagination-related" href="/posts/Lab-4-Reflection/" title="Lab 4 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/ahsoka/01.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Apr. 20th, 2023 - 17:07:01</div><div class="info-item-2">Lab 4 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 4</div></div></div></a><a class="pagination-related" href="/posts/Lab-6-Reflection/" title="Lab 6 Reflection"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/00.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Jun. 18th, 2023 - 23:28:19</div><div class="info-item-2">Lab 6 Reflection</div></div><div class="info-2"><div class="info-item-1">Reflection on 2023 BUAA OS Lab 6 - Pipe & Shell</div></div></div></a><a class="pagination-related" href="/posts/Page-Directory-Self-Mapping/" title="Page Directory Self Mapping"><img class="cover" src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/06/06.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> Mar. 25th, 2023 - 20:56:35</div><div class="info-item-2">Page Directory Self Mapping</div></div><div class="info-2"><div class="info-item-1">Understanding page directory self mapping</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/avatar/avatar.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/missing.gif'" alt="avatar"/></div><div class="author-info-name">Tony Skywalker</div><div class="author-info-description">Do or do not. There is no try.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lord-Turmoil"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lord-Turmoil" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:swift-phantom@outlook.com" target="_blank" title="Email"><i class="fa-solid fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/2030942344" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It won't be long before the armies of the Republic track us here.<br>You can visit this site at both:<li><a href="http://blog.tonys-studio.top/" target="_blank">Main Site</a></li><li><a href="https://lord-turmoil.github.io/" target="_blank">Github Mirror Site</a></li></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BUAA-2023-Spring-OS"><span class="toc-text">BUAA 2023 Spring OS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Workflow"><span class="toc-text">1. Workflow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Main-Loop"><span class="toc-text">1.1 Main Loop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Initialization"><span class="toc-text">1.2 Initialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-serve-init"><span class="toc-text">1.2.1 serve_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-fs-init"><span class="toc-text">1.2.2 fs_init</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Serve"><span class="toc-text">1.3 Serve</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-File-System-IPC"><span class="toc-text">2. File System IPC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-IPC-Library-Function"><span class="toc-text">2.1 IPC Library Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-File-System-IPC-Interface"><span class="toc-text">2.2 File System IPC Interface</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-File-System-Handler"><span class="toc-text">3. File System Handler</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Handler-Function"><span class="toc-text">3.1 Handler Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Auxiliary-Function"><span class="toc-text">3.2 Auxiliary Function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-serve-open"><span class="toc-text">2.3.1 serve_open</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-serve-close"><span class="toc-text">2.3.2 serve_close</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Library-File-Function"><span class="toc-text">4. Library File Function</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-open"><span class="toc-text">4.1 open</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-close"><span class="toc-text">4.2 close</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Epilogue"><span class="toc-text">Epilogue</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Thoughts-on-Black-Hand-Strategy/" title="Thoughts on Black Hand Strategy"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/top/special/bh_top.jpg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Thoughts on Black Hand Strategy"/></a><div class="content"><a class="title" href="/posts/Thoughts-on-Black-Hand-Strategy/" title="Thoughts on Black Hand Strategy">Thoughts on Black Hand Strategy</a><time datetime="2025-02-28T12:37:42.000Z" title="Created Feb. 28th, 2025 - 20:37:42 20:37:42">Feb. 28th, 2025 - 20:37:42</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Setup-Modern-TypeScript-Project/" title="Setup Modern TypeScript Project"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/boba/05/04.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Setup Modern TypeScript Project"/></a><div class="content"><a class="title" href="/posts/Setup-Modern-TypeScript-Project/" title="Setup Modern TypeScript Project">Setup Modern TypeScript Project</a><time datetime="2025-01-10T07:18:43.000Z" title="Created Jan. 10th, 2025 - 15:18:43 15:18:43">Jan. 10th, 2025 - 15:18:43</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Scam-From-Your-Own-Email-Address/" title="Scam From Your Own Email Address"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/top/special/scam.png" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Scam From Your Own Email Address"/></a><div class="content"><a class="title" href="/posts/Scam-From-Your-Own-Email-Address/" title="Scam From Your Own Email Address">Scam From Your Own Email Address</a><time datetime="2025-01-08T15:29:32.000Z" title="Created Jan. 8th, 2025 - 23:29:32 23:29:32">Jan. 8th, 2025 - 23:29:32</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Understanding-TypeScript-Philosophy/" title="Understanding TypeScript Philosophy"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/07/02.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Understanding TypeScript Philosophy"/></a><div class="content"><a class="title" href="/posts/Understanding-TypeScript-Philosophy/" title="Understanding TypeScript Philosophy">Understanding TypeScript Philosophy</a><time datetime="2025-01-04T05:58:47.000Z" title="Created Jan. 4th, 2025 - 13:58:47 13:58:47">Jan. 4th, 2025 - 13:58:47</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Modern-C-Project-with-CMake/" title="Modern C++ Project With CMake"><img src="https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/06/00.jpeg" onerror="this.onerror=null;this.src='https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/404.png'" alt="Modern C++ Project With CMake"/></a><div class="content"><a class="title" href="/posts/Modern-C-Project-with-CMake/" title="Modern C++ Project With CMake">Modern C++ Project With CMake</a><time datetime="2024-12-24T08:12:08.000Z" title="Created Dec. 24th, 2024 - 16:12:08 16:12:08">Dec. 24th, 2024 - 16:12:08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://tonys-studio-1308383348.cos.ap-beijing.myqcloud.com/blog/img/banner/mando/23/08.jpeg);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By Tony Skywalker</div><div class="footer_custom_text">No bird soars too high if he soars on his own wings</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://comment.tonys-studio.top',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      comment: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client@2/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/custom.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Anything you would like to search?🔍" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="Framework Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="Theme Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly%205.3.3-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="All articles in this blog are licensed under CC BY-NC-SA 4.0 unless stating additionally." title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>